<!DOCTYPE html>
<html>

  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Nmap扩展开发（四） « 倾旋的博客</title>
  <meta name="description" content="0x01 HTTP包的使用一般情况下，我们扫描一些Web服务的同时需要进行渗透测试、安全评估、漏洞检测等操作，但是官方并未提供符合我们需求的脚本，这时候就要自己写脚本了。Nmap已经内置了HTTP包，不需要再进行下载和配置。0x02 基础概念铺垫首先，先介绍两个表结构，为了方便我们后续的数据操作，让读者先熟悉两个...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://payloads.online/archivers/2019-04-24/4">
  <link rel="alternate" type="application/rss+xml" title="倾旋的博客" href="https://payloads.online/feed.xml">
<script>MathJax={"tex":{"inlineMath":[["$","$"],["\\(","\\)"]],"displayMath":[["$$","$$"],["\\[","\\]"]]},"svg":{"fontCache":"global"},"svg":{"fontCache":"global"}}</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">倾旋的博客</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/">About</a>
      
        
        <a class="page-link" href="/posts/">Posts</a>
      
        
        <a class="page-link" href="/links/">Links</a>
      
        
        <a class="page-link" href="https://cooolis.payloads.online/">Cooolis</a>
      
        
        <a class="page-link" href="/feed.xml">RSS</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">Nmap扩展开发（四）</h1>
    <p class="post-meta">Apr 24, 2019</p>
  </header>

  <article class="post-content">
    <h2 id="0x01-http包的使用">0x01 HTTP包的使用</h2>

<p>一般情况下，我们扫描一些Web服务的同时需要进行渗透测试、安全评估、漏洞检测等操作，但是官方并未提供符合我们需求的脚本，这时候就要自己写脚本了。Nmap已经内置了HTTP包，不需要再进行下载和配置。</p>

<h2 id="0x02-基础概念铺垫">0x02 基础概念铺垫</h2>

<p>首先，先介绍两个表结构，为了方便我们后续的数据操作，让读者先熟悉两个东西：</p>

<ul>
  <li>响应表</li>
</ul>

<p>响应表中主要涵盖了：HTTP状态码、HTTP响应头、HTTP版本、HTTP原始响应头、Cookies、HTTP响应主体内容（body）等</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|   Response: 
|     status: 200
|     header: 
|       content-length: 0
|       allow: POST,OPTIONS,HEAD,GET
|       connection: close
|       content-type: text/html
|       server: Apache/2.4.29 (Debian)
|       date: Fri, 06 Jul 2018 07\:02\:13 GMT
|     ssl: false
|     body: 
|     cookies: 
| 
|     status-line: HTTP/1.1 200 OK\x0D
| 
|     rawheader: 
|       Date: Fri, 06 Jul 2018 07\:02\:13 GMT
|       Server: Apache/2.4.29 (Debian)
|       Allow: POST,OPTIONS,HEAD,GET
|       Content-Length: 0
|       Connection: close
|       Content-Type: text/html
|       
|_    version: 1.1
</code></pre></div></div>

<ul>
  <li>Options表</li>
</ul>

<p>Options表主要用于设置HTTP请求时的超时时间、Cookie、请求头、HTTP认证、页面缓存、地址类型（IPV4/IPV6）、是否验证重定向</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
timeout:
header:{"Content-Type":"",...},
cookies:{\{"name","value","path"\},...},
auth:{username:"",password:""},
bypass_cache:true,
no_cache:true,
no_cache_body:true,
any_af:true,
redirect_ok:true
}
</code></pre></div></div>

<h2 id="0x03-确认目标主机的http服务是否支持head">0x03 确认目标主机的HTTP服务是否支持HEAD</h2>

<ul>
  <li>引入HTTP包：</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">local http = require "http"</code></p>

<ul>
  <li>确认目标主机的HTTP服务是否支持HEAD</li>
</ul>

<p>这里主要使用can_use_head函数，参数有4个，函数原型如下：</p>

<p><code class="language-plaintext highlighter-rouge">local status,header = can_use_head(host,port,result_404,path)</code></p>

<p>参数说明：</p>

<ul>
  <li>host : host表</li>
  <li>port : port表</li>
  <li>result_404 : 由identify_404函数确认当前Web服务器是否设置了404页面且返回200状态码，一般情况下填写404或者nil。</li>
  <li>path : 请求路径，默认为“/”根目录</li>
  <li>其中status是一个布尔值，如果返回true则支持HEAD，返回false则不支持</li>
  <li>header是HEAD请求的结果。</li>
</ul>

<blockquote>
  <p>需求：确认目标主机是否支持HEAD，如果支持则输出响应头</p>
</blockquote>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">stdnse</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">"stdnse"</span>
<span class="kd">local</span> <span class="n">http</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">"http"</span>
<span class="n">prerule</span><span class="o">=</span><span class="k">function</span><span class="p">()</span>
<span class="k">end</span>
<span class="n">hostrule</span><span class="o">=</span><span class="k">function</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>
	<span class="k">return</span> <span class="kc">false</span>
<span class="k">end</span>
<span class="n">portrule</span><span class="o">=</span><span class="k">function</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">)</span>
	<span class="k">if</span><span class="p">(</span><span class="n">port</span><span class="p">.</span><span class="n">number</span> <span class="o">==</span> <span class="mi">80</span><span class="p">)</span> <span class="k">then</span>
		<span class="k">return</span> <span class="kc">true</span>
	<span class="k">end</span>
	<span class="k">return</span> <span class="kc">false</span>
<span class="k">end</span>
<span class="n">action</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">)</span>
	<span class="kd">local</span> <span class="n">result</span>
	<span class="kd">local</span> <span class="n">status</span> <span class="o">=</span> <span class="kc">false</span>
	<span class="n">status</span><span class="p">,</span><span class="n">result</span> <span class="o">=</span> <span class="n">http</span><span class="p">.</span><span class="n">can_use_head</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">,</span><span class="mi">404</span><span class="p">,</span><span class="s2">"/"</span><span class="p">)</span>
	<span class="k">if</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="k">then</span>
		<span class="n">http_info</span> <span class="o">=</span> <span class="n">stdnse</span><span class="p">.</span><span class="n">output_table</span><span class="p">()</span>
		<span class="n">http_info</span><span class="p">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">result</span><span class="p">.</span><span class="n">header</span>
		<span class="n">http_info</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">result</span><span class="p">.</span><span class="n">version</span>
		<span class="k">return</span> <span class="n">http_info</span>
	<span class="k">end</span>
<span class="k">end</span>
<span class="n">postrule</span><span class="o">=</span><span class="k">function</span><span class="p">()</span>
<span class="k">end</span>

</code></pre></div></div>

<p>代码解读：</p>

<p>看完代码读者可能会有疑问，hostrule函数为什么返回false？</p>

<p>在hostrule中返回false是因为如果是true会自动调用action，此时port的值是nil，所以会抛出一些错误。</p>

<p>紧接着就是将端口号为80的host和port交给action函数执行，调用can_use_head函数，判断status是否为true，是true则支持HEAD方法请求。最后生成一个output_table，用来将响应内容填入这个表，以便于格式化显示。</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/de8fd8b0ed9c828efff3ed684cdb28ba.png" alt="2019-04-24-10-11-39"></p>

<p>如果只想取得目标主机响应的server，我们可以这样写：</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">……</span>
<span class="n">action</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">)</span>
	<span class="kd">local</span> <span class="n">result</span>
	<span class="kd">local</span> <span class="n">status</span> <span class="o">=</span> <span class="kc">false</span>
	<span class="n">status</span><span class="p">,</span><span class="n">result</span> <span class="o">=</span> <span class="n">http</span><span class="p">.</span><span class="n">can_use_head</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">,</span><span class="mi">302</span><span class="p">,</span><span class="s2">"/"</span><span class="p">)</span>
	<span class="k">if</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="k">then</span>
		<span class="n">http_info</span> <span class="o">=</span> <span class="n">stdnse</span><span class="p">.</span><span class="n">output_table</span><span class="p">()</span>
		<span class="n">http_info</span><span class="p">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">result</span><span class="p">.</span><span class="n">header</span>
		<span class="n">http_info</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">result</span><span class="p">.</span><span class="n">version</span>
		<span class="n">http_info</span><span class="p">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">result</span><span class="p">.</span><span class="n">header</span><span class="p">[</span><span class="s2">"server"</span><span class="p">]</span>
		<span class="k">return</span> <span class="n">http_info</span>
	<span class="k">end</span>
<span class="k">end</span>
<span class="err">……</span>
</code></pre></div></div>

<p>执行结果如下：</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/bce4abf686d6d35f18c31cd1017bf1d5.png" alt="2019-04-24-10-12-06"></p>

<h2 id="0x04-发送一个http请求">0x04 发送一个HTTP请求</h2>

<p><a href="https://nmap.org/nsedoc/lib/http.html#generic_request">generic_request</a>是一个最基本的发送HTTP请求的函数，参数有以下几个：</p>

<ul>
  <li>host : host表</li>
  <li>port : port 表</li>
  <li>method : HTTP方法，例如：GET、POST、HEAD…</li>
  <li>path : 请求路径，默认是根路径“/”</li>
  <li>options : 用于设置请求相关的Cookie、超时时间、header</li>
</ul>

<p>例如：</p>

<blockquote>
  <p>发送一个OPTIONS请求，来获取目标服务支持哪些HTTP方法</p>
</blockquote>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">stdnse</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">"stdnse"</span>
<span class="kd">local</span> <span class="n">http</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">"http"</span>
<span class="n">prerule</span><span class="o">=</span><span class="k">function</span><span class="p">()</span>
<span class="k">end</span>
<span class="n">hostrule</span><span class="o">=</span><span class="k">function</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>
	<span class="k">return</span> <span class="kc">false</span>
<span class="k">end</span>
<span class="n">portrule</span><span class="o">=</span><span class="k">function</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">)</span>
	<span class="k">if</span><span class="p">(</span><span class="n">port</span><span class="p">.</span><span class="n">number</span> <span class="o">==</span> <span class="mi">80</span><span class="p">)</span> <span class="k">then</span>
		<span class="k">return</span> <span class="kc">true</span>
	<span class="k">end</span>
	<span class="k">return</span> <span class="kc">false</span>
<span class="k">end</span>
<span class="n">action</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">)</span>
	<span class="kd">local</span> <span class="n">result</span> <span class="o">=</span> <span class="n">http</span><span class="p">.</span><span class="n">generic_request</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">,</span><span class="s2">"OPTIONS"</span><span class="p">,</span><span class="s2">"/"</span><span class="p">,</span><span class="kc">nil</span><span class="p">)</span>
	<span class="k">if</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span><span class="k">then</span>
		<span class="kd">local</span> <span class="n">allow_method</span> <span class="o">=</span> <span class="n">stdnse</span><span class="p">.</span><span class="n">output_table</span><span class="p">()</span>
		<span class="n">allow_method</span><span class="p">.</span><span class="n">allowMethods</span> <span class="o">=</span> <span class="n">result</span><span class="p">.</span><span class="n">header</span><span class="p">[</span><span class="s2">"allow"</span><span class="p">]</span>
		<span class="k">return</span> <span class="n">allow_method</span>
	<span class="k">end</span>
<span class="k">end</span>
<span class="n">postrule</span><span class="o">=</span><span class="k">function</span><span class="p">()</span>
<span class="k">end</span>
</code></pre></div></div>

<p>执行结果如下：</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/be298d3257f4a84ec63b7ebcb90b13e7.png" alt="2019-04-24-10-13-46"></p>

<ul>
  <li>返回值：</li>
</ul>

<p>该函数返回一个响应表，具体可参考前面的0X02响应表</p>

<h2 id="0x04-发送一个get请求">0x04 发送一个GET请求</h2>

<p>get函数也是基于generic_request函数的，具体可以去看nselib/http.lua源代码，该函数有以下参数：</p>

<ul>
  <li>host : host表</li>
  <li>port : port 表</li>
  <li>path : 请求路径，默认是根路径“/”</li>
  <li>options : 用于设置请求相关的Cookie、超时时间、header</li>
</ul>

<p>除了比generic_request函数中少了一个method参数，其他相同。</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">stdnse</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">"stdnse"</span>
<span class="kd">local</span> <span class="n">http</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">"http"</span>
<span class="n">prerule</span><span class="o">=</span><span class="k">function</span><span class="p">()</span>
<span class="k">end</span>
<span class="n">hostrule</span><span class="o">=</span><span class="k">function</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>
	<span class="k">return</span> <span class="kc">false</span>
<span class="k">end</span>
<span class="n">portrule</span><span class="o">=</span><span class="k">function</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">)</span>
	<span class="k">if</span><span class="p">(</span><span class="n">port</span><span class="p">.</span><span class="n">number</span> <span class="o">==</span> <span class="mi">80</span><span class="p">)</span> <span class="k">then</span>
		<span class="k">return</span> <span class="kc">true</span>
	<span class="k">end</span>
	<span class="k">return</span> <span class="kc">false</span>
<span class="k">end</span>
<span class="n">action</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">)</span>
	<span class="kd">local</span> <span class="n">result</span> <span class="o">=</span> <span class="n">http</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">,</span><span class="s2">"/nmap"</span><span class="p">)</span>
	<span class="k">if</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">404</span><span class="p">)</span><span class="k">then</span>
		<span class="kd">local</span> <span class="n">status</span> <span class="o">=</span> <span class="n">stdnse</span><span class="p">.</span><span class="n">output_table</span><span class="p">()</span>
		<span class="n">status</span><span class="p">.</span><span class="n">response_line</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">"status-line"</span><span class="p">]</span>
		<span class="k">return</span> <span class="n">status</span>
	<span class="k">end</span>
<span class="k">end</span>
<span class="n">postrule</span><span class="o">=</span><span class="k">function</span><span class="p">()</span>
<span class="k">end</span>
</code></pre></div></div>

<p>执行结果：</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/4dbee631d39bc19b95393f02563cee28.png" alt="2019-04-24-10-14-43"></p>

<ul>
  <li>返回值：</li>
</ul>

<p>该函数返回一个响应表，具体可参考前面的0X02响应表</p>

<h2 id="0x05-发送一个post请求">0x05 发送一个POST请求</h2>

<p>post函数也是基于generic_request函数的，具体可以去看nselib/http.lua源代码，该函数有以下参数：</p>

<ul>
  <li>host : host表</li>
  <li>port : port 表</li>
  <li>path : 请求路径，默认是根路径“/”</li>
  <li>options : 用于设置请求相关的Cookie、超时时间、header</li>
  <li>ignored : 是否忽略向后兼容性</li>
  <li>postdata : post提交数据，可以是一个表，也可以是一个字符串，具体形式如下：</li>
</ul>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">username</span><span class="o">=</span><span class="n">admin</span><span class="err">&amp;</span><span class="n">password</span><span class="o">=</span><span class="n">admin</span>
<span class="c1">-- 或者：</span>
<span class="kd">local</span> <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">data</span><span class="p">.</span><span class="n">username</span> <span class="o">=</span> <span class="s2">"admin"</span>
<span class="n">data</span><span class="p">.</span><span class="n">password</span> <span class="o">=</span> <span class="s2">"admin"</span>
</code></pre></div></div>

<blockquote>
  <p>尝试使用账号密码登录某个系统</p>
</blockquote>

<p>用php脚本语言写一个简单登录判断的页面：</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="k">if</span><span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s2">"username"</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="k">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s2">"password"</span><span class="p">]))</span>
<span class="p">{</span>
	<span class="nv">$username</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s2">"username"</span><span class="p">];</span>
	<span class="nv">$password</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s2">"password"</span><span class="p">];</span>
	<span class="k">if</span><span class="p">(</span><span class="nv">$username</span> <span class="o">==</span> <span class="s2">"admin"</span> <span class="o">&amp;&amp;</span> <span class="nv">$password</span> <span class="o">==</span> <span class="s2">"admin"</span><span class="p">){</span>
		<span class="k">echo</span> <span class="s2">"login success !"</span><span class="p">;</span>
	<span class="p">}</span><span class="k">else</span><span class="p">{</span>
		<span class="k">echo</span> <span class="s2">"login failed !"</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span><span class="k">else</span><span class="p">{</span>
	<span class="k">echo</span> <span class="s2">"please login !"</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>

<p>通过post函数提交username与password，然后获取body判断是否登录成功</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">……</span>
<span class="n">action</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">)</span>
	<span class="kd">local</span> <span class="n">cert</span> <span class="o">=</span> <span class="p">{}</span>
	<span class="n">cert</span><span class="p">.</span><span class="n">username</span><span class="o">=</span><span class="s2">"admin"</span>
	<span class="n">cert</span><span class="p">.</span><span class="n">password</span><span class="o">=</span><span class="s2">"admin"</span>
	<span class="kd">local</span> <span class="n">result</span> <span class="o">=</span> <span class="n">http</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">,</span><span class="s2">"/index.php"</span><span class="p">,</span><span class="kc">nil</span><span class="p">,</span><span class="kc">true</span><span class="p">,</span><span class="n">cert</span><span class="p">)</span>
	<span class="k">if</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span><span class="k">then</span>
		<span class="kd">local</span> <span class="n">status</span> <span class="o">=</span> <span class="n">stdnse</span><span class="p">.</span><span class="n">output_table</span><span class="p">()</span>
		<span class="n">status</span><span class="p">.</span><span class="n">response_line</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">"body"</span><span class="p">]</span>
		<span class="k">return</span> <span class="n">status</span>
	<span class="k">end</span>
<span class="k">end</span>
<span class="err">……</span>
</code></pre></div></div>

<p>执行结果：</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/e88b5f5bc8a7b88b60d7be2d93ffbc67.png" alt="2019-04-24-10-16-22"></p>

<ul>
  <li>返回值：</li>
</ul>

<p>该函数返回一个响应表，具体可参考前面的0X02响应表</p>

<h2 id="0x06-编写一个检测cve-2017-12615的脚本">0X06 编写一个检测CVE-2017-12615的脚本</h2>

<p>为了检验读者对之前的内容是否有所收获，所以产生一个需求，编写一个针对CVE-2017-12615的漏洞检测脚本。首先我们需要了解这个漏洞：</p>

<blockquote>
  <p>编写CVE-2017-12615的漏洞检测脚本</p>
</blockquote>

<p>攻击者可以利用这个漏洞，向目标服务器上传恶意 JSP 文件，通过上传的 JSP 文件 ，可在用户服务器上执行任意代码，从而导致数据泄露或获取服务器权限，存在高安全风险。</p>

<p>漏洞的利用方式是通过PUT请求，这让我们不得不学习一个新的函数——put函数，它的参数类似于post函数。</p>

<ul>
  <li>host : host表</li>
  <li>port : port 表</li>
  <li>path : 请求路径，默认是根路径“/”</li>
  <li>options : 用于设置请求相关的Cookie、超时时间、header</li>
  <li>putdata : 要上传的文件的内容</li>
</ul>

<p>这里我使用Docker已经搭建好了一个Tomcat环境：</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/4d893f65eb7a570b0f8c089d5752ae92.png" alt="2019-04-24-10-17-24"></p>

<p>编写的脚本如下：</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">stdnse</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">"stdnse"</span>
<span class="kd">local</span> <span class="n">http</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">"http"</span>
<span class="n">prerule</span><span class="o">=</span><span class="k">function</span><span class="p">()</span>
<span class="k">end</span>
<span class="n">hostrule</span><span class="o">=</span><span class="k">function</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>
	<span class="k">return</span> <span class="kc">false</span>
<span class="k">end</span>

<span class="n">portrule</span><span class="o">=</span><span class="k">function</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">)</span>
	<span class="kd">local</span> <span class="n">ports</span> <span class="o">=</span> <span class="p">{</span><span class="mi">80</span><span class="p">,</span><span class="mi">8080</span><span class="p">,</span><span class="mi">8090</span><span class="p">,</span><span class="mi">8899</span><span class="p">}</span>
	<span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="nb">pairs</span><span class="p">(</span><span class="n">ports</span><span class="p">)</span><span class="k">do</span>
		<span class="k">if</span><span class="p">(</span><span class="n">port</span><span class="p">.</span><span class="n">number</span> <span class="o">==</span> <span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="k">then</span>
			<span class="k">return</span> <span class="kc">true</span>
		<span class="k">end</span>
	<span class="k">end</span>
<span class="k">end</span>


<span class="n">action</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">)</span>
	<span class="kd">local</span> <span class="n">shell_name</span> <span class="o">=</span> <span class="nb">string.format</span><span class="p">(</span><span class="s2">"/%d.jsp"</span><span class="p">,</span><span class="s2">"/"</span><span class="p">,</span><span class="nb">math.random</span><span class="p">(</span><span class="mi">9999</span><span class="p">))</span>
	<span class="kd">local</span> <span class="n">status</span> <span class="o">=</span> <span class="n">stdnse</span><span class="p">.</span><span class="n">output_table</span><span class="p">()</span>
	<span class="kd">local</span> <span class="n">put_rsp</span> <span class="o">=</span> <span class="n">http</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">,</span><span class="n">shell_name</span><span class="o">..</span><span class="s2">"/"</span><span class="p">,</span><span class="kc">nil</span><span class="p">,</span><span class="s2">"CVE-2017-12615"</span><span class="p">)</span>
	<span class="k">if</span><span class="p">(</span><span class="n">put_rsp</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">201</span><span class="p">)</span><span class="k">then</span>
		<span class="n">status</span><span class="p">.</span><span class="n">shell_name</span> <span class="o">=</span> <span class="n">shell_name</span>
		<span class="k">return</span> <span class="n">status</span>
	<span class="k">end</span>
	<span class="k">return</span> <span class="kc">false</span>
<span class="k">end</span>
<span class="n">postrule</span><span class="o">=</span><span class="k">function</span><span class="p">()</span>
<span class="k">end</span>
</code></pre></div></div>

<p>在action函数中，首先生成一个随机的文件名，然后发送PUT请求，判断响应码是否是201。注意，发送PUT请求的时候，文件扩展名后门必须带”/”，是为了绕过tomcat的检测。</p>

<p>执行结果：</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/8ab58e079ca34f1b7882dfec13bf18b8.png" alt="2019-04-24-10-18-23"></p>

<p>使用浏览器访问：</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/dbc2bb90f0a210a2f2b6708832f4e93c.png" alt="2019-04-24-10-18-33"></p>

<p>发现CVE-2017-12615这个字符，证明该漏洞的确存在。</p>

<h2 id="0x07-响应内容匹配">0x07 响应内容匹配</h2>

<p>当我们需要对HTTP响应内容进行操作的时候，需要学习一些字符串操作函数、HTTP包内的函数。</p>

<ul>
  <li>response_contains函数，用于在响应表中匹配字符串，参数如下：</li>
  <li>response : 响应表，可以是（http.get、http.post、http. pipeline_go、http.head等函数的返回值）</li>
  <li>pattern : 字符串匹配模式，可参考lua手册</li>
  <li>case_sensitive : 是否区分大小写，默认值为false，不区分</li>
</ul>

<p>返回值：</p>
<ul>
  <li>match_state : 匹配成功为true，匹配失败为false</li>
  <li>matchs : 返回一个匹配结果表，前提是match_state为true</li>
</ul>

<p>了解了这个函数后，我们可以继续将CVE-2017-12615漏洞检测脚本进一步的优化，让脚本判断写入了jsp文件后，判断是否是我们写入的字符串。这样能够使检测脚本的准确度大大提高，下面请看我在action函数中写入的新代码：</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">……</span>
<span class="n">action</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">)</span>
	<span class="kd">local</span> <span class="n">shell_name</span> <span class="o">=</span> <span class="nb">string.format</span><span class="p">(</span><span class="s2">"%sCVE-2017-12615-CHECK-%d.jsp"</span><span class="p">,</span><span class="s2">"/"</span><span class="p">,</span><span class="nb">math.random</span><span class="p">(</span><span class="mi">9999</span><span class="p">))</span>
	<span class="kd">local</span> <span class="n">status</span> <span class="o">=</span> <span class="n">stdnse</span><span class="p">.</span><span class="n">output_table</span><span class="p">()</span>
	<span class="kd">local</span> <span class="n">put_rsp</span> <span class="o">=</span> <span class="n">http</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">,</span><span class="n">shell_name</span><span class="o">..</span><span class="s2">"/"</span><span class="p">,</span><span class="kc">nil</span><span class="p">,</span><span class="s2">"CVE-2017-12615"</span><span class="p">)</span>
	<span class="k">if</span><span class="p">(</span><span class="n">put_rsp</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">201</span><span class="p">)</span><span class="k">then</span>
		<span class="n">status</span><span class="p">.</span><span class="n">shell_name</span> <span class="o">=</span> <span class="n">shell_name</span>
		<span class="kd">local</span> <span class="n">response</span> <span class="o">=</span> <span class="n">http</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">,</span><span class="n">shell_name</span><span class="p">)</span>
		<span class="k">if</span><span class="p">(</span><span class="n">response</span> <span class="ow">and</span> <span class="n">http</span><span class="p">.</span><span class="n">response_contains</span><span class="p">(</span><span class="n">response</span><span class="p">,</span><span class="s2">"CVE%-2017%-12615"</span><span class="p">)</span> <span class="p">)</span><span class="k">then</span>
			<span class="k">return</span> <span class="n">status</span>
		<span class="k">end</span>
		<span class="k">return</span> <span class="kc">false</span>
	<span class="k">end</span>
	<span class="k">return</span> <span class="kc">false</span>
<span class="k">end</span>
<span class="err">……</span>
</code></pre></div></div>

<p>脚本执行结果与上一节中的内容相同，只是多了一次GET请求，为了让读者真正理解这个脚本的执行过程，下面对比一下wireshark流量：</p>

<ul>
  <li>优化前：</li>
</ul>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/54248cd5201053a46cada7179accdbeb.png" alt="2019-04-24-10-19-52"></p>

<p>首先脚本直接向80端口发送了一个PUT请求，然后服务器响应405，漏洞利用失败。</p>

<p>紧接着脚本又请求了8080端口，服务器响应201，证明漏洞利用成功。</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/c66aae5cd70512ec0472b2c2a7ffaeb8.png" alt="2019-04-24-10-20-01"></p>

<ul>
  <li>优化后：</li>
</ul>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/14d38a0b6a2422aa48136513f1c7f171.png" alt="2019-04-24-10-20-09"></p>

<p>通过向8080端口发送PUT请求成功利用后，又向写入文件发送了一次GET请求，获取响应内容，进行字符串匹配，达到更加深度的验证漏洞是否利用成功。</p>

<h2 id="0x08-并发http请求">0x08 并发HTTP请求</h2>

<p>这里说的并发HTTP请求的原理是与目标主机建立一个socket，在每一次发送报文后都不会断开（除了最后一次请求）。平常我们在扩展脚本中调用一个http.get函数，将会返回一个响应表，代表已经获取了目标主机的响应报文，当返回响应表之前就已经与目标主机断开了连接。下一次调用http.get时，还需要进行一次建立连接的过程，导致我们会消耗一定的时间。如果一个扩展脚本需要发送多次请求，可以考虑使用http.pipeline_add与http.pipline_go配合使用。</p>

<p>下面就来介绍这两个函数如何配合使用：</p>

<p>http.pipeline_add参数如下：</p>

<ul>
  <li>path : 请求路径</li>
  <li>options : 用于设置请求相关的Cookie、超时时间、header</li>
  <li>all_requests : （可选值），如果是第一次调用，则为nil，若不是第一次调用，需要传入上一次http.pipeline_add的返回值</li>
  <li>method : HTTP方法（GET、POST、HEAD、PUT等），默认为GET</li>
</ul>

<p>返回值：</p>

<ul>
  <li>一个请求表</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|   
|     path: 
|     options: 
|       header: 
|         Connection: keep-alive
|_    method: GET
</code></pre></div></div>

<p>可以有多个，下标从1开始，如果需要查看这个请求列表的结构，可以直接在action函数中return出http.pipeline_add的返回值，代码演示如下：</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">……</span>
<span class="n">action</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">)</span>
	<span class="kd">local</span> <span class="n">all_requests</span> <span class="o">=</span> <span class="n">http</span><span class="p">.</span><span class="n">pipeline_add</span><span class="p">(</span><span class="s2">"/index.jsp"</span><span class="p">,</span><span class="kc">nil</span><span class="p">,</span><span class="kc">nil</span><span class="p">,</span><span class="s2">"GET"</span><span class="p">)</span>
	<span class="n">all_requests</span> <span class="o">=</span> <span class="n">http</span><span class="p">.</span><span class="n">pipeline_add</span><span class="p">(</span><span class="s2">"/docs/changelog.html"</span><span class="p">,</span><span class="kc">nil</span><span class="p">,</span><span class="n">all_requests</span><span class="p">,</span><span class="s2">"GET"</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">all_requests</span>
<span class="k">end</span>
<span class="err">……</span>
</code></pre></div></div>

<p>执行结果：</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2a93c8afc0b2e2e68d79b59506d08424.png" alt="2019-04-24-10-21-19"></p>

<p>因为调用了两次http.pipeline_add，所以会产生两个请求列表队列元素，如果只想获取第一个请求队列元素，可以return all_requests[1]。</p>

<p>下面我们要开始将队列交给http.pipeline_go函数，由它来完成所有请求，函数参数如下：</p>

<ul>
  <li>host : host表</li>
  <li>port : port 表</li>
  <li>all_requests : 由http.pipeline_add函数装在好的请求列表</li>
</ul>

<p>返回值：</p>
<ul>
  <li>response_list : 响应列表</li>
</ul>

<p>示例代码：</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="err">……</span>
<span class="n">action</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">)</span>
	<span class="kd">local</span> <span class="n">status_lines</span> <span class="o">=</span> <span class="n">stdnse</span><span class="p">.</span><span class="n">output_table</span><span class="p">()</span>
	<span class="kd">local</span> <span class="n">all_requests</span> <span class="o">=</span> <span class="n">http</span><span class="p">.</span><span class="n">pipeline_add</span><span class="p">(</span><span class="s2">"/index.jsp"</span><span class="p">,</span><span class="kc">nil</span><span class="p">,</span><span class="kc">nil</span><span class="p">,</span><span class="s2">"GET"</span><span class="p">)</span>
	<span class="n">all_requests</span> <span class="o">=</span> <span class="n">http</span><span class="p">.</span><span class="n">pipeline_add</span><span class="p">(</span><span class="s2">"/docs/changelog.html"</span><span class="p">,</span><span class="kc">nil</span><span class="p">,</span><span class="n">all_requests</span><span class="p">,</span><span class="s2">"GET"</span><span class="p">)</span>
	<span class="kd">local</span> <span class="n">all_response</span> <span class="o">=</span> <span class="n">http</span><span class="p">.</span><span class="n">pipeline_go</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">,</span><span class="n">all_requests</span><span class="p">)</span>
	<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">resp</span> <span class="k">in</span> <span class="nb">ipairs</span><span class="p">(</span><span class="n">all_response</span><span class="p">)</span><span class="k">do</span>
		<span class="n">status_lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">resp</span><span class="p">[</span><span class="s2">"status-line"</span><span class="p">]</span>
	<span class="k">end</span>
	<span class="k">return</span> <span class="n">status_lines</span>
<span class="k">end</span>
<span class="err">……</span>
</code></pre></div></div>

<p>这段代码中添加了两个请求队列元素，分别是：</p>

<ul>
  <li>/index.jsp</li>
  <li>/docs/changelog.html</li>
</ul>

<p>将队列交给http.pipeline_go函数后，返回一个响应列表，all_response[1]对应index.jsp的响应表，all_response[2]对应/docs/changelog.html的响应表。因此可以使用迭代，将每个请求的某个字段放入一个输出表里，本次示例是取得了两次请求队status-line。</p>

<p>执行结果：</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/fe4b76a55437255e727407e488952db7.png" alt="2019-04-24-10-22-31"></p>

<h2 id="0x09-表单操作">0x09 表单操作</h2>

<p>关于表单操作，在爬虫、漏洞扫描、爆破时用的较多，一般要先取回目标主机的响应body，然后字符串匹配获得表单结构。但是这些操作在Nmap中已经提供了一些方法，接下来就让我们一起学习http包中的表单操作函数吧。</p>

<p>http.grab_forms 用于在响应内容中查找表单，并返回一个form_list表，参数如下：</p>

<ul>
  <li>body : 响应表中的body</li>
</ul>

<p>返回值：</p>

<ul>
  <li>form_list : 表单列表</li>
</ul>

<blockquote>
  <p>获取页面中的表单列表</p>
</blockquote>

<p>我使用apache和php搭建了一个简单的登录界面，尝试通过nmap的扩展脚本来获取表单列表。</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/bb6a9f803b4f391126c2f24ac5af7e24.png" alt="2019-04-24-10-23-28"></p>

<p>查看一下HTML源码：</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/36979ae8c35249d101c334d1868365ec.png" alt="2019-04-24-10-23-36"></p>

<p>可以发现页面中这个表单是提交到index.php的，并且提供了两个输入值，分别是username和password，这种情况下我们完全可以采用lua的字符串匹配模式获得input的name，但是如果页面上有很多表单，这就会增加我们处理数据的压力。</p>

<p>我们来试试http.grab_forms函数：</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">http</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">"http"</span>
<span class="n">prerule</span><span class="o">=</span><span class="k">function</span><span class="p">()</span>
<span class="k">end</span>
<span class="n">hostrule</span><span class="o">=</span><span class="k">function</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>
	<span class="k">return</span> <span class="kc">false</span>
<span class="k">end</span>
<span class="n">portrule</span><span class="o">=</span><span class="k">function</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">)</span>
	<span class="k">if</span><span class="p">(</span><span class="n">port</span><span class="p">.</span><span class="n">number</span> <span class="o">==</span> <span class="mi">80</span><span class="p">)</span><span class="k">then</span>
		<span class="k">return</span> <span class="kc">true</span>
	<span class="k">end</span>
<span class="k">end</span>
<span class="n">action</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">)</span>
	<span class="kd">local</span> <span class="n">response</span> <span class="o">=</span> <span class="n">http</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">,</span><span class="s2">"/index.php"</span><span class="p">)</span>
	<span class="kd">local</span> <span class="n">login_forms</span> <span class="o">=</span> <span class="n">http</span><span class="p">.</span><span class="n">grab_forms</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">body</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">login_forms</span>
<span class="k">end</span>
<span class="n">postrule</span><span class="o">=</span><span class="k">function</span><span class="p">()</span>
<span class="k">end</span>

</code></pre></div></div>

<p>因为http.grab_forms函数接收的是响应表的body，所以需要调用http.get函数将响应表取到，再把响应表的body传递进去。</p>

<p>执行结果：</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/6d2f20e17da8c71252947429d2312e29.png" alt="2019-04-24-10-24-01"></p>

<p>目前是获得了一个登录表单，注意：返回的是一个表单列表，而不是只能获得一个表单，在登录页面中新添加一个表单后：</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/212338d018c5c84d5f36c8bc6d7e9776.png" alt="2019-04-24-10-24-07"></p>

<p>再执行脚本观察一下：</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/37a8d032a141639df688c71eec776976.png" alt="2019-04-24-10-24-15"></p>

<p>如果还想进一步获得input的name值，就要学习另外一个函数—— http. parse_form</p>

<p>参数如下：</p>

<ul>
  <li>form : 表单的明文</li>
</ul>

<p>返回值：</p>

<ul>
  <li>一个带键的表，分别有：action、method、fields</li>
</ul>

<p>示例：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| test: 
|   action: /index.php
|   method: post
|   fields: 
|     
|       type: text
|       value: test
|       name: username
|     
|       type: text
|       value: test
|_      name: password
</code></pre></div></div>

<p>注意：fields是一个table，不是一个字符串，里面有表单的多个字段</p>

<blockquote>
  <p>需求：爬取页面表单，并尝试登录</p>
</blockquote>

<p>当前页面有两个表单，先尝试一个表单来登录，整体步骤如下：</p>

<ol>
  <li>抓取表单</li>
  <li>解析表单</li>
  <li>拼接字段</li>
  <li>登录</li>
  <li>判断是否登录成功</li>
</ol>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">action</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">)</span>
	<span class="kd">local</span> <span class="n">login_table</span> <span class="o">=</span> <span class="p">{}</span>
	<span class="kd">local</span> <span class="n">response</span> <span class="o">=</span> <span class="n">http</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">,</span><span class="s2">"/index.php"</span><span class="p">)</span>
	<span class="kd">local</span> <span class="n">login_forms</span> <span class="o">=</span> <span class="n">http</span><span class="p">.</span><span class="n">grab_forms</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">body</span><span class="p">)</span>
	<span class="kd">local</span> <span class="n">form</span> <span class="o">=</span> <span class="n">http</span><span class="p">.</span><span class="n">parse_form</span><span class="p">(</span><span class="n">login_forms</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
	<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">name</span> <span class="k">in</span> <span class="nb">ipairs</span><span class="p">(</span><span class="n">form</span><span class="p">.</span><span class="n">fields</span><span class="p">)</span><span class="k">do</span>
		<span class="n">login_table</span><span class="p">[</span><span class="n">form</span><span class="p">.</span><span class="n">fields</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">]</span><span class="o">=</span><span class="s2">"admin"</span>
	<span class="k">end</span>
	<span class="kd">local</span> <span class="n">login_response</span> <span class="o">=</span> <span class="n">http</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">,</span><span class="s2">"/index.php"</span><span class="p">,</span><span class="kc">nil</span><span class="p">,</span><span class="kc">nil</span><span class="p">,</span><span class="n">login_table</span><span class="p">)</span>
	<span class="k">if</span><span class="p">(</span><span class="n">http</span><span class="p">.</span><span class="n">response_contains</span><span class="p">(</span><span class="n">login_response</span><span class="p">,</span><span class="s2">"success"</span><span class="p">))</span><span class="k">then</span>
		<span class="n">login_table</span><span class="p">.</span><span class="n">login_status</span> <span class="o">=</span> <span class="kc">true</span>
		<span class="k">return</span> <span class="n">login_table</span>
	<span class="k">end</span>
	<span class="n">login_tabke</span><span class="p">.</span><span class="n">login_status</span> <span class="o">=</span> <span class="kc">false</span>
	<span class="k">return</span> <span class="n">login_table</span>
<span class="k">end</span>
</code></pre></div></div>

<p>本段代码首先获取index.php的响应表，通过http.grab_forms函数获得登录，将返回值（第一个表单）交给http.parse_from，取得表单fields（字段），然后遍历每一个字段的name，把它填入一个table，最后执行http.post函数，刚好http.post的data可以是一个table也可以是一个字符串。请求完毕后得到登录的响应结果，再由http.response_contains判断是否登录成功，登录成功会出现success字样提示。</p>

<p>为了解决疑惑，我贴出index.php的源代码：</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="cp">&lt;?php</span>
<span class="k">if</span><span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s2">"username"</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="k">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s2">"password"</span><span class="p">]))</span>
<span class="p">{</span>
	<span class="nv">$username</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s2">"username"</span><span class="p">];</span>
	<span class="nv">$password</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s2">"password"</span><span class="p">];</span>
	<span class="k">if</span><span class="p">(</span><span class="nv">$username</span> <span class="o">==</span> <span class="s2">"admin"</span> <span class="o">&amp;&amp;</span> <span class="nv">$password</span> <span class="o">==</span> <span class="s2">"admin"</span><span class="p">){</span>
		<span class="k">echo</span> <span class="s2">"login success !"</span><span class="p">;</span>
	
	<span class="p">}</span><span class="k">else</span><span class="p">{</span>
		<span class="k">echo</span> <span class="s2">"login failed !"</span><span class="p">;</span>
	
	<span class="p">}</span>

<span class="p">}</span><span class="k">else</span><span class="p">{</span>
	<span class="k">echo</span> <span class="s2">"please login !"</span><span class="p">;</span>

<span class="p">}</span>

<span class="cp">?&gt;</span>
<span class="nt">&lt;hr/&gt;</span>
<span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"/index.php"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
username:<span class="nt">&lt;br&gt;</span>
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"username"</span> <span class="na">value=</span><span class="s">"test"</span><span class="nt">&gt;</span>
<span class="nt">&lt;br&gt;</span>
password:<span class="nt">&lt;br&gt;</span>
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"password"</span> <span class="na">value=</span><span class="s">"test"</span><span class="nt">&gt;</span>
<span class="nt">&lt;br&gt;&lt;br&gt;</span>
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"Submit"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>
……
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>下一章：DNS包的使用</p>

<p>正向解析、反向解析、发送DNS请求等</p>

  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="//avatars0.githubusercontent.com/u/19944759?s=150&v=4" alt="倾旋">
  <div class="col-box-title name">倾旋</div>
  <p>特点：爪子长、个子高、身体瘦弱
</p>
  <p class="contact">
    
    <a href="https://github.com/Rvn0xsy">GitHub</a>
    
    
    <a href="https://twitter.com/Rvn0xsy">Twitter</a>
    
    
    <a href="mailto:rvn0xsy@gmail.com">Email</a>
    
    <a href="#">微信</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">Newest Posts</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/archivers/2021-02-18/1">Pricking 项目（一） ：使用介绍</a></li>
    
      <li><a class="post-link" href="/archivers/2021-02-18/2">Pricking 项目（二） ：JS模块开发</a></li>
    
      <li><a class="post-link" href="/archivers/2021-02-16/1">红队技巧：基于反向代理的水坑攻击</a></li>
    
      <li><a class="post-link" href="/archivers/2021-02-09/1">CVE-2021-3156 - Exploit修改</a></li>
    
      <li><a class="post-link" href="/archivers/2021-02-08/1">静态恶意代码逃逸（第十课）</a></li>
    
      <li><a class="post-link" href="/archivers/2021-01-31/1">Windows权限控制相关的防御与攻击技术</a></li>
    
      <li><a class="post-link" href="/archivers/2020-11-29/2">静态恶意代码逃逸（第九课）</a></li>
    
      <li><a class="post-link" href="/archivers/2020-11-29/1">静态恶意代码逃逸（第八课）</a></li>
    
      <li><a class="post-link" href="/archivers/2020-11-13/1">Linux透明代理在红队渗透中的应用</a></li>
    
      <li><a class="post-link" href="/archivers/2020-11-01/1">Web正向代理的思考</a></li>
    
      <li><a class="post-link" href="/archivers/2020-10-23/1">静态恶意代码逃逸（第七课）</a></li>
    
      <li><a class="post-link" href="/archivers/2020-08-24/1">这是一个充满挑战的好时代</a></li>
    
      <li><a class="post-link" href="/archivers/2020-07-16/1">通过OXID解析器获取Windows远程主机上网卡地址</a></li>
    
      <li><a class="post-link" href="/archivers/2020-06-28/1">如何实现一个Atexec</a></li>
    
      <li><a class="post-link" href="/archivers/2020-04-02/1">如何实现一个Psexec</a></li>
    
    <li><a class="post-link" href="/posts/">更多....</a></li>
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">TOC</div>
</div>

        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
© 2021 倾旋
</div>
</footer>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-158746438-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-158746438-1');
</script>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>


  </body>

</html>
