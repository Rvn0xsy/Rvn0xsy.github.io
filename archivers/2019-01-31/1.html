<!DOCTYPE html>
<html>

  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>BMP位图隐写 « 倾旋的博客</title>
  <meta name="description" content="0x01 BMP简介BMP（全称Bitmap）是Windows操作系统中的标准图像文件格式，可以分成两类：设备有向量相关位图（DDB）和设备无向量相关位图（DIB），使用非常广。它采用位映射存储格式，除了图像深度可选以外，不采用其他任何压缩，因此，BMP文件所占用的空间很大。BMP文件的图像深度可选lbit、4b...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://payloads.online/archivers/2019-01-31/1">
  <link rel="alternate" type="application/rss+xml" title="倾旋的博客" href="https://payloads.online/feed.xml">
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">倾旋的博客</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/">About</a>
      
        
        <a class="page-link" href="/posts/">Posts</a>
      
        
        <a class="page-link" href="/links/">Links</a>
      
        
        <a class="page-link" href="https://cooolis.payloads.online/">Cooolis</a>
      
        
        <a class="page-link" href="/feed.xml">RSS</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">BMP位图隐写</h1>
    <p class="post-meta">Jan 31, 2019</p>
  </header>

  <article class="post-content">
    <h2 id="0x01-bmp简介">0x01 BMP简介</h2>

<p>BMP（全称Bitmap）是Windows操作系统中的标准图像文件格式，可以分成两类：设备有向量相关位图（DDB）和设备无向量相关位图（DIB），使用非常广。它采用位映射存储格式，除了图像深度可选以外，不采用其他任何压缩，因此，BMP文件所占用的空间很大。BMP文件的图像深度可选lbit、4bit、8bit及24bit。BMP文件存储数据时，图像的扫描方式是按从左到右、从下到上的顺序。由于BMP文件格式是Windows环境中交换与图有关的数据的一种标准，因此在Windows环境中运行的图形图像软件都支持BMP图像格式。</p>

<p>典型的BMP图像文件由四部分组成：</p>

<ul>
  <li>1：位图头文件数据结构，它包含BMP图像文件的类型、显示内容等信息；</li>
  <li>2：位图信息数据结构，它包含有BMP图像的宽、高、压缩方法，以及定义颜色等信息；</li>
  <li>3：调色板，这个部分是可选的，有些位图需要调色板，有些位图，比如真彩色图（24位的BMP）就不需要调色板；</li>
  <li>4：位图数据，这部分的内容根据BMP位图使用的位数不同而不同，在24位图中直接使用RGB，而其他的小于24位的使用调色板中颜色索引值。</li>
</ul>

<p>当然，我们不需要了解那么多，唯一比较重要的就是文件数据结构。</p>

<h2 id="0x02-bmp文件格式">0x02 BMP文件格式</h2>

<p>第一个知识点：BM (0x4D 0x42)</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/75e46674e10c6fdcc3baa0a170e163dd.png" alt="2019-01-31-16-00-25"></p>

<p>所有的BMP文件都以这两个字节开头（固定格式）。</p>

<p><a href="https://www.cnblogs.com/mingcaoyouxin/p/4286310.html">详解大端模式和小端模式</a></p>

<p><strong>由于个人计算机都是以小端存储的，所以你看到的0x4D 0x42都要从0x4D由右向左开始读取。</strong></p>

<p>第二个知识点：BMP文件大小</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/4218b349bee2dfd11fc4afd0d5577ff9.png" alt="2019-01-31-16-02-53"></p>

<p>0x00072D46 = 470342（Byte） = 470KB</p>

<p>所以这个BMP的文件大小是470KB，也就是说一个图片软件，校验图片是否损坏、是否完整，都是通过读取这四个字节来判断的。</p>

<p>当然在Web领域也是一样，在图片进行渲染的过程中也会判断文件是否完整。</p>

<h2 id="0x03-偏移量-像素位置">0x03 偏移量-像素位置</h2>

<p>BMP的格式我们不介绍太多，关键是找到像素的偏移量就够了，有了偏移量就能够覆盖像素，每一个像素的宽度是3个字节，也就是色光三原色的RGB值。</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/183b5b3f02cadd1d2333236b454a8c0d.png" alt="2019-01-31-16-16-59"></p>

<p><strong>其中36前面的00 00 00 00是保留位，没有意义。</strong></p>

<p>36 00 00 00(0x36)转换成十进制是54。</p>

<p>也就是说，从BMP文件的第一个字节开始，到第54个字节就是像素的开始。</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/37f70c3706b65a4b4e953ba062d00379.png" alt="2019-01-31-16-21-16"></p>

<p>三个D8就是一个像素。</p>

<h2 id="0x04-写入内容">0x04 写入内容</h2>

<p>这个过程中，我们可以写入shellcode、PE文件、字符串等。</p>

<p>这里我只是写入了一个“Hello world !!!”：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1">// ConsoleApplication1.cpp : This file contains the 'main' function. Program execution begins and ends there.</span>
<span class="c1">//</span>

<span class="cp">#include &lt;iostream&gt;
#include &lt;Windows.h&gt;
#include &lt;winsock.h&gt;
</span><span class="c1">// int WinMain(HINSTANCE hinstance,HINSTANCE hprevinstance,LPSTR lpcmdline,int ncmdshow)</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">CHAR</span> <span class="n">text</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"Hello world !!!"</span><span class="p">;</span>
	<span class="n">LPCWCHAR</span> <span class="n">pFilename</span> <span class="o">=</span> <span class="n">TEXT</span><span class="p">(</span><span class="s">"C:\Users\Rvn0xsy\source</span><span class="se">\r</span><span class="s">epos\ConsoleApplication1\Debug\splash.bmp"</span><span class="p">);</span>
	<span class="n">LPCWCHAR</span> <span class="n">pSaveFilename</span> <span class="o">=</span> <span class="n">TEXT</span><span class="p">(</span><span class="s">"C:\Users\Rvn0xsy\source</span><span class="se">\r</span><span class="s">epos\ConsoleApplication1\Debug\save.bmp"</span><span class="p">);</span>
	<span class="c1">// 创建文件句柄，打开图片</span>
	<span class="n">HANDLE</span> <span class="n">hFile</span> <span class="o">=</span> <span class="n">CreateFile</span><span class="p">(</span><span class="n">pFilename</span><span class="p">,</span> <span class="n">GENERIC_ALL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">OPEN_EXISTING</span><span class="p">,</span> <span class="n">FILE_ATTRIBUTE_NORMAL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hFile</span> <span class="o">==</span> <span class="n">INVALID_HANDLE_VALUE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">std</span><span class="o">::</span><span class="n">wcout</span> <span class="o">&lt;&lt;</span> <span class="n">GetLastError</span><span class="p">();</span>
		<span class="n">MessageBox</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">TEXT</span><span class="p">(</span><span class="s">"CreateFile"</span><span class="p">),</span> <span class="n">TEXT</span><span class="p">(</span><span class="s">"Error"</span><span class="p">),</span> <span class="n">MB_OK</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="c1">// 获取文件大小</span>
	<span class="n">DWORD</span> <span class="n">dwFileSize</span><span class="p">;</span>
	<span class="n">dwFileSize</span><span class="o">=</span><span class="n">GetFileSize</span><span class="p">(</span><span class="n">hFile</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="c1">// 申请一个与文件大小对应的内存空间</span>
	<span class="n">CHAR</span> <span class="o">*</span> <span class="n">lpBuffer</span> <span class="o">=</span><span class="p">(</span><span class="n">CHAR</span> <span class="o">*</span><span class="p">)</span> <span class="n">HeapAlloc</span><span class="p">(</span><span class="n">GetProcessHeap</span><span class="p">(),</span> <span class="n">HEAP_ZERO_MEMORY</span><span class="p">,</span> <span class="n">dwFileSize</span><span class="p">);</span>
	<span class="c1">// 将文件内容读入内存</span>
	<span class="n">ReadFile</span><span class="p">(</span><span class="n">hFile</span><span class="p">,</span> <span class="n">lpBuffer</span><span class="p">,</span> <span class="n">dwFileSize</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwFileSize</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="c1">// 获取第一个像素点对应的首字节</span>
	<span class="n">DWORD</span> <span class="o">*</span> <span class="n">point</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)(</span><span class="n">lpBuffer</span> <span class="o">+</span> <span class="mi">10</span><span class="p">);</span>

	<span class="c1">// 获取首个像素地址</span>
	<span class="n">CHAR</span><span class="o">*</span> <span class="n">lpData</span> <span class="o">=</span> <span class="p">(</span><span class="n">lpBuffer</span> <span class="o">+</span> <span class="p">(</span><span class="o">*</span><span class="n">point</span><span class="p">));</span>
	<span class="c1">// 写入内容</span>
	<span class="n">CopyMemory</span><span class="p">(</span><span class="n">lpData</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">text</span><span class="p">));</span>
	<span class="c1">//创建保存副本</span>
	<span class="n">HANDLE</span> <span class="n">hSave</span> <span class="o">=</span> <span class="n">CreateFile</span><span class="p">(</span><span class="n">pSaveFilename</span><span class="p">,</span> <span class="n">GENERIC_ALL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">CREATE_ALWAYS</span><span class="p">,</span> <span class="n">FILE_ATTRIBUTE_NORMAL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">WriteFile</span><span class="p">(</span><span class="n">hSave</span><span class="p">,</span> <span class="n">lpBuffer</span><span class="p">,</span> <span class="n">dwFileSize</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwFileSize</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span> <span class="c1">// 写入文件</span>
	<span class="n">CloseHandle</span><span class="p">(</span><span class="n">hSave</span><span class="p">);</span> <span class="c1">// 保存</span>

	<span class="c1">// 释放堆</span>
	<span class="n">HeapFree</span><span class="p">(</span><span class="n">GetProcessHeap</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lpBuffer</span><span class="p">);</span>

	<span class="c1">// 关闭文件</span>
	<span class="n">CloseHandle</span><span class="p">(</span><span class="n">hFile</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>效果如下：</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2001a62cdc067d35abf9413aa7022ab2.png" alt="2019-01-31-16-24-59"></p>

<p>对图片的影响只是像素级别的，不会出现缺损问题。</p>

<h2 id="0x05-科普">0x05 科普</h2>

<p>使用CMD命令制作生成图片木马很可能会导致图片缺损，原因是有概率会覆盖掉偏移量、或者代码超出了偏移范围。</p>


  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="//avatars0.githubusercontent.com/u/19944759?s=150&v=4" alt="倾旋">
  <div class="col-box-title name">倾旋</div>
  <p>特点：爪子长、个子高、身体瘦弱
</p>
  <p class="contact">
    
    <a href="https://github.com/Rvn0xsy">GitHub</a>
    
    
    <a href="https://twitter.com/Rvn0xsy">Twitter</a>
    
    
    <a href="mailto:rvn0xsy@gmail.com">Email</a>
    
    <a href="#">微信</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">Newest Posts</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/archivers/2021-02-18/1">Pricking 项目（一） ：使用介绍</a></li>
    
      <li><a class="post-link" href="/archivers/2021-02-18/2">Pricking 项目（二） ：JS模块开发</a></li>
    
      <li><a class="post-link" href="/archivers/2021-02-16/1">红队技巧：基于反向代理的水坑攻击</a></li>
    
      <li><a class="post-link" href="/archivers/2021-02-09/1">CVE-2021-3156 - Exploit修改</a></li>
    
      <li><a class="post-link" href="/archivers/2021-02-08/1">静态恶意代码逃逸（第十课）</a></li>
    
      <li><a class="post-link" href="/archivers/2021-01-31/1">Windows权限控制相关的防御与攻击技术</a></li>
    
      <li><a class="post-link" href="/archivers/2020-11-29/2">静态恶意代码逃逸（第九课）</a></li>
    
      <li><a class="post-link" href="/archivers/2020-11-29/1">静态恶意代码逃逸（第八课）</a></li>
    
      <li><a class="post-link" href="/archivers/2020-11-13/1">Linux透明代理在红队渗透中的应用</a></li>
    
      <li><a class="post-link" href="/archivers/2020-11-01/1">Web正向代理的思考</a></li>
    
      <li><a class="post-link" href="/archivers/2020-10-23/1">静态恶意代码逃逸（第七课）</a></li>
    
      <li><a class="post-link" href="/archivers/2020-08-24/1">这是一个充满挑战的好时代</a></li>
    
      <li><a class="post-link" href="/archivers/2020-07-16/1">通过OXID解析器获取Windows远程主机上网卡地址</a></li>
    
      <li><a class="post-link" href="/archivers/2020-06-28/1">如何实现一个Atexec</a></li>
    
      <li><a class="post-link" href="/archivers/2020-04-02/1">如何实现一个Psexec</a></li>
    
    <li><a class="post-link" href="/posts/">更多....</a></li>
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">TOC</div>
</div>

        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
© 2021 倾旋
</div>
</footer>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-158746438-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-158746438-1');
</script>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>


  </body>

</html>
