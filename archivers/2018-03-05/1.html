<!DOCTYPE html>
<html>

  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>C/C++ 子域名A记录枚举(多线程) « 倾旋的博客</title>
  <meta name="description" content="分享一个C/C++ 子域名A记录枚举的一个工具，可以根据自己的需求再改进">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://payloads.online/archivers/2018-03-05/1">
  <link rel="alternate" type="application/rss+xml" title="倾旋的博客" href="https://payloads.online/feed.xml">
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">倾旋的博客</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/">About</a>
      
        
        <a class="page-link" href="/posts/">Posts</a>
      
        
        <a class="page-link" href="/links/">Links</a>
      
        
        <a class="page-link" href="https://cooolis.payloads.online/">Cooolis</a>
      
        
        <a class="page-link" href="/feed.xml">RSS</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">C/C++ 子域名A记录枚举(多线程)</h1>
    <p class="post-meta">Mar 5, 2018</p>
  </header>

  <article class="post-content">
    <p>分享一个C/C++ 子域名A记录枚举的一个工具，可以根据自己的需求再改进
<!--more--></p>

<ul id="markdown-toc">
  <li><a href="#0x00-%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81a%E8%AE%B0%E5%BD%95%E6%9E%9A%E4%B8%BE" id="markdown-toc-0x00-为什么需要a记录枚举">0x00 为什么需要A记录枚举？</a></li>
  <li><a href="#0x01-%E6%88%91%E7%94%A8%E8%BF%99%E4%BA%9Ba%E8%AE%B0%E5%BD%95%E5%8F%AF%E4%BB%A5%E5%B9%B2%E4%BB%80%E4%B9%88" id="markdown-toc-0x01-我用这些a记录可以干什么">0x01 我用这些A记录可以干什么？</a></li>
  <li><a href="#0x02-%E6%9C%AC%E5%B7%A5%E5%85%B7%E7%9A%84%E5%AE%9E%E7%8E%B0" id="markdown-toc-0x02-本工具的实现">0x02 本工具的实现</a></li>
  <li><a href="#0x03-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E9%94%81%E7%9A%84%E9%97%AE%E9%A2%98" id="markdown-toc-0x03-多线程锁的问题">0x03 多线程锁的问题</a></li>
  <li><a href="#0x04-%E6%BA%90%E4%BB%A3%E7%A0%81" id="markdown-toc-0x04-源代码">0x04 源代码</a></li>
  <li>
<a href="#0x05-%E7%BC%96%E8%AF%91%E5%8F%8A%E4%BD%BF%E7%94%A8" id="markdown-toc-0x05-编译及使用">0x05 编译及使用</a>    <ul>
      <li><a href="#%E4%BD%BF%E7%94%A8%E5%85%B6%E4%BB%96%E5%AD%97%E5%85%B8" id="markdown-toc-使用其他字典">使用其他字典</a></li>
    </ul>
  </li>
  <li><a href="#0x06-%E6%9C%80%E5%90%8E" id="markdown-toc-0x06-最后">0x06 最后</a></li>
</ul>

<h2 id="0x00-为什么需要a记录枚举">0x00 为什么需要A记录枚举？</h2>

<p>DNS服务中的A记录是指：指定特定主机名映射到特定的IP地址上。</p>

<blockquote>
  <p>这是非常重要记录也是常用的记录，比如解析主机名为www的到IP 1.1.1.1上就需要使用A记录进行</p>
</blockquote>

<p>在渗透测试的很多流程下，我们都需要不断的进行信息搜集，通过搜集到的信息来给我们的攻击带来更多思路。</p>

<h2 id="0x01-我用这些a记录可以干什么">0x01 我用这些A记录可以干什么？</h2>

<p>例如通过我枚举百度域名的结果可以进行分析：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
payloads@Koone:~/cpp_program$ ./dns_enum baidu.com 2
start threads ... 0
[*]news.baidu.com. =&gt; 115.239.210.174
[*]news.baidu.com. =&gt; 180.97.33.136
[*]kaoshi.baidu.com. =&gt; 14.215.177.118
[*]www.baidu.com. =&gt; 115.239.211.112
[*]www.baidu.com. =&gt; 115.239.210.27
[*]bbs.baidu.com. =&gt; 180.97.34.146
[*]cdn.baidu.com. =&gt; 10.36.3.156
[*]api.baidu.com. =&gt; 115.239.210.90
end threads ... 2

</code></pre></div></div>

<p>上面我只是简单的给出了几个子域名结果，可以看到<code class="language-plaintext highlighter-rouge">cdn.baidu.com</code>指向了一个内网地址<code class="language-plaintext highlighter-rouge">10.36.3.156</code>。</p>

<p>在内网渗透中，域名枚举也有很大的作用，因为域控都是DNS服务器，为了在企业内部提供一些服务，则会频繁使用DNS服务来指向某些特定的服务器，所以，知道了域名，可以枚举内网中的一些OA、Email等服务器地址，进行定向渗透。</p>

<blockquote>
  <p>当然不只是A记录，还有很多其他，可以移步搜索引擎搜索 DNS记录类型</p>
</blockquote>

<h2 id="0x02-本工具的实现">0x02 本工具的实现</h2>

<p>大概分为三块：</p>

<ul>
  <li>多线程控制类</li>
  <li>DNS请求类</li>
  <li>主函数类</li>
</ul>

<p>由于之前已经铺垫了太多DNS相关的知识，就自己造个轮子，为了方便编译，我将代码都移植到了<code class="language-plaintext highlighter-rouge">main.cpp</code></p>

<h2 id="0x03-多线程锁的问题">0x03 多线程锁的问题</h2>

<p>在开发的过程中，必须要选择一个变量用来分离任务，不可能两个或多个线程处理同一个任务，资源浪费了。</p>

<p><code class="language-plaintext highlighter-rouge">static int threadLock = 0;</code></p>

<p>务必添加<code class="language-plaintext highlighter-rouge">static</code>关键字注册为全局变量</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">while</span><span class="p">(</span><span class="n">threadLock</span><span class="o">&lt;</span> <span class="n">Dns</span><span class="o">-&gt;</span><span class="n">_subdomain</span><span class="p">.</span><span class="n">size</span><span class="p">()){</span>
        <span class="n">Dns</span><span class="o">-&gt;</span><span class="n">_mutex</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span>
        <span class="c1">//code ...</span>
        <span class="n">threadLock</span><span class="o">++</span><span class="p">;</span>
        <span class="n">Dns</span><span class="o">-&gt;</span><span class="n">_mutex</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>

    <span class="p">}</span>
</code></pre></div></div>

<h2 id="0x04-源代码">0x04 源代码</h2>

<ul>
  <li>源代码地址：http://payloads.online/tools/dns_enum.txt</li>
  <li>字典地址：http://payloads.online/tools/dict.txt</li>
</ul>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1">//dns_enum</span>

<span class="cp">#include &lt;iostream&gt;
#include &lt;cstring&gt;
#include &lt;sys/socket.h&gt;
#include &lt;cstdlib&gt;
#include &lt;arpa/inet.h&gt;
#include &lt;unistd.h&gt;
#include &lt;cstdio&gt;
#include &lt;iostream&gt;
#include &lt;map&gt;
#include &lt;vector&gt;
#include &lt;thread&gt;
#include &lt;mutex&gt;
#include &lt;fstream&gt;
#define T_A 1 //Ipv4 address
#define T_NS 2 //Nameserver
#define T_CNAME 5 // canonical name
#define T_SOA 6 </span><span class="cm">/* start of authority zone */</span><span class="cp">
#define T_PTR 12 </span><span class="cm">/* domain name pointer */</span><span class="cp">
#define T_MX 15 //Mail server
</span>
<span class="k">class</span> <span class="nc">Mythread</span> <span class="p">{</span>
<span class="nl">public:</span>
    <span class="n">Mythread</span><span class="p">();</span>
    <span class="o">~</span><span class="n">Mythread</span><span class="p">();</span>
    <span class="kt">bool</span> <span class="n">setThreads</span><span class="p">(</span><span class="kt">int</span> <span class="kr">thread</span><span class="o">=</span><span class="mi">0</span><span class="p">);</span>
    <span class="kt">bool</span> <span class="n">runThreads</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">function</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span> <span class="n">object</span><span class="p">),</span><span class="kt">void</span> <span class="o">*</span> <span class="n">object</span><span class="p">);</span>
    <span class="kt">bool</span> <span class="n">setDetach</span><span class="p">();</span>
    <span class="kt">bool</span> <span class="n">setJoin</span><span class="p">();</span>
<span class="nl">private:</span>
    <span class="kt">int</span> <span class="kr">_thread</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="o">&gt;</span> <span class="n">threads</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">bool</span> <span class="n">Mythread</span><span class="o">::</span><span class="n">setThreads</span><span class="p">(</span><span class="kt">int</span> <span class="kr">thread</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="kr">thread</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">){</span>
        <span class="kr">_thread</span> <span class="o">=</span> <span class="kr">thread</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="kr">_thread</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="kt">bool</span> <span class="n">Mythread</span><span class="o">::</span><span class="n">runThreads</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">function</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">,</span> <span class="kt">void</span> <span class="o">*</span> <span class="n">object</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="kr">_thread</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">threads</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="p">(</span><span class="n">function</span><span class="p">,</span><span class="n">object</span><span class="p">));</span>

    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">Mythread</span><span class="o">::</span><span class="n">setDetach</span><span class="p">(){</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="kr">_thread</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">threads</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">detach</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">Mythread</span><span class="o">::</span><span class="n">setJoin</span><span class="p">(){</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="kr">_thread</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">threads</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">join</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">Mythread</span><span class="o">::</span><span class="n">Mythread</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"start threads ... "</span> <span class="o">&lt;&lt;</span> <span class="kr">_thread</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>


<span class="n">Mythread</span><span class="o">::~</span><span class="n">Mythread</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"end threads ... "</span> <span class="o">&lt;&lt;</span> <span class="kr">_thread</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">struct</span> <span class="nc">DNS_HEADER</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">id</span><span class="p">;</span> <span class="c1">// identification number</span>

    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">rd</span> <span class="o">:</span><span class="mi">1</span><span class="p">;</span> <span class="c1">// recursion desired</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tc</span> <span class="o">:</span><span class="mi">1</span><span class="p">;</span> <span class="c1">// truncated message</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">aa</span> <span class="o">:</span><span class="mi">1</span><span class="p">;</span> <span class="c1">// authoritive answer</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">opcode</span> <span class="o">:</span><span class="mi">4</span><span class="p">;</span> <span class="c1">// purpose of message</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">qr</span> <span class="o">:</span><span class="mi">1</span><span class="p">;</span> <span class="c1">// query/response flag</span>

    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">rcode</span> <span class="o">:</span><span class="mi">4</span><span class="p">;</span> <span class="c1">// response code</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cd</span> <span class="o">:</span><span class="mi">1</span><span class="p">;</span> <span class="c1">// checking disabled</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ad</span> <span class="o">:</span><span class="mi">1</span><span class="p">;</span> <span class="c1">// authenticated data</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">z</span> <span class="o">:</span><span class="mi">1</span><span class="p">;</span> <span class="c1">// its z! reserved</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ra</span> <span class="o">:</span><span class="mi">1</span><span class="p">;</span> <span class="c1">// recursion available</span>

    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">q_count</span><span class="p">;</span> <span class="c1">// number of question entries</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ans_count</span><span class="p">;</span> <span class="c1">// number of answer entries</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">auth_count</span><span class="p">;</span> <span class="c1">// number of authority entries</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">add_count</span><span class="p">;</span> <span class="c1">// number of resource entries</span>
<span class="p">};</span>

<span class="c1">//Constant sized fields of query structure</span>
<span class="k">struct</span> <span class="nc">QUESTION</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">qtype</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">qclass</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">//Constant sized fields of the resource record structure</span>
<span class="cp">#pragma pack(push, 1)
</span><span class="k">struct</span> <span class="nc">R_DATA</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">type</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">_class</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ttl</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">data_len</span><span class="p">;</span>
<span class="p">};</span>
<span class="cp">#pragma pack(pop)
</span>
<span class="c1">//Pointers to resource record contents</span>
<span class="k">struct</span> <span class="nc">RES_RECORD</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
    <span class="k">struct</span> <span class="nc">R_DATA</span> <span class="o">*</span><span class="n">resource</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">rdata</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">//Structure of a Query</span>
<span class="k">typedef</span> <span class="k">struct</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
    <span class="k">struct</span> <span class="nc">QUESTION</span> <span class="o">*</span><span class="n">ques</span><span class="p">;</span>
<span class="p">}</span> <span class="n">QUERY</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">dns</span> <span class="p">{</span>

<span class="nl">public:</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">dnsServer</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">_subdomain</span> <span class="o">=</span> <span class="p">{};</span>
<span class="nl">public:</span>
    <span class="n">dns</span><span class="p">();</span>
    <span class="n">dns</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">dnsServer</span><span class="p">);</span>
    <span class="o">~</span><span class="n">dns</span><span class="p">();</span>
    <span class="kt">void</span> <span class="n">setHostname</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">hostname</span><span class="p">);</span>
    <span class="kt">void</span> <span class="n">request</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">hostname</span><span class="p">);</span>
    <span class="kt">void</span> <span class="n">changeToDnsNameFormat</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">dns</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">host</span><span class="p">);</span>
    <span class="kt">int</span>  <span class="n">setDnsServer</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span>  <span class="n">dnsServer</span><span class="p">);</span>
    <span class="k">static</span> <span class="kt">void</span> <span class="n">threadRequest</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span> <span class="n">hostname</span><span class="p">);</span>
    <span class="kt">void</span> <span class="n">runThread</span><span class="p">(</span><span class="kt">int</span> <span class="n">threadNum</span><span class="p">);</span>
    <span class="kt">bool</span> <span class="n">addSubdomain</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">subdomainName</span><span class="p">);</span>
<span class="nl">private:</span>
    <span class="kt">void</span> <span class="n">setDnsHeader</span><span class="p">(</span><span class="k">struct</span> <span class="nc">DNS_HEADER</span> <span class="o">*</span> <span class="n">dns</span><span class="p">);</span>
    <span class="kt">void</span> <span class="n">setQname</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">hostname</span><span class="p">);</span>
    <span class="kt">void</span> <span class="n">setQinfo</span><span class="p">(</span><span class="k">struct</span> <span class="nc">QUESTION</span> <span class="o">*</span><span class="n">qinfo</span><span class="p">);</span>
    <span class="kt">void</span> <span class="n">requestDnsServer</span><span class="p">(</span><span class="k">struct</span> <span class="nc">DNS_HEADER</span> <span class="o">*</span><span class="n">dns</span><span class="p">);</span>
    <span class="n">u_char</span><span class="o">*</span> <span class="n">ReadName</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">reader</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">buffer</span><span class="p">,</span><span class="kt">int</span><span class="o">*</span> <span class="n">count</span><span class="p">);</span>

<span class="nl">private:</span>
    <span class="kt">int</span> <span class="n">dnsSock</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">_dnsServer</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">_hostname</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">_buff</span><span class="p">[</span><span class="mi">65535</span><span class="p">];</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">_qname</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">_reader</span><span class="p">;</span>
    <span class="k">struct</span> <span class="nc">RES_RECORD</span> <span class="n">_answers</span><span class="p">[</span><span class="mi">20</span><span class="p">],</span><span class="n">_auth</span><span class="p">[</span><span class="mi">20</span><span class="p">],</span><span class="n">_addit</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
    <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">_aResult</span><span class="p">;</span>
    <span class="n">sockaddr_in</span> <span class="n">_dest</span><span class="p">,</span><span class="n">_a</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">mutex</span> <span class="n">_mutex</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">_currentHostname</span><span class="p">;</span>
<span class="p">};</span>


<span class="c1">//</span>
<span class="c1">// Created by payloads on 18-2-27.</span>
<span class="c1">//</span>



<span class="n">dns</span><span class="o">::</span><span class="n">dns</span><span class="p">(){</span>

<span class="p">}</span>

<span class="n">dns</span><span class="o">::</span><span class="n">dns</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">dnsServer</span><span class="p">){</span>
    <span class="n">setDnsServer</span><span class="p">(</span><span class="n">dnsServer</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">dns</span><span class="o">::~</span><span class="n">dns</span><span class="p">(){</span>

    <span class="k">auto</span> <span class="n">it</span> <span class="o">=</span> <span class="n">_aResult</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
    <span class="k">for</span> <span class="p">(;</span> <span class="n">it</span> <span class="o">!=</span> <span class="n">_aResult</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="o">++</span><span class="n">it</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"[*]"</span> <span class="o">&lt;&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">_hostname</span> <span class="o">&lt;&lt;</span> <span class="s">" =&gt; "</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="o">*</span><span class="n">it</span><span class="p">).</span><span class="n">second</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**
 *
 * @param hostname
 */</span>
<span class="kt">void</span> <span class="n">dns</span><span class="o">::</span><span class="n">request</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">hostname</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">strcpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">_hostname</span><span class="p">,</span><span class="n">hostname</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>

    <span class="k">struct</span> <span class="nc">DNS_HEADER</span> <span class="o">*</span> <span class="n">dns</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">struct</span> <span class="nc">QUESTION</span> <span class="o">*</span><span class="n">qinfo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="n">setDnsHeader</span><span class="p">(</span><span class="n">dns</span><span class="p">);</span>
    <span class="n">setQname</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hostname</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
    <span class="n">setQinfo</span><span class="p">(</span><span class="n">qinfo</span><span class="p">);</span>


    <span class="n">requestDnsServer</span><span class="p">(</span><span class="n">dns</span><span class="p">);</span>
    <span class="n">dns</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="nc">DNS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">_buff</span><span class="p">;</span>



    <span class="n">_reader</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">_buff</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="nc">DNS_HEADER</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">strlen</span><span class="p">((</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_qname</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="nc">QUESTION</span><span class="p">)];</span>

    <span class="kt">int</span> <span class="n">stop</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">ntohs</span><span class="p">(</span><span class="n">dns</span><span class="o">-&gt;</span><span class="n">ans_count</span><span class="p">);</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_answers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="o">=</span><span class="n">ReadName</span><span class="p">(</span><span class="n">_reader</span><span class="p">,</span><span class="n">_buff</span><span class="p">,</span><span class="o">&amp;</span><span class="n">stop</span><span class="p">);</span>
        <span class="n">_reader</span> <span class="o">=</span> <span class="n">_reader</span> <span class="o">+</span> <span class="n">stop</span><span class="p">;</span>
        <span class="n">_answers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">resource</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="nc">R_DATA</span><span class="o">*</span><span class="p">)(</span><span class="n">_reader</span><span class="p">);</span>
        <span class="n">_reader</span> <span class="o">=</span> <span class="n">_reader</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="nc">R_DATA</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">_answers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">resource</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_answers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdata</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">_answers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">resource</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">));</span>

            <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">j</span><span class="o">=</span><span class="mi">0</span> <span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">ntohs</span><span class="p">(</span><span class="n">_answers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">resource</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">)</span> <span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">_answers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdata</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">_reader</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
            <span class="p">}</span>

            <span class="n">_answers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdata</span><span class="p">[</span><span class="n">ntohs</span><span class="p">(</span><span class="n">_answers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">resource</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">)]</span> <span class="o">=</span> <span class="err">'</span><span class="o">&lt;!</span><span class="n">JEKYLL</span><span class="err">@</span><span class="mi">5920</span><span class="err">@</span><span class="mi">7</span><span class="o">&gt;</span><span class="err">'</span><span class="p">;</span>

            <span class="n">_reader</span> <span class="o">=</span> <span class="n">_reader</span> <span class="o">+</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">_answers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">resource</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">_answers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdata</span> <span class="o">=</span> <span class="n">ReadName</span><span class="p">(</span><span class="n">_reader</span><span class="p">,</span><span class="n">_buff</span><span class="p">,</span><span class="o">&amp;</span><span class="n">stop</span><span class="p">);</span>
            <span class="n">_reader</span> <span class="o">=</span> <span class="n">_reader</span> <span class="o">+</span> <span class="n">stop</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Answer Records : %d </span><span class="se">\n</span><span class="s">"</span> <span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">dns</span><span class="o">-&gt;</span><span class="n">ans_count</span><span class="p">)</span> <span class="p">);</span>

    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">dns</span><span class="o">-&gt;</span><span class="n">ans_count</span><span class="p">)</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//printf("Name : %s ",answers[i].name);</span>

        <span class="k">if</span><span class="p">(</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">_answers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">resource</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">==</span> <span class="n">T_A</span><span class="p">)</span> <span class="c1">//IPv4 address</span>
        <span class="p">{</span>

            <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">ipAddress</span><span class="p">;</span>
            <span class="kt">long</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
            <span class="n">p</span><span class="o">=</span><span class="p">(</span><span class="kt">long</span><span class="o">*</span><span class="p">)</span><span class="n">_answers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdata</span><span class="p">;</span>
            <span class="n">_a</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="o">=</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">);</span> <span class="c1">//working without ntohl</span>
            <span class="c1">//printf("has IPv4 address : %s",inet_ntoa(a.sin_addr));</span>
            <span class="n">ipAddress</span><span class="o">=</span><span class="n">inet_ntoa</span><span class="p">(</span><span class="n">_a</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">);</span>
            <span class="n">_aResult</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">ipAddress</span><span class="p">));</span>
        <span class="p">}</span>

        <span class="k">if</span><span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">_answers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">resource</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span><span class="o">==</span><span class="mi">5</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"has alias name : %s"</span><span class="p">,</span><span class="n">_answers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdata</span><span class="p">);</span>
        <span class="p">}</span>

    <span class="p">}</span>
    <span class="n">close</span><span class="p">(</span><span class="n">dnsSock</span><span class="p">);</span>

    <span class="k">auto</span> <span class="n">it</span> <span class="o">=</span> <span class="n">_aResult</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
    <span class="k">for</span> <span class="p">(;</span> <span class="n">it</span> <span class="o">!=</span> <span class="n">_aResult</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="o">++</span><span class="n">it</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"[*]"</span> <span class="o">&lt;&lt;</span> <span class="n">hostname</span> <span class="o">&lt;&lt;</span> <span class="s">" =&gt; "</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="o">*</span><span class="n">it</span><span class="p">).</span><span class="n">second</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">dns</span><span class="o">-&gt;</span><span class="n">ans_count</span><span class="p">)</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">_answers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">resource</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">//if its an ipv4 address</span>
        <span class="p">{</span>
            <span class="n">free</span><span class="p">(</span><span class="n">_answers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdata</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">_aResult</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">_hostname</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="err">'</span><span class="o">&lt;!</span><span class="n">JEKYLL</span><span class="err">@</span><span class="mi">5920</span><span class="err">@</span><span class="mi">7</span><span class="o">&gt;</span><span class="err">'</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**
 *
 * @param dns
 * @param host
 */</span>
<span class="kt">void</span> <span class="n">dns</span><span class="o">::</span><span class="n">changeToDnsNameFormat</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">dns</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">lock</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">,</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">strcat</span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">host</span><span class="p">,</span><span class="s">"."</span><span class="p">);</span>

    <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">strlen</span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">host</span><span class="p">)</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">host</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="sc">'.'</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="o">*</span><span class="n">dns</span><span class="o">++</span> <span class="o">=</span> <span class="n">i</span><span class="o">-</span><span class="n">lock</span><span class="p">;</span>
            <span class="k">for</span><span class="p">(;</span><span class="n">lock</span><span class="o">&lt;</span><span class="n">i</span><span class="p">;</span><span class="n">lock</span><span class="o">++</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="o">*</span><span class="n">dns</span><span class="o">++=</span><span class="n">host</span><span class="p">[</span><span class="n">lock</span><span class="p">];</span>
            <span class="p">}</span>
            <span class="n">lock</span><span class="o">++</span><span class="p">;</span> <span class="c1">//or lock=i+1;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="o">*</span><span class="n">dns</span><span class="o">++=</span><span class="err">'</span><span class="o">&lt;!</span><span class="n">JEKYLL</span><span class="err">@</span><span class="mi">5920</span><span class="err">@</span><span class="mi">7</span><span class="o">&gt;</span><span class="err">'</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**
 *
 * @param dns
 */</span>
<span class="kt">void</span> <span class="n">dns</span><span class="o">::</span><span class="n">setDnsHeader</span><span class="p">(</span><span class="k">struct</span> <span class="nc">DNS_HEADER</span> <span class="o">*</span><span class="n">dns</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">dns</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="nc">DNS_HEADER</span> <span class="o">*</span> <span class="p">)</span><span class="o">&amp;</span><span class="n">_buff</span><span class="p">;</span>
    <span class="n">dns</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span> <span class="n">htons</span><span class="p">(</span><span class="n">getpid</span><span class="p">());</span>
    <span class="n">dns</span><span class="o">-&gt;</span><span class="n">qr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">//This is a query</span>
    <span class="n">dns</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">//This is a standard query</span>
    <span class="n">dns</span><span class="o">-&gt;</span><span class="n">aa</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">//Not Authoritative</span>
    <span class="n">dns</span><span class="o">-&gt;</span><span class="n">tc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">//This message is not truncated</span>
    <span class="n">dns</span><span class="o">-&gt;</span><span class="n">rd</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">//Recursion Desired</span>
    <span class="n">dns</span><span class="o">-&gt;</span><span class="n">ra</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">//Recursion not available! hey we dont have it (lol)</span>
    <span class="n">dns</span><span class="o">-&gt;</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">dns</span><span class="o">-&gt;</span><span class="n">ad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">dns</span><span class="o">-&gt;</span><span class="n">cd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">dns</span><span class="o">-&gt;</span><span class="n">rcode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">dns</span><span class="o">-&gt;</span><span class="n">q_count</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="c1">//we have only 1 question</span>
    <span class="n">dns</span><span class="o">-&gt;</span><span class="n">ans_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">dns</span><span class="o">-&gt;</span><span class="n">auth_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">dns</span><span class="o">-&gt;</span><span class="n">add_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**
 *
 * @param hostname
 */</span>
<span class="kt">void</span> <span class="n">dns</span><span class="o">::</span><span class="n">setQname</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hostname</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">_qname</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">_buff</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="nc">DNS_HEADER</span><span class="p">)];</span>
    <span class="n">changeToDnsNameFormat</span><span class="p">(</span><span class="n">_qname</span><span class="p">,</span><span class="n">hostname</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**
 *
 * @param qinfo
 */</span>
<span class="kt">void</span> <span class="n">dns</span><span class="o">::</span><span class="n">setQinfo</span><span class="p">(</span><span class="k">struct</span> <span class="nc">QUESTION</span> <span class="o">*</span><span class="n">qinfo</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">qinfo</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="nc">QUESTION</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">_buff</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="nc">DNS_HEADER</span><span class="p">)</span><span class="o">+</span><span class="n">strlen</span><span class="p">((</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_qname</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
    <span class="n">qinfo</span><span class="o">-&gt;</span><span class="n">qtype</span><span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">qinfo</span><span class="o">-&gt;</span><span class="n">qclass</span><span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**
 *
 * @param reader
 * @param buffer
 * @param count
 * @return
 */</span>
<span class="n">u_char</span> <span class="o">*</span> <span class="n">dns</span><span class="o">::</span><span class="n">ReadName</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">reader</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">buffer</span><span class="p">,</span><span class="kt">int</span><span class="o">*</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">p</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">jumped</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">offset</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span> <span class="p">,</span> <span class="n">j</span><span class="p">;</span>

    <span class="o">*</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="mi">256</span><span class="p">);</span>

    <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="err">'</span><span class="o">&lt;!</span><span class="n">JEKYLL</span><span class="err">@</span><span class="mi">5920</span><span class="err">@</span><span class="mi">7</span><span class="o">&gt;</span><span class="err">'</span><span class="p">;</span>

    <span class="c1">//read the names in 3www6google3com format</span>
    <span class="k">while</span><span class="p">(</span><span class="o">*</span><span class="n">reader</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="o">*</span><span class="n">reader</span><span class="o">&gt;=</span><span class="mi">192</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">reader</span><span class="p">)</span><span class="o">*</span><span class="mi">256</span> <span class="o">+</span> <span class="o">*</span><span class="p">(</span><span class="n">reader</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">49152</span><span class="p">;</span> <span class="c1">//49152 = 11000000 00000000 ;)</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">buffer</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">jumped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">//we have jumped to another location so counting wont go up!</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">name</span><span class="p">[</span><span class="n">p</span><span class="o">++</span><span class="p">]</span><span class="o">=*</span><span class="n">reader</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">reader</span> <span class="o">=</span> <span class="n">reader</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>

        <span class="k">if</span><span class="p">(</span><span class="n">jumped</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="o">*</span><span class="n">count</span> <span class="o">=</span> <span class="o">*</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">//if we havent jumped to another location then we can count up</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">name</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">=</span><span class="err">'</span><span class="o">&lt;!</span><span class="n">JEKYLL</span><span class="err">@</span><span class="mi">5920</span><span class="err">@</span><span class="mi">7</span><span class="o">&gt;</span><span class="err">'</span><span class="p">;</span> <span class="c1">//string complete</span>
    <span class="k">if</span><span class="p">(</span><span class="n">jumped</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="o">*</span><span class="n">count</span> <span class="o">=</span> <span class="o">*</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">//number of steps we actually moved forward in the packet</span>
    <span class="p">}</span>

    <span class="c1">//now convert 3www6google3com0 to www.google.com</span>
    <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">strlen</span><span class="p">((</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">name</span><span class="p">);</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">p</span><span class="o">=</span><span class="n">name</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">p</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">name</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">name</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
            <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">name</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="sc">'.'</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">name</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="err">'</span><span class="o">&lt;!</span><span class="n">JEKYLL</span><span class="err">@</span><span class="mi">5920</span><span class="err">@</span><span class="mi">7</span><span class="o">&gt;</span><span class="err">'</span><span class="p">;</span> <span class="c1">//remove the last dot</span>
    <span class="k">return</span> <span class="n">name</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**
 * set name server
 * @param dnsServer
 * @return
 */</span>
<span class="kt">int</span> <span class="n">dns</span><span class="o">::</span><span class="n">setDnsServer</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span>  <span class="n">dnsServer</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">_dnsServer</span> <span class="o">=</span> <span class="n">dnsServer</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="n">dns</span><span class="o">::</span><span class="n">requestDnsServer</span><span class="p">(</span><span class="k">struct</span> <span class="nc">DNS_HEADER</span> <span class="o">*</span> <span class="n">dns</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">_dest</span><span class="p">);</span>
    <span class="n">dnsSock</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span> <span class="p">,</span> <span class="n">SOCK_DGRAM</span> <span class="p">,</span> <span class="n">IPPROTO_UDP</span><span class="p">);</span> <span class="c1">//UDP packet for DNS queries</span>
    <span class="n">_dest</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
    <span class="n">_dest</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">53</span><span class="p">);</span>
    <span class="n">_dest</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">inet_addr</span><span class="p">(</span><span class="n">_dnsServer</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span> <span class="c1">//dns servers</span>
    <span class="k">struct</span> <span class="nc">timeval</span> <span class="n">timeout</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">};</span>
    <span class="n">setsockopt</span><span class="p">(</span><span class="n">dnsSock</span><span class="p">,</span><span class="n">SOL_SOCKET</span><span class="p">,</span><span class="n">SO_RCVTIMEO</span><span class="p">,(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">timeout</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="nc">timeval</span><span class="p">));</span>
    <span class="k">if</span><span class="p">(</span><span class="n">sendto</span><span class="p">(</span><span class="n">dnsSock</span><span class="p">,(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_buff</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="nc">DNS_HEADER</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">strlen</span><span class="p">((</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_qname</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="nc">QUESTION</span><span class="p">),</span><span class="mi">0</span><span class="p">,(</span><span class="k">struct</span> <span class="nc">sockaddr</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">_dest</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">_dest</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">recvfrom</span> <span class="p">(</span><span class="n">dnsSock</span><span class="p">,(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_buff</span> <span class="p">,</span> <span class="mi">65536</span> <span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="nc">sockaddr</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">_dest</span> <span class="p">,</span> <span class="p">(</span><span class="n">socklen_t</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">i</span> <span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"recvfrom failed"</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span>


<span class="kt">void</span> <span class="n">dns</span><span class="o">::</span><span class="n">threadRequest</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span> <span class="n">DnsRequest</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">dns</span> <span class="o">*</span> <span class="n">Dns</span> <span class="o">=</span> <span class="p">(</span><span class="n">dns</span> <span class="o">*</span><span class="p">)</span><span class="n">DnsRequest</span><span class="p">;</span>
    <span class="c1">//Dns-&gt;mutex.lock();</span>
    <span class="k">static</span> <span class="kt">int</span> <span class="n">threadLock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span><span class="n">threadLock</span><span class="o">&lt;</span> <span class="n">Dns</span><span class="o">-&gt;</span><span class="n">_subdomain</span><span class="p">.</span><span class="n">size</span><span class="p">()){</span>
        <span class="n">Dns</span><span class="o">-&gt;</span><span class="n">_mutex</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span>
        <span class="k">struct</span> <span class="nc">DNS_HEADER</span> <span class="o">*</span> <span class="n">dns</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="k">struct</span> <span class="nc">QUESTION</span> <span class="o">*</span><span class="n">qinfo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="n">Dns</span><span class="o">-&gt;</span><span class="n">_currentHostname</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">Dns</span><span class="o">-&gt;</span><span class="n">_subdomain</span><span class="p">[</span><span class="n">threadLock</span><span class="p">]);</span>
        <span class="n">threadLock</span><span class="o">++</span><span class="p">;</span>
        <span class="kt">char</span> <span class="n">hostBuff</span><span class="p">[</span><span class="mi">200</span><span class="p">];</span>
        <span class="n">sprintf</span><span class="p">(</span><span class="n">hostBuff</span><span class="p">,</span><span class="s">"%s.%s"</span><span class="p">,</span><span class="n">Dns</span><span class="o">-&gt;</span><span class="n">_currentHostname</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="n">Dns</span><span class="o">-&gt;</span><span class="n">_hostname</span><span class="p">);</span>
        <span class="c1">//std::cout &lt;&lt; "Domain =&gt; "  &lt;&lt; hostBuff &lt;&lt; std::endl;</span>
        <span class="n">Dns</span><span class="o">-&gt;</span><span class="n">setDnsHeader</span><span class="p">(</span><span class="n">dns</span><span class="p">);</span>
        <span class="n">Dns</span><span class="o">-&gt;</span><span class="n">setQname</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hostBuff</span><span class="p">);</span>
        <span class="n">memset</span><span class="p">(</span><span class="n">hostBuff</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
        <span class="n">Dns</span><span class="o">-&gt;</span><span class="n">setQinfo</span><span class="p">(</span><span class="n">qinfo</span><span class="p">);</span>
        <span class="n">Dns</span><span class="o">-&gt;</span><span class="n">_currentHostname</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
        <span class="n">Dns</span><span class="o">-&gt;</span><span class="n">requestDnsServer</span><span class="p">(</span><span class="n">dns</span><span class="p">);</span>
        <span class="n">dns</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="nc">DNS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">Dns</span><span class="o">-&gt;</span><span class="n">_buff</span><span class="p">;</span>
        <span class="n">Dns</span><span class="o">-&gt;</span><span class="n">_reader</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Dns</span><span class="o">-&gt;</span><span class="n">_buff</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="nc">DNS_HEADER</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">strlen</span><span class="p">((</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">Dns</span><span class="o">-&gt;</span><span class="n">_qname</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="nc">QUESTION</span><span class="p">)];</span>
        <span class="kt">int</span> <span class="n">stop</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">ntohs</span><span class="p">(</span><span class="n">dns</span><span class="o">-&gt;</span><span class="n">ans_count</span><span class="p">);</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Dns</span><span class="o">-&gt;</span><span class="n">_answers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="o">=</span><span class="n">Dns</span><span class="o">-&gt;</span><span class="n">ReadName</span><span class="p">(</span><span class="n">Dns</span><span class="o">-&gt;</span><span class="n">_reader</span><span class="p">,</span><span class="n">Dns</span><span class="o">-&gt;</span><span class="n">_buff</span><span class="p">,</span><span class="o">&amp;</span><span class="n">stop</span><span class="p">);</span>
            <span class="n">Dns</span><span class="o">-&gt;</span><span class="n">_reader</span> <span class="o">=</span> <span class="n">Dns</span><span class="o">-&gt;</span><span class="n">_reader</span> <span class="o">+</span> <span class="n">stop</span><span class="p">;</span>
            <span class="n">Dns</span><span class="o">-&gt;</span><span class="n">_answers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">resource</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="nc">R_DATA</span><span class="o">*</span><span class="p">)(</span><span class="n">Dns</span><span class="o">-&gt;</span><span class="n">_reader</span><span class="p">);</span>
            <span class="n">Dns</span><span class="o">-&gt;</span><span class="n">_reader</span> <span class="o">=</span> <span class="n">Dns</span><span class="o">-&gt;</span><span class="n">_reader</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="nc">R_DATA</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">Dns</span><span class="o">-&gt;</span><span class="n">_answers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">resource</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">//if its an ipv4 address</span>
            <span class="p">{</span>
                <span class="n">Dns</span><span class="o">-&gt;</span><span class="n">_answers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdata</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">Dns</span><span class="o">-&gt;</span><span class="n">_answers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">resource</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">));</span>

                <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">j</span><span class="o">=</span><span class="mi">0</span> <span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">ntohs</span><span class="p">(</span><span class="n">Dns</span><span class="o">-&gt;</span><span class="n">_answers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">resource</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">)</span> <span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">Dns</span><span class="o">-&gt;</span><span class="n">_answers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdata</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">Dns</span><span class="o">-&gt;</span><span class="n">_reader</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
                <span class="p">}</span>

                <span class="n">Dns</span><span class="o">-&gt;</span><span class="n">_answers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdata</span><span class="p">[</span><span class="n">ntohs</span><span class="p">(</span><span class="n">Dns</span><span class="o">-&gt;</span><span class="n">_answers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">resource</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">)]</span> <span class="o">=</span> <span class="err">'</span><span class="o">&lt;!</span><span class="n">JEKYLL</span><span class="err">@</span><span class="mi">5920</span><span class="err">@</span><span class="mi">7</span><span class="o">&gt;</span><span class="err">'</span><span class="p">;</span>

                <span class="n">Dns</span><span class="o">-&gt;</span><span class="n">_reader</span> <span class="o">=</span> <span class="n">Dns</span><span class="o">-&gt;</span><span class="n">_reader</span> <span class="o">+</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">Dns</span><span class="o">-&gt;</span><span class="n">_answers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">resource</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="n">Dns</span><span class="o">-&gt;</span><span class="n">_answers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdata</span> <span class="o">=</span> <span class="n">Dns</span><span class="o">-&gt;</span><span class="n">ReadName</span><span class="p">(</span><span class="n">Dns</span><span class="o">-&gt;</span><span class="n">_reader</span><span class="p">,</span><span class="n">Dns</span><span class="o">-&gt;</span><span class="n">_buff</span><span class="p">,</span><span class="o">&amp;</span><span class="n">stop</span><span class="p">);</span>
                <span class="n">Dns</span><span class="o">-&gt;</span><span class="n">_reader</span> <span class="o">=</span> <span class="n">Dns</span><span class="o">-&gt;</span><span class="n">_reader</span> <span class="o">+</span> <span class="n">stop</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1">//printf("\nAnswer Records : %d \n" , ntohs(dns-&gt;ans_count) );</span>

        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">dns</span><span class="o">-&gt;</span><span class="n">ans_count</span><span class="p">)</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//printf("Name : %s ",answers[i].name);</span>

            <span class="k">if</span><span class="p">(</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">Dns</span><span class="o">-&gt;</span><span class="n">_answers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">resource</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">==</span> <span class="n">T_A</span><span class="p">)</span> <span class="c1">//IPv4 address</span>
            <span class="p">{</span>

                <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">ipAddress</span><span class="p">;</span>
                <span class="kt">long</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
                <span class="n">p</span><span class="o">=</span><span class="p">(</span><span class="kt">long</span><span class="o">*</span><span class="p">)</span><span class="n">Dns</span><span class="o">-&gt;</span><span class="n">_answers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdata</span><span class="p">;</span>
                <span class="n">Dns</span><span class="o">-&gt;</span><span class="n">_a</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="o">=</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">);</span> <span class="c1">//working without ntohl</span>
                <span class="c1">//printf(" %s has IPv4 address : %s",hostBuff,inet_ntoa(Dns-&gt;a.sin_addr));</span>
                <span class="n">ipAddress</span><span class="o">=</span><span class="n">inet_ntoa</span><span class="p">(</span><span class="n">Dns</span><span class="o">-&gt;</span><span class="n">_a</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">);</span>
                <span class="n">Dns</span><span class="o">-&gt;</span><span class="n">_aResult</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">ipAddress</span><span class="p">));</span>
            <span class="p">}</span>

            <span class="k">if</span><span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">Dns</span><span class="o">-&gt;</span><span class="n">_answers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">resource</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span><span class="o">==</span><span class="mi">5</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">//Canonical name for an alias</span>
                <span class="c1">//printf("has alias name : %s",Dns-&gt;answers[i].rdata);</span>
            <span class="p">}</span>

        <span class="p">}</span>
        <span class="n">close</span><span class="p">(</span><span class="n">Dns</span><span class="o">-&gt;</span><span class="n">dnsSock</span><span class="p">);</span>


        <span class="k">auto</span> <span class="n">it</span> <span class="o">=</span> <span class="n">Dns</span><span class="o">-&gt;</span><span class="n">_aResult</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
        <span class="k">for</span> <span class="p">(;</span> <span class="n">it</span> <span class="o">!=</span> <span class="n">Dns</span><span class="o">-&gt;</span><span class="n">_aResult</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="o">++</span><span class="n">it</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"[*]"</span> <span class="o">&lt;&lt;</span> <span class="n">hostBuff</span> <span class="o">&lt;&lt;</span> <span class="s">" =&gt; "</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="o">*</span><span class="n">it</span><span class="p">).</span><span class="n">second</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">dns</span><span class="o">-&gt;</span><span class="n">ans_count</span><span class="p">)</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
            <span class="k">if</span><span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">Dns</span><span class="o">-&gt;</span><span class="n">_answers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">resource</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">//if its an ipv4 address</span>
            <span class="p">{</span>
                <span class="n">free</span><span class="p">(</span><span class="n">Dns</span><span class="o">-&gt;</span><span class="n">_answers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdata</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">Dns</span><span class="o">-&gt;</span><span class="n">_aResult</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
        <span class="n">Dns</span><span class="o">-&gt;</span><span class="n">_mutex</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="n">dns</span><span class="o">::</span><span class="n">setHostname</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">hostname</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">strcpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">_hostname</span><span class="p">,</span><span class="n">hostname</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">dns</span><span class="o">::</span><span class="n">runThread</span><span class="p">(</span><span class="kt">int</span> <span class="n">threadNum</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// void * host = (void *)this;</span>
    <span class="n">Mythread</span> <span class="n">th</span><span class="p">;</span>
    <span class="n">th</span><span class="p">.</span><span class="n">setThreads</span><span class="p">(</span><span class="n">threadNum</span><span class="p">);</span>

    <span class="n">th</span><span class="p">.</span><span class="n">runThreads</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">threadRequest</span><span class="p">,(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="k">this</span><span class="p">);</span>

    <span class="n">th</span><span class="p">.</span><span class="n">setJoin</span><span class="p">();</span>
<span class="p">}</span>


<span class="kt">bool</span> <span class="n">dns</span><span class="o">::</span><span class="n">addSubdomain</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">subdomainName</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">_subdomain</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">subdomainName</span><span class="p">);</span>
<span class="p">}</span>



<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">dictPath</span><span class="p">(</span><span class="s">"dict.txt"</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">){</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Usage:"</span> <span class="o">&lt;&lt;</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">" &lt;domain name&gt; &lt;Threads&gt;"</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"This program is developed by the Qingxuan"</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Email: payloads@aliyun.com"</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"string "</span>  <span class="o">&lt;&lt;</span> <span class="n">argc</span><span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">4</span><span class="p">){</span>
        <span class="n">dictPath</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="n">dns</span>  <span class="n">Enum</span><span class="p">(</span><span class="s">"114.114.114.114"</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">hostname</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="n">Enum</span><span class="p">.</span><span class="n">setHostname</span><span class="p">(</span><span class="n">hostname</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">fstream</span> <span class="n">IO</span><span class="p">(</span><span class="n">dictPath</span><span class="p">);</span>
    <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">IO</span><span class="p">.</span><span class="n">eof</span><span class="p">()){</span>
        <span class="kt">char</span> <span class="n">lines</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
        <span class="n">IO</span><span class="p">.</span><span class="n">getline</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span><span class="mi">100</span><span class="p">);</span>
        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">lin</span><span class="p">(</span><span class="n">lines</span><span class="p">);</span>
        <span class="n">Enum</span><span class="p">.</span><span class="n">addSubdomain</span><span class="p">(</span><span class="n">lin</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">Enum</span><span class="p">.</span><span class="n">runThread</span><span class="p">(</span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]));</span>
<span class="p">}</span>

</code></pre></div></div>

<p>它可以直接通过<strong>g++</strong>编译，不需要任何第三方库。</p>

<h2 id="0x05-编译及使用">0x05 编译及使用</h2>

<ul>
  <li>
    <p>编译命令：<code class="language-plaintext highlighter-rouge">g++ main.cpp -lpthread -o dns_enum</code></p>
  </li>
  <li>
    <p>使用方式：<code class="language-plaintext highlighter-rouge">./dns_enum &lt;domain name&gt; &lt;Threads&gt;</code></p>
  </li>
  <li>
    <p>使用效果：</p>
  </li>
</ul>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2018-03-05/0x01.png" alt="0x01"></p>

<p><strong>注意：必须在当前程序目录下新建一个字典，名为：<code class="language-plaintext highlighter-rouge">dict.txt</code></strong></p>

<h3 id="使用其他字典">使用其他字典</h3>

<ul>
  <li>使用命令：<code class="language-plaintext highlighter-rouge">./dns_enum payloads.online 10 /usr/dict/Subdomain.txt</code>
</li>
</ul>

<h2 id="0x06-最后">0x06 最后</h2>

<p>这只是我一个大项目中的一部分，近期发现了不少网络扫描的lib，以后的以后再慢慢学习。</p>

<p>DNS枚举这块可以再进行优化，目前只是支持多线程，网络层那块并没有做优化，原生态的数据包发送，真是锻炼人！</p>


  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="//avatars0.githubusercontent.com/u/19944759?s=150&v=4" alt="倾旋">
  <div class="col-box-title name">倾旋</div>
  <p>特点：爪子长、个子高、身体瘦弱
</p>
  <p class="contact">
    
    <a href="https://github.com/Rvn0xsy">GitHub</a>
    
    
    <a href="https://twitter.com/Rvn0xsy">Twitter</a>
    
    
    <a href="mailto:rvn0xsy@gmail.com">Email</a>
    
    <a href="#">微信</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">Newest Posts</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/archivers/2021-02-18/1">Pricking 项目（一） ：使用介绍</a></li>
    
      <li><a class="post-link" href="/archivers/2021-02-18/2">Pricking 项目（二） ：JS模块开发</a></li>
    
      <li><a class="post-link" href="/archivers/2021-02-16/1">红队技巧：基于反向代理的水坑攻击</a></li>
    
      <li><a class="post-link" href="/archivers/2021-02-09/1">CVE-2021-3156 - Exploit修改</a></li>
    
      <li><a class="post-link" href="/archivers/2021-02-08/1">静态恶意代码逃逸（第十课）</a></li>
    
      <li><a class="post-link" href="/archivers/2021-01-31/1">Windows权限控制相关的防御与攻击技术</a></li>
    
      <li><a class="post-link" href="/archivers/2020-11-29/2">静态恶意代码逃逸（第九课）</a></li>
    
      <li><a class="post-link" href="/archivers/2020-11-29/1">静态恶意代码逃逸（第八课）</a></li>
    
      <li><a class="post-link" href="/archivers/2020-11-13/1">Linux透明代理在红队渗透中的应用</a></li>
    
      <li><a class="post-link" href="/archivers/2020-11-01/1">Web正向代理的思考</a></li>
    
      <li><a class="post-link" href="/archivers/2020-10-23/1">静态恶意代码逃逸（第七课）</a></li>
    
      <li><a class="post-link" href="/archivers/2020-08-24/1">这是一个充满挑战的好时代</a></li>
    
      <li><a class="post-link" href="/archivers/2020-07-16/1">通过OXID解析器获取Windows远程主机上网卡地址</a></li>
    
      <li><a class="post-link" href="/archivers/2020-06-28/1">如何实现一个Atexec</a></li>
    
      <li><a class="post-link" href="/archivers/2020-04-02/1">如何实现一个Psexec</a></li>
    
    <li><a class="post-link" href="/posts/">更多....</a></li>
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">TOC</div>
</div>

        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
© 2021 倾旋
</div>
</footer>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-158746438-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-158746438-1');
</script>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>


  </body>

</html>
