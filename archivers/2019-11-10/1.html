<!DOCTYPE html>
<html>

  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>静态恶意代码逃逸（第一课） « 倾旋的博客</title>
  <meta name="description" content="0x00 前言前五课的代码将会上传至Github，方便读者下载研究 : https://github.com/Rvn0xsy/BadCode在此之前，我分享过《高级后渗透C2免杀与对抗》，其中对于一些原理铺垫上稍有欠缺，因此准备分成几篇文章来展开。0X01 恶意代码的定义以下文章中的所有关于恶意代码的定义都以Co...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://payloads.online/archivers/2019-11-10/1">
  <link rel="alternate" type="application/rss+xml" title="倾旋的博客" href="https://payloads.online/feed.xml">
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">倾旋的博客</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/">About</a>
      
        
        <a class="page-link" href="/posts/">Posts</a>
      
        
        <a class="page-link" href="/links/">Links</a>
      
        
        <a class="page-link" href="https://cooolis.payloads.online/">Cooolis</a>
      
        
        <a class="page-link" href="/feed.xml">RSS</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">静态恶意代码逃逸（第一课）</h1>
    <p class="post-meta">Nov 10, 2019</p>
  </header>

  <article class="post-content">
    <h2 id="0x00-前言">0x00 前言</h2>

<p>前五课的代码将会上传至Github，方便读者下载研究 : https://github.com/Rvn0xsy/BadCode</p>

<p>在此之前，我分享过《高级后渗透C2免杀与对抗》，其中对于一些原理铺垫上稍有欠缺，因此准备分成几篇文章来展开。</p>

<h2 id="0x01-恶意代码的定义">0X01 恶意代码的定义</h2>

<p>以下文章中的所有关于恶意代码的定义都以Cobaltstrike的载荷为例。</p>

<h2 id="0x02-shellcode定义">0x02 Shellcode定义</h2>

<p>Shellcode是一段机器指令的集合，通常会被压缩至很小的长度，达到为后续恶意代码铺垫的作用。当然你可以通过msfvenom生成各种用于测试的shellcode。</p>

<h2 id="0x03-raw文件">0x03 RAW文件</h2>
<p>RAW 中文意思是原始的、未经加工的，通常使用Cobaltstrike生成的BIN文件。</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/c92e631bce3ba5a65abf23ba121a2dbd.png" alt="2019-11-10-01-55-50"></p>

<p>RAW文件是可以直接进行字节操作读取的，因此加载到内存较为方便，通常我一般使用混淆的方式再生成一遍。</p>

<h2 id="0x04-c文件">0x04 C文件</h2>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/0e4a46bbd3c992df26cccad1a51b4c28.png" alt="2019-11-10-01-56-09"></p>

<p>C文件给出的是一个C语言中的字符数组，也是可以通过以字节单位操作的。</p>

<h2 id="0x05-组合">0x05 组合</h2>

<p>由于反病毒软件对于默认生成的文件查杀较为严格，我通常会采用混淆、加密解密的方式把载荷还原。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">ArgumentParser</span><span class="p">,</span> <span class="n">FileType</span>

<span class="k">def</span> <span class="nf">process_bin</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">src_fp</span><span class="p">,</span> <span class="n">dst_fp</span><span class="p">,</span> <span class="n">dst_raw</span><span class="p">):</span>
    <span class="n">shellcode</span> <span class="o">=</span> <span class="s">''</span>
    <span class="n">shellcode_size</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">shellcode_raw</span> <span class="o">=</span> <span class="sa">b</span><span class="s">''</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">src_fp</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">code</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">base10</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="o">^</span> <span class="n">num</span>
            <span class="n">base10_str</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">base10</span><span class="p">)</span>
            <span class="n">shellcode_raw</span> <span class="o">+=</span> <span class="n">base10_str</span><span class="p">.</span><span class="n">encode</span><span class="p">()</span>
            <span class="n">code_hex</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="n">base10</span><span class="p">)</span>
            <span class="n">code_hex</span> <span class="o">=</span> <span class="n">code_hex</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">'0x'</span><span class="p">,</span><span class="s">''</span><span class="p">)</span>
            <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">code_hex</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">code_hex</span> <span class="o">=</span> <span class="s">'0'</span> <span class="o">+</span> <span class="n">code_hex</span>
            <span class="n">shellcode</span> <span class="o">+=</span> <span class="s">'\x'</span> <span class="o">+</span> <span class="n">code_hex</span>
            <span class="n">shellcode_size</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">src_fp</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">dst_raw</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">shellcode_raw</span><span class="p">)</span>
        <span class="n">dst_raw</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">dst_fp</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span>
        <span class="n">dst_fp</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">shellcode_size</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">.</span><span class="n">writelines</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">ArgumentParser</span><span class="p">(</span><span class="n">prog</span><span class="o">=</span><span class="s">'Shellcode X'</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s">'[XOR The Cobaltstrike PAYLOAD.BINs] </span><span class="se">\t</span><span class="s"> &gt; Author: rvn0xsy@gmail.com'</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'-v'</span><span class="p">,</span><span class="s">'--version'</span><span class="p">,</span><span class="n">nargs</span><span class="o">=</span><span class="s">'?'</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'-s'</span><span class="p">,</span><span class="s">'--src'</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="sa">u</span><span class="s">'source bin file'</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="n">FileType</span><span class="p">(</span><span class="s">'rb'</span><span class="p">),</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'-d'</span><span class="p">,</span><span class="s">'--dst'</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="sa">u</span><span class="s">'destination shellcode file'</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="n">FileType</span><span class="p">(</span><span class="s">'w+'</span><span class="p">),</span><span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'-n'</span><span class="p">,</span><span class="s">'--num'</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="sa">u</span><span class="s">'Confused number'</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'-r'</span><span class="p">,</span><span class="s">'--raw'</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="sa">u</span><span class="s">'output bin file'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">FileType</span><span class="p">(</span><span class="s">'wb'</span><span class="p">),</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="n">shellcode_size</span> <span class="o">=</span> <span class="n">process_bin</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">num</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">src</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">dst</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">raw</span><span class="p">)</span>
    <span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="n">writelines</span><span class="p">(</span><span class="s">"[+]Shellcode Size : {} </span><span class="se">\n</span><span class="s">"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">shellcode_size</span><span class="p">))</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div></div>

<p>上面这个脚本是我在去年写的，用于把raw文件混淆，生成c语言数组，在后面的文章中，我们也以c/c++语言为主，探究其本质。</p>

<h3 id="混淆方案">混淆方案</h3>

<p>先生成bin文件，然后运行python脚本：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python3 .\xor_shellcoder.py -s .\payload.bin  -d payload.c -n 10
</code></pre></div></div>

<p>在payload.c中会看到raw文件里的每一个字节与10的异或运算出的C语言数组。</p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/8f85073149fe77ff6bc0040a50f2e3d4.png" alt="2019-11-10-01-57-13"></p>

<p>这个数组的内容，将由下一篇文章用到，实践一下Shellcode混淆免杀。</p>

  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="//avatars0.githubusercontent.com/u/19944759?s=150&v=4" alt="倾旋">
  <div class="col-box-title name">倾旋</div>
  <p>特点：爪子长、个子高、身体瘦弱
</p>
  <p class="contact">
    
    <a href="https://github.com/Rvn0xsy">GitHub</a>
    
    
    <a href="https://twitter.com/Rvn0xsy">Twitter</a>
    
    
    <a href="mailto:rvn0xsy@gmail.com">Email</a>
    
    <a href="#">微信</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">Newest Posts</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/archivers/2021-02-18/1">Pricking 项目（一） ：使用介绍</a></li>
    
      <li><a class="post-link" href="/archivers/2021-02-18/2">Pricking 项目（二） ：JS模块开发</a></li>
    
      <li><a class="post-link" href="/archivers/2021-02-16/1">红队技巧：基于反向代理的水坑攻击</a></li>
    
      <li><a class="post-link" href="/archivers/2021-02-09/1">CVE-2021-3156 - Exploit修改</a></li>
    
      <li><a class="post-link" href="/archivers/2021-02-08/1">静态恶意代码逃逸（第十课）</a></li>
    
      <li><a class="post-link" href="/archivers/2021-01-31/1">Windows权限控制相关的防御与攻击技术</a></li>
    
      <li><a class="post-link" href="/archivers/2020-11-29/2">静态恶意代码逃逸（第九课）</a></li>
    
      <li><a class="post-link" href="/archivers/2020-11-29/1">静态恶意代码逃逸（第八课）</a></li>
    
      <li><a class="post-link" href="/archivers/2020-11-13/1">Linux透明代理在红队渗透中的应用</a></li>
    
      <li><a class="post-link" href="/archivers/2020-11-01/1">Web正向代理的思考</a></li>
    
      <li><a class="post-link" href="/archivers/2020-10-23/1">静态恶意代码逃逸（第七课）</a></li>
    
      <li><a class="post-link" href="/archivers/2020-08-24/1">这是一个充满挑战的好时代</a></li>
    
      <li><a class="post-link" href="/archivers/2020-07-16/1">通过OXID解析器获取Windows远程主机上网卡地址</a></li>
    
      <li><a class="post-link" href="/archivers/2020-06-28/1">如何实现一个Atexec</a></li>
    
      <li><a class="post-link" href="/archivers/2020-04-02/1">如何实现一个Psexec</a></li>
    
    <li><a class="post-link" href="/posts/">更多....</a></li>
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">TOC</div>
</div>

        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
© 2021 倾旋
</div>
</footer>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-158746438-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-158746438-1');
</script>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>


  </body>

</html>
